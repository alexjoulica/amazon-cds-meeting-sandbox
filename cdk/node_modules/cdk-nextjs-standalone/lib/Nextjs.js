"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.Nextjs = exports.CONFIG_ENV_JSON_PATH = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const os = require("os");
const path = require("path");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const s3 = require("aws-cdk-lib/aws-s3");
const constructs_1 = require("constructs");
const fs = require("fs-extra");
const ImageOptimizationLambda_1 = require("./ImageOptimizationLambda");
const NextjsAssetsDeployment_1 = require("./NextjsAssetsDeployment");
const NextjsBuild_1 = require("./NextjsBuild");
const NextjsDistribution_1 = require("./NextjsDistribution");
const NextjsLambda_1 = require("./NextjsLambda");
const NextjsLayer_1 = require("./NextjsLayer");
// contains server-side resolved environment vars in config bucket
exports.CONFIG_ENV_JSON_PATH = 'next-env.json';
/**
 * The `Nextjs` construct is a higher level construct that makes it easy to create a NextJS app.
 *
 * Your standalone server application will be bundled using o(utput tracing and will be deployed to a Lambda function.
 * Static assets will be deployed to an S3 bucket and served via CloudFront.
 * You must use Next.js 10.3.0 or newer.
 *
 * Please provide a `nextjsPath` to the Next.js app inside your project.
 *
 * @example
 * new Nextjs(this, "Web", {
 *   nextjsPath: path.resolve("packages/web"),
 * })
 */
class Nextjs extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        if (!props.quiet)
            console.debug('┌ Building Next.js app ▼ ...');
        // get dir to store temp build files in
        const tempBuildDir = props.tempBuildDir
            ? path.resolve(path.join(props.tempBuildDir, `nextjs-cdk-build-${this.node.id}-${this.node.addr.substring(0, 4)}`))
            : fs.mkdtempSync(path.join(os.tmpdir(), 'nextjs-cdk-build-'));
        this.tempBuildDir = tempBuildDir;
        // create static asset bucket
        this.staticAssetBucket =
            props.defaults?.assetDeployment?.bucket ??
                new s3.Bucket(this, 'Bucket', {
                    removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY,
                    autoDeleteObjects: true,
                });
        // layer
        const nextLayer = new NextjsLayer_1.NextjsLayer(scope, 'NextjsLayer', {});
        // build nextjs app
        this.nextBuild = new NextjsBuild_1.NextjsBuild(this, id, { ...props, tempBuildDir });
        this.serverFunction = new NextjsLambda_1.NextJsLambda(this, 'Fn', {
            ...props,
            tempBuildDir,
            nextBuild: this.nextBuild,
            lambda: props.defaults?.lambda,
        });
        // build image optimization
        this.imageOptimizationFunction = new ImageOptimizationLambda_1.ImageOptimizationLambda(this, 'ImgOptFn', {
            ...props,
            nextLayer,
            nextBuild: this.nextBuild,
            bucket: props.imageOptimizationBucket || this.bucket,
            lambdaOptions: props.defaults?.lambda,
        });
        // deploy nextjs static assets to s3
        this.assetsDeployment = new NextjsAssetsDeployment_1.NextJsAssetsDeployment(this, 'AssetDeployment', {
            ...props,
            ...props.defaults?.assetDeployment,
            tempBuildDir,
            nextBuild: this.nextBuild,
            bucket: this.staticAssetBucket,
        });
        // finish static deployment BEFORE deploying new function code
        // as there is some time after the new static files are uploaded but before they are rewritten
        this.assetsDeployment.node.addDependency(this.serverFunction);
        this.distribution = new NextjsDistribution_1.NextjsDistribution(this, 'Distribution', {
            ...props,
            ...props.defaults?.distribution,
            staticAssetsBucket: this.assetsDeployment.bucket,
            tempBuildDir,
            nextBuild: this.nextBuild,
            serverFunction: this.serverFunction.lambdaFunction,
            imageOptFunction: this.imageOptimizationFunction,
        });
        if (!props.quiet)
            console.debug('└ Finished preparing NextJS app for deployment');
    }
    get url() {
        return this.distribution.url;
    }
    get bucket() {
        return this.staticAssetBucket;
    }
}
exports.Nextjs = Nextjs;
_a = JSII_RTTI_SYMBOL_1;
Nextjs[_a] = { fqn: "cdk-nextjs-standalone.Nextjs", version: "2.0.3" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTmV4dGpzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL05leHRqcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLHlCQUF5QjtBQUN6Qiw2QkFBNkI7QUFDN0IsNkNBQTRDO0FBRzVDLHlDQUF5QztBQUN6QywyQ0FBdUM7QUFDdkMsK0JBQStCO0FBQy9CLHVFQUFvRTtBQUNwRSxxRUFBK0Y7QUFFL0YsK0NBQTRDO0FBQzVDLDZEQUFtRjtBQUNuRixpREFBOEM7QUFDOUMsK0NBQTRDO0FBRTVDLGtFQUFrRTtBQUNyRCxRQUFBLG9CQUFvQixHQUFHLGVBQWUsQ0FBQztBQXVDcEQ7Ozs7Ozs7Ozs7Ozs7R0FhRztBQUNILE1BQWEsTUFBTyxTQUFRLHNCQUFTO0lBcUNuQyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQWtCO1FBQzFELEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLO1lBQUUsT0FBTyxDQUFDLEtBQUssQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO1FBRWhFLHVDQUF1QztRQUN2QyxNQUFNLFlBQVksR0FBRyxLQUFLLENBQUMsWUFBWTtZQUNyQyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FDVixJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQUUsb0JBQW9CLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUNwRztZQUNILENBQUMsQ0FBQyxFQUFFLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFLG1CQUFtQixDQUFDLENBQUMsQ0FBQztRQUVoRSxJQUFJLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQztRQUVqQyw2QkFBNkI7UUFDN0IsSUFBSSxDQUFDLGlCQUFpQjtZQUNwQixLQUFLLENBQUMsUUFBUSxFQUFFLGVBQWUsRUFBRSxNQUFNO2dCQUN2QyxJQUFJLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRTtvQkFDNUIsYUFBYSxFQUFFLDJCQUFhLENBQUMsT0FBTztvQkFDcEMsaUJBQWlCLEVBQUUsSUFBSTtpQkFDeEIsQ0FBQyxDQUFDO1FBRUwsUUFBUTtRQUNSLE1BQU0sU0FBUyxHQUFHLElBQUkseUJBQVcsQ0FBQyxLQUFLLEVBQUUsYUFBYSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRTVELG1CQUFtQjtRQUNuQixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUkseUJBQVcsQ0FBQyxJQUFJLEVBQUUsRUFBRSxFQUFFLEVBQUUsR0FBRyxLQUFLLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQztRQUN2RSxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksMkJBQVksQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFO1lBQ2pELEdBQUcsS0FBSztZQUNSLFlBQVk7WUFDWixTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7WUFDekIsTUFBTSxFQUFFLEtBQUssQ0FBQyxRQUFRLEVBQUUsTUFBTTtTQUMvQixDQUFDLENBQUM7UUFDSCwyQkFBMkI7UUFDM0IsSUFBSSxDQUFDLHlCQUF5QixHQUFHLElBQUksaURBQXVCLENBQUMsSUFBSSxFQUFFLFVBQVUsRUFBRTtZQUM3RSxHQUFHLEtBQUs7WUFDUixTQUFTO1lBQ1QsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO1lBQ3pCLE1BQU0sRUFBRSxLQUFLLENBQUMsdUJBQXVCLElBQUksSUFBSSxDQUFDLE1BQU07WUFDcEQsYUFBYSxFQUFFLEtBQUssQ0FBQyxRQUFRLEVBQUUsTUFBTTtTQUN0QyxDQUFDLENBQUM7UUFDSCxvQ0FBb0M7UUFDcEMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksK0NBQXNCLENBQUMsSUFBSSxFQUFFLGlCQUFpQixFQUFFO1lBQzFFLEdBQUcsS0FBSztZQUNSLEdBQUcsS0FBSyxDQUFDLFFBQVEsRUFBRSxlQUFlO1lBQ2xDLFlBQVk7WUFDWixTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7WUFDekIsTUFBTSxFQUFFLElBQUksQ0FBQyxpQkFBaUI7U0FDL0IsQ0FBQyxDQUFDO1FBQ0gsOERBQThEO1FBQzlELDhGQUE4RjtRQUM5RixJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7UUFFOUQsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLHVDQUFrQixDQUFDLElBQUksRUFBRSxjQUFjLEVBQUU7WUFDL0QsR0FBRyxLQUFLO1lBQ1IsR0FBRyxLQUFLLENBQUMsUUFBUSxFQUFFLFlBQVk7WUFDL0Isa0JBQWtCLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU07WUFDaEQsWUFBWTtZQUNaLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztZQUN6QixjQUFjLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxjQUFjO1lBQ2xELGdCQUFnQixFQUFFLElBQUksQ0FBQyx5QkFBeUI7U0FDakQsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLO1lBQUUsT0FBTyxDQUFDLEtBQUssQ0FBQyxnREFBZ0QsQ0FBQyxDQUFDO0lBQ3BGLENBQUM7SUFFRCxJQUFXLEdBQUc7UUFDWixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDO0lBQy9CLENBQUM7SUFFRCxJQUFXLE1BQU07UUFDZixPQUFPLElBQUksQ0FBQyxpQkFBaUIsQ0FBQztJQUNoQyxDQUFDOztBQTdHSCx3QkE4R0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBvcyBmcm9tICdvcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgUmVtb3ZhbFBvbGljeSB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhJztcbmltcG9ydCB7IEZ1bmN0aW9uT3B0aW9ucyB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEnO1xuaW1wb3J0ICogYXMgczMgZnJvbSAnYXdzLWNkay1saWIvYXdzLXMzJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHsgSW1hZ2VPcHRpbWl6YXRpb25MYW1iZGEgfSBmcm9tICcuL0ltYWdlT3B0aW1pemF0aW9uTGFtYmRhJztcbmltcG9ydCB7IE5leHRKc0Fzc2V0c0RlcGxveW1lbnQsIE5leHRqc0Fzc2V0c0RlcGxveW1lbnRQcm9wcyB9IGZyb20gJy4vTmV4dGpzQXNzZXRzRGVwbG95bWVudCc7XG5pbXBvcnQgeyBCYXNlU2l0ZURvbWFpblByb3BzLCBOZXh0anNCYXNlUHJvcHMgfSBmcm9tICcuL05leHRqc0Jhc2UnO1xuaW1wb3J0IHsgTmV4dGpzQnVpbGQgfSBmcm9tICcuL05leHRqc0J1aWxkJztcbmltcG9ydCB7IE5leHRqc0Rpc3RyaWJ1dGlvbiwgTmV4dGpzRGlzdHJpYnV0aW9uUHJvcHMgfSBmcm9tICcuL05leHRqc0Rpc3RyaWJ1dGlvbic7XG5pbXBvcnQgeyBOZXh0SnNMYW1iZGEgfSBmcm9tICcuL05leHRqc0xhbWJkYSc7XG5pbXBvcnQgeyBOZXh0anNMYXllciB9IGZyb20gJy4vTmV4dGpzTGF5ZXInO1xuXG4vLyBjb250YWlucyBzZXJ2ZXItc2lkZSByZXNvbHZlZCBlbnZpcm9ubWVudCB2YXJzIGluIGNvbmZpZyBidWNrZXRcbmV4cG9ydCBjb25zdCBDT05GSUdfRU5WX0pTT05fUEFUSCA9ICduZXh0LWVudi5qc29uJztcblxuZXhwb3J0IGludGVyZmFjZSBOZXh0anNEb21haW5Qcm9wcyBleHRlbmRzIEJhc2VTaXRlRG9tYWluUHJvcHMge31cblxuLyoqXG4gKiBEZWZhdWx0cyBmb3IgY3JlYXRlZCByZXNvdXJjZXMuXG4gKiBXaHkgYGFueWA/IHNlZSBodHRwczovL2dpdGh1Yi5jb20vYXdzL2pzaWkvaXNzdWVzLzI5MDFcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBOZXh0anNEZWZhdWx0c1Byb3BzIHtcbiAgLyoqXG4gICAqIE92ZXJyaWRlIHN0YXRpYyBmaWxlIGRlcGxveW1lbnQgc2V0dGluZ3MuXG4gICAqL1xuICByZWFkb25seSBhc3NldERlcGxveW1lbnQ/OiBOZXh0anNBc3NldHNEZXBsb3ltZW50UHJvcHMgfCBhbnk7XG5cbiAgLyoqXG4gICAqIE92ZXJyaWRlIHNlcnZlciBsYW1iZGEgZnVuY3Rpb24gc2V0dGluZ3MuXG4gICAqL1xuICByZWFkb25seSBsYW1iZGE/OiBGdW5jdGlvbk9wdGlvbnM7XG5cbiAgLyoqXG4gICAqIE92ZXJyaWRlIENsb3VkRnJvbnQgZGlzdHJpYnV0aW9uIHNldHRpbmdzLlxuICAgKlxuICAgKiBUaGVzZSBwcm9wZXJ0aWVzIHNob3VsZCBhbGwgYmUgb3B0aW9uYWwgYnV0IGNhbm5vdCBiZSBkdWUgdG8gYSBsaW1pdGF0aW9uIGluIGpzaWkuXG4gICAqL1xuICByZWFkb25seSBkaXN0cmlidXRpb24/OiBOZXh0anNEaXN0cmlidXRpb25Qcm9wcyB8IGFueTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBOZXh0anNQcm9wcyBleHRlbmRzIE5leHRqc0Jhc2VQcm9wcyB7XG4gIC8qKlxuICAgKiBPcHRpb25hbCBTMyBCdWNrZXQgdG8gdXNlLCBkZWZhdWx0cyB0byBhc3NldHMgYnVja2V0XG4gICAqL1xuICByZWFkb25seSBpbWFnZU9wdGltaXphdGlvbkJ1Y2tldD86IHMzLklCdWNrZXQ7XG4gIC8qKlxuICAgKiBBbGxvd3MgeW91IHRvIG92ZXJyaWRlIGRlZmF1bHRzIGZvciB0aGUgcmVzb3VyY2VzIGNyZWF0ZWQgYnkgdGhpc1xuICAgKiBjb25zdHJ1Y3QuXG4gICAqL1xuICByZWFkb25seSBkZWZhdWx0cz86IE5leHRqc0RlZmF1bHRzUHJvcHM7XG59XG5cbi8qKlxuICogVGhlIGBOZXh0anNgIGNvbnN0cnVjdCBpcyBhIGhpZ2hlciBsZXZlbCBjb25zdHJ1Y3QgdGhhdCBtYWtlcyBpdCBlYXN5IHRvIGNyZWF0ZSBhIE5leHRKUyBhcHAuXG4gKlxuICogWW91ciBzdGFuZGFsb25lIHNlcnZlciBhcHBsaWNhdGlvbiB3aWxsIGJlIGJ1bmRsZWQgdXNpbmcgbyh1dHB1dCB0cmFjaW5nIGFuZCB3aWxsIGJlIGRlcGxveWVkIHRvIGEgTGFtYmRhIGZ1bmN0aW9uLlxuICogU3RhdGljIGFzc2V0cyB3aWxsIGJlIGRlcGxveWVkIHRvIGFuIFMzIGJ1Y2tldCBhbmQgc2VydmVkIHZpYSBDbG91ZEZyb250LlxuICogWW91IG11c3QgdXNlIE5leHQuanMgMTAuMy4wIG9yIG5ld2VyLlxuICpcbiAqIFBsZWFzZSBwcm92aWRlIGEgYG5leHRqc1BhdGhgIHRvIHRoZSBOZXh0LmpzIGFwcCBpbnNpZGUgeW91ciBwcm9qZWN0LlxuICpcbiAqIEBleGFtcGxlXG4gKiBuZXcgTmV4dGpzKHRoaXMsIFwiV2ViXCIsIHtcbiAqICAgbmV4dGpzUGF0aDogcGF0aC5yZXNvbHZlKFwicGFja2FnZXMvd2ViXCIpLFxuICogfSlcbiAqL1xuZXhwb3J0IGNsYXNzIE5leHRqcyBleHRlbmRzIENvbnN0cnVjdCB7XG4gIC8qKlxuICAgKiBUaGUgbWFpbiBOZXh0SlMgc2VydmVyIGhhbmRsZXIgbGFtYmRhIGZ1bmN0aW9uLlxuICAgKi9cbiAgcHVibGljIHNlcnZlckZ1bmN0aW9uOiBOZXh0SnNMYW1iZGE7XG5cbiAgLyoqXG4gICAqIFRoZSBpbWFnZSBvcHRpbWl6YXRpb24gaGFuZGxlciBsYW1iZGEgZnVuY3Rpb24uXG4gICAqL1xuICBwdWJsaWMgaW1hZ2VPcHRpbWl6YXRpb25GdW5jdGlvbjogSW1hZ2VPcHRpbWl6YXRpb25MYW1iZGE7XG5cbiAgLyoqXG4gICAqIEJ1aWx0IE5leHRKUyBwcm9qZWN0IG91dHB1dC5cbiAgICovXG4gIHB1YmxpYyBuZXh0QnVpbGQ6IE5leHRqc0J1aWxkO1xuXG4gIC8qKlxuICAgKiBBc3NldCBkZXBsb3ltZW50IHRvIFMzLlxuICAgKi9cbiAgcHVibGljIGFzc2V0c0RlcGxveW1lbnQ6IE5leHRKc0Fzc2V0c0RlcGxveW1lbnQ7XG5cbiAgLyoqXG4gICAqIENsb3VkRnJvbnQgZGlzdHJpYnV0aW9uLlxuICAgKi9cbiAgcHVibGljIGRpc3RyaWJ1dGlvbjogTmV4dGpzRGlzdHJpYnV0aW9uO1xuXG4gIC8qKlxuICAgKiBXaGVyZSBidWlsZC10aW1lIGFzc2V0cyBmb3IgZGVwbG95bWVudCBhcmUgc3RvcmVkLlxuICAgKi9cbiAgcHVibGljIHRlbXBCdWlsZERpcjogc3RyaW5nO1xuXG4gIHB1YmxpYyBjb25maWdCdWNrZXQ/OiBzMy5CdWNrZXQ7XG4gIHB1YmxpYyBsYW1iZGFGdW5jdGlvblVybCE6IGxhbWJkYS5GdW5jdGlvblVybDtcbiAgcHVibGljIGltYWdlT3B0aW1pemF0aW9uTGFtYmRhRnVuY3Rpb25VcmwhOiBsYW1iZGEuRnVuY3Rpb25Vcmw7XG5cbiAgcHJvdGVjdGVkIHN0YXRpY0Fzc2V0QnVja2V0OiBzMy5JQnVja2V0O1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBOZXh0anNQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICBpZiAoIXByb3BzLnF1aWV0KSBjb25zb2xlLmRlYnVnKCfilIwgQnVpbGRpbmcgTmV4dC5qcyBhcHAg4pa8IC4uLicpO1xuXG4gICAgLy8gZ2V0IGRpciB0byBzdG9yZSB0ZW1wIGJ1aWxkIGZpbGVzIGluXG4gICAgY29uc3QgdGVtcEJ1aWxkRGlyID0gcHJvcHMudGVtcEJ1aWxkRGlyXG4gICAgICA/IHBhdGgucmVzb2x2ZShcbiAgICAgICAgICBwYXRoLmpvaW4ocHJvcHMudGVtcEJ1aWxkRGlyLCBgbmV4dGpzLWNkay1idWlsZC0ke3RoaXMubm9kZS5pZH0tJHt0aGlzLm5vZGUuYWRkci5zdWJzdHJpbmcoMCwgNCl9YClcbiAgICAgICAgKVxuICAgICAgOiBmcy5ta2R0ZW1wU3luYyhwYXRoLmpvaW4ob3MudG1wZGlyKCksICduZXh0anMtY2RrLWJ1aWxkLScpKTtcblxuICAgIHRoaXMudGVtcEJ1aWxkRGlyID0gdGVtcEJ1aWxkRGlyO1xuXG4gICAgLy8gY3JlYXRlIHN0YXRpYyBhc3NldCBidWNrZXRcbiAgICB0aGlzLnN0YXRpY0Fzc2V0QnVja2V0ID1cbiAgICAgIHByb3BzLmRlZmF1bHRzPy5hc3NldERlcGxveW1lbnQ/LmJ1Y2tldCA/P1xuICAgICAgbmV3IHMzLkJ1Y2tldCh0aGlzLCAnQnVja2V0Jywge1xuICAgICAgICByZW1vdmFsUG9saWN5OiBSZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgICAgIGF1dG9EZWxldGVPYmplY3RzOiB0cnVlLFxuICAgICAgfSk7XG5cbiAgICAvLyBsYXllclxuICAgIGNvbnN0IG5leHRMYXllciA9IG5ldyBOZXh0anNMYXllcihzY29wZSwgJ05leHRqc0xheWVyJywge30pO1xuXG4gICAgLy8gYnVpbGQgbmV4dGpzIGFwcFxuICAgIHRoaXMubmV4dEJ1aWxkID0gbmV3IE5leHRqc0J1aWxkKHRoaXMsIGlkLCB7IC4uLnByb3BzLCB0ZW1wQnVpbGREaXIgfSk7XG4gICAgdGhpcy5zZXJ2ZXJGdW5jdGlvbiA9IG5ldyBOZXh0SnNMYW1iZGEodGhpcywgJ0ZuJywge1xuICAgICAgLi4ucHJvcHMsXG4gICAgICB0ZW1wQnVpbGREaXIsXG4gICAgICBuZXh0QnVpbGQ6IHRoaXMubmV4dEJ1aWxkLFxuICAgICAgbGFtYmRhOiBwcm9wcy5kZWZhdWx0cz8ubGFtYmRhLFxuICAgIH0pO1xuICAgIC8vIGJ1aWxkIGltYWdlIG9wdGltaXphdGlvblxuICAgIHRoaXMuaW1hZ2VPcHRpbWl6YXRpb25GdW5jdGlvbiA9IG5ldyBJbWFnZU9wdGltaXphdGlvbkxhbWJkYSh0aGlzLCAnSW1nT3B0Rm4nLCB7XG4gICAgICAuLi5wcm9wcyxcbiAgICAgIG5leHRMYXllcixcbiAgICAgIG5leHRCdWlsZDogdGhpcy5uZXh0QnVpbGQsXG4gICAgICBidWNrZXQ6IHByb3BzLmltYWdlT3B0aW1pemF0aW9uQnVja2V0IHx8IHRoaXMuYnVja2V0LFxuICAgICAgbGFtYmRhT3B0aW9uczogcHJvcHMuZGVmYXVsdHM/LmxhbWJkYSxcbiAgICB9KTtcbiAgICAvLyBkZXBsb3kgbmV4dGpzIHN0YXRpYyBhc3NldHMgdG8gczNcbiAgICB0aGlzLmFzc2V0c0RlcGxveW1lbnQgPSBuZXcgTmV4dEpzQXNzZXRzRGVwbG95bWVudCh0aGlzLCAnQXNzZXREZXBsb3ltZW50Jywge1xuICAgICAgLi4ucHJvcHMsXG4gICAgICAuLi5wcm9wcy5kZWZhdWx0cz8uYXNzZXREZXBsb3ltZW50LFxuICAgICAgdGVtcEJ1aWxkRGlyLFxuICAgICAgbmV4dEJ1aWxkOiB0aGlzLm5leHRCdWlsZCxcbiAgICAgIGJ1Y2tldDogdGhpcy5zdGF0aWNBc3NldEJ1Y2tldCxcbiAgICB9KTtcbiAgICAvLyBmaW5pc2ggc3RhdGljIGRlcGxveW1lbnQgQkVGT1JFIGRlcGxveWluZyBuZXcgZnVuY3Rpb24gY29kZVxuICAgIC8vIGFzIHRoZXJlIGlzIHNvbWUgdGltZSBhZnRlciB0aGUgbmV3IHN0YXRpYyBmaWxlcyBhcmUgdXBsb2FkZWQgYnV0IGJlZm9yZSB0aGV5IGFyZSByZXdyaXR0ZW5cbiAgICB0aGlzLmFzc2V0c0RlcGxveW1lbnQubm9kZS5hZGREZXBlbmRlbmN5KHRoaXMuc2VydmVyRnVuY3Rpb24pO1xuXG4gICAgdGhpcy5kaXN0cmlidXRpb24gPSBuZXcgTmV4dGpzRGlzdHJpYnV0aW9uKHRoaXMsICdEaXN0cmlidXRpb24nLCB7XG4gICAgICAuLi5wcm9wcyxcbiAgICAgIC4uLnByb3BzLmRlZmF1bHRzPy5kaXN0cmlidXRpb24sXG4gICAgICBzdGF0aWNBc3NldHNCdWNrZXQ6IHRoaXMuYXNzZXRzRGVwbG95bWVudC5idWNrZXQsXG4gICAgICB0ZW1wQnVpbGREaXIsXG4gICAgICBuZXh0QnVpbGQ6IHRoaXMubmV4dEJ1aWxkLFxuICAgICAgc2VydmVyRnVuY3Rpb246IHRoaXMuc2VydmVyRnVuY3Rpb24ubGFtYmRhRnVuY3Rpb24sXG4gICAgICBpbWFnZU9wdEZ1bmN0aW9uOiB0aGlzLmltYWdlT3B0aW1pemF0aW9uRnVuY3Rpb24sXG4gICAgfSk7XG5cbiAgICBpZiAoIXByb3BzLnF1aWV0KSBjb25zb2xlLmRlYnVnKCfilJQgRmluaXNoZWQgcHJlcGFyaW5nIE5leHRKUyBhcHAgZm9yIGRlcGxveW1lbnQnKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgdXJsKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuZGlzdHJpYnV0aW9uLnVybDtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgYnVja2V0KCk6IHMzLklCdWNrZXQge1xuICAgIHJldHVybiB0aGlzLnN0YXRpY0Fzc2V0QnVja2V0O1xuICB9XG59XG4iXX0=