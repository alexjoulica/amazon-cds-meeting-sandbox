"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.listDirectory = exports.NextJsAssetsDeployment = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const os = require("os");
const path = require("path");
const aws_s3_deployment_1 = require("aws-cdk-lib/aws-s3-deployment");
const constructs_1 = require("constructs");
const fs = require("fs-extra");
const micromatch = require("micromatch");
const constants_1 = require("./constants");
const NextjsBuild_1 = require("./NextjsBuild");
const NextjsS3EnvRewriter_1 = require("./NextjsS3EnvRewriter");
/**
 * Uploads NextJS-built static and public files to S3.
 *
 * Will rewrite CloudFormation references with their resolved values after uploading.
 */
class NextJsAssetsDeployment extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        this.props = props;
        this.bucket = props.bucket;
        this.staticTempDir = this.prepareArchiveDirectory();
        this.deployments = this.uploadS3Assets(this.staticTempDir);
        // do rewrites of unresolved CDK tokens in static files
        if (this.props.environment && !this.props.isPlaceholder) {
            const rewriter = new NextjsS3EnvRewriter_1.NextjsS3EnvRewriter(this, 'NextjsS3EnvRewriter', {
                ...props,
                s3Bucket: this.bucket,
                s3keys: this._getStaticFilesForRewrite(),
                replacementConfig: {
                    env: NextjsS3EnvRewriter_1.getS3ReplaceValues(this.props.environment, true),
                },
                debug: false,
                cloudfrontDistributionId: this.props.distribution?.distributionId,
            });
            // wait for s3 assets to be uploaded first before running
            rewriter.node.addDependency(...this.deployments);
        }
    }
    // arrange directory structure for S3 asset deployments
    // should contain _next/static and ./ for public files
    prepareArchiveDirectory() {
        const archiveDir = this.props.tempBuildDir
            ? path.resolve(path.join(this.props.tempBuildDir, 'static'))
            : fs.mkdtempSync(path.join(os.tmpdir(), 'static-'));
        fs.mkdirpSync(archiveDir);
        // theoretically we could move the files instead of copy for speed...
        // path to public folder; root static assets
        const staticDir = this.props.nextBuild.nextStaticDir;
        let publicDir = this.props.isPlaceholder
            ? path.resolve(__dirname, '../assets/PlaceholderSite')
            : this.props.nextBuild.nextPublicDir;
        if (!this.props.isPlaceholder && fs.existsSync(staticDir)) {
            // copy static files
            const staticDestinationDir = path.join(archiveDir, '_next', 'static');
            fs.mkdirpSync(staticDestinationDir);
            fs.copySync(this.props.nextBuild.nextStaticDir, staticDestinationDir, {
                recursive: true,
                dereference: true,
                preserveTimestamps: true,
            });
        }
        // copy public files to root
        if (fs.existsSync(publicDir)) {
            fs.copySync(publicDir, archiveDir, {
                recursive: true,
                dereference: true,
                preserveTimestamps: true,
            });
        }
        return archiveDir;
    }
    uploadS3Assets(archiveDir) {
        // zip up bucket contents and upload to bucket
        const archiveZipFilePath = NextjsBuild_1.createArchive({
            directory: archiveDir,
            zipFileName: 'assets.zip',
            zipOutDir: path.join(this.props.nextBuild.tempBuildDir, 'assets'),
            compressionLevel: this.props.compressionLevel,
            quiet: this.props.quiet,
        });
        if (!archiveZipFilePath)
            return [];
        const maxAge = this.props.cachePolicies?.staticMaxAgeDefault?.toSeconds() ?? constants_1.DEFAULT_STATIC_MAX_AGE;
        const staleWhileRevalidate = this.props.cachePolicies?.staticStaleWhileRevalidateDefault?.toSeconds() ?? constants_1.DEFAULT_STATIC_STALE_WHILE_REVALIDATE;
        const cacheControl = aws_s3_deployment_1.CacheControl.fromString(`public,max-age=${maxAge},stale-while-revalidate=${staleWhileRevalidate},immutable`);
        const deployment = new aws_s3_deployment_1.BucketDeployment(this, 'NextStaticAssetsS3Deployment', {
            destinationBucket: this.bucket,
            cacheControl: [cacheControl],
            sources: [aws_s3_deployment_1.Source.asset(archiveZipFilePath)],
            distribution: this.props.distribution,
            prune: this.props.prune,
        });
        return [deployment];
    }
    _getStaticFilesForRewrite() {
        const staticDir = this.staticTempDir;
        const s3keys = [];
        if (!fs.existsSync(staticDir)) {
            return [];
        }
        listDirectory(staticDir).forEach((file) => {
            const relativePath = path.relative(staticDir, file);
            // skip bogus system files
            if (relativePath.endsWith('.DS_Store'))
                return;
            // is this file a glob match?
            if (!micromatch.isMatch(relativePath, NextjsS3EnvRewriter_1.replaceTokenGlobs, { dot: true })) {
                return;
            }
            s3keys.push(relativePath);
        });
        return s3keys;
    }
}
exports.NextJsAssetsDeployment = NextJsAssetsDeployment;
_a = JSII_RTTI_SYMBOL_1;
NextJsAssetsDeployment[_a] = { fqn: "cdk-nextjs-standalone.NextJsAssetsDeployment", version: "2.0.3" };
function listDirectory(dir) {
    const fileList = [];
    const publicFiles = fs.readdirSync(dir);
    for (const filename of publicFiles) {
        const filepath = path.join(dir, filename);
        const stat = fs.statSync(filepath);
        if (stat.isDirectory()) {
            fileList.push(...listDirectory(filepath));
        }
        else {
            fileList.push(filepath);
        }
    }
    return fileList;
}
exports.listDirectory = listDirectory;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTmV4dGpzQXNzZXRzRGVwbG95bWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9OZXh0anNBc3NldHNEZXBsb3ltZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEseUJBQXlCO0FBQ3pCLDZCQUE2QjtBQUk3QixxRUFBdUY7QUFDdkYsMkNBQXVDO0FBQ3ZDLCtCQUErQjtBQUMvQix5Q0FBeUM7QUFDekMsMkNBQTRGO0FBRTVGLCtDQUEyRDtBQUMzRCwrREFBbUc7QUEyQ25HOzs7O0dBSUc7QUFDSCxNQUFhLHNCQUF1QixTQUFRLHNCQUFTO0lBZW5ELFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBa0M7UUFDMUUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUVuQixJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUM7UUFDM0IsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztRQUNwRCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRTNELHVEQUF1RDtRQUN2RCxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUU7WUFDdkQsTUFBTSxRQUFRLEdBQUcsSUFBSSx5Q0FBbUIsQ0FBQyxJQUFJLEVBQUUscUJBQXFCLEVBQUU7Z0JBQ3BFLEdBQUcsS0FBSztnQkFDUixRQUFRLEVBQUUsSUFBSSxDQUFDLE1BQU07Z0JBQ3JCLE1BQU0sRUFBRSxJQUFJLENBQUMseUJBQXlCLEVBQUU7Z0JBQ3hDLGlCQUFpQixFQUFFO29CQUNqQixHQUFHLEVBQUUsd0NBQWtCLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsSUFB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LENBQUMsWUFBWSxFQUFFLHVDQUFpQixFQUFFLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxDQUFDLEVBQUU7Z0JBQ3ZFLE9BQU87YUFDUjtZQUNELE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDNUIsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDOztBQS9ISCx3REFnSUM7OztBQUVELFNBQWdCLGFBQWEsQ0FBQyxHQUFXO0lBQ3ZDLE1BQU0sUUFBUSxHQUFhLEVBQUUsQ0FBQztJQUM5QixNQUFNLFdBQVcsR0FBRyxFQUFFLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3hDLEtBQUssTUFBTSxRQUFRLElBQUksV0FBVyxFQUFFO1FBQ2xDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQzFDLE1BQU0sSUFBSSxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDbkMsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFLEVBQUU7WUFDdEIsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1NBQzNDO2FBQU07WUFDTCxRQUFRLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ3pCO0tBQ0Y7SUFFRCxPQUFPLFFBQVEsQ0FBQztBQUNsQixDQUFDO0FBZEQsc0NBY0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBvcyBmcm9tICdvcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgRHVyYXRpb24gfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgKiBhcyBjbG91ZGZyb250IGZyb20gJ2F3cy1jZGstbGliL2F3cy1jbG91ZGZyb250JztcbmltcG9ydCAqIGFzIHMzIGZyb20gJ2F3cy1jZGstbGliL2F3cy1zMyc7XG5pbXBvcnQgeyBCdWNrZXREZXBsb3ltZW50LCBDYWNoZUNvbnRyb2wsIFNvdXJjZSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1zMy1kZXBsb3ltZW50JztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0ICogYXMgbWljcm9tYXRjaCBmcm9tICdtaWNyb21hdGNoJztcbmltcG9ydCB7IERFRkFVTFRfU1RBVElDX01BWF9BR0UsIERFRkFVTFRfU1RBVElDX1NUQUxFX1dISUxFX1JFVkFMSURBVEUgfSBmcm9tICcuL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBOZXh0anNCYXNlUHJvcHMgfSBmcm9tICcuL05leHRqc0Jhc2UnO1xuaW1wb3J0IHsgY3JlYXRlQXJjaGl2ZSwgTmV4dGpzQnVpbGQgfSBmcm9tICcuL05leHRqc0J1aWxkJztcbmltcG9ydCB7IGdldFMzUmVwbGFjZVZhbHVlcywgTmV4dGpzUzNFbnZSZXdyaXRlciwgcmVwbGFjZVRva2VuR2xvYnMgfSBmcm9tICcuL05leHRqc1MzRW52UmV3cml0ZXInO1xuXG5leHBvcnQgaW50ZXJmYWNlIE5leHRqc0Fzc2V0c0NhY2hlUG9saWN5UHJvcHMge1xuICAvKipcbiAgICogQ2FjaGUtY29udHJvbCBtYXgtYWdlIGRlZmF1bHQgZm9yIFMzIHN0YXRpYyBhc3NldHMuXG4gICAqIERlZmF1bHQ6IDMwIGRheXMuXG4gICAqL1xuICByZWFkb25seSBzdGF0aWNNYXhBZ2VEZWZhdWx0PzogRHVyYXRpb247XG4gIC8qKlxuICAgKiBDYWNoZS1jb250cm9sIHN0YWxlLXdoaWxlLXJldmFsaWRhdGUgZGVmYXVsdCBmb3IgUzMgc3RhdGljIGFzc2V0cy5cbiAgICogRGVmYXVsdDogMSBkYXkuXG4gICAqL1xuICByZWFkb25seSBzdGF0aWNTdGFsZVdoaWxlUmV2YWxpZGF0ZURlZmF1bHQ/OiBEdXJhdGlvbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBOZXh0anNBc3NldHNEZXBsb3ltZW50UHJvcHMgZXh0ZW5kcyBOZXh0anNCYXNlUHJvcHMge1xuICAvKipcbiAgICogVGhlIGBOZXh0anNCdWlsZGAgaW5zdGFuY2UgcmVwcmVzZW50aW5nIHRoZSBidWlsdCBOZXh0anMgYXBwbGljYXRpb24uXG4gICAqL1xuICByZWFkb25seSBuZXh0QnVpbGQ6IE5leHRqc0J1aWxkO1xuXG4gIC8qKlxuICAgKiBQcm9wZXJ0aWVzIGZvciB0aGUgUzMgYnVja2V0IGNvbnRhaW5pbmcgdGhlIE5leHRKUyBhc3NldHMuXG4gICAqL1xuICByZWFkb25seSBidWNrZXQ6IHMzLklCdWNrZXQ7XG5cbiAgLyoqXG4gICAqIERpc3RyaWJ1dGlvbiB0byBpbnZhbGlkYXRlIHdoZW4gYXNzZXRzIGNoYW5nZS5cbiAgICovXG4gIHJlYWRvbmx5IGRpc3RyaWJ1dGlvbj86IGNsb3VkZnJvbnQuSURpc3RyaWJ1dGlvbjtcblxuICAvKipcbiAgICogT3ZlcnJpZGUgdGhlIGRlZmF1bHQgUzMgY2FjaGUgcG9saWNpZXMgY3JlYXRlZCBpbnRlcm5hbGx5LlxuICAgKi9cbiAgcmVhZG9ubHkgY2FjaGVQb2xpY2llcz86IE5leHRqc0Fzc2V0c0NhY2hlUG9saWN5UHJvcHM7XG5cbiAgLyoqXG4gICAqIFNldCB0byB0cnVlIHRvIGRlbGV0ZSBvbGQgYXNzZXRzIChkZWZhdWx0cyB0byBmYWxzZSkuXG4gICAqIFJlY29tbWVuZGVkIHRvIG9ubHkgc2V0IHRvIHRydWUgaWYgeW91IGRvbid0IG5lZWQgdGhlIGFiaWxpdHkgdG8gcm9sbCBiYWNrIGRlcGxveW1lbnRzLlxuICAgKi9cbiAgcmVhZG9ubHkgcHJ1bmU/OiBib29sZWFuO1xufVxuXG4vKipcbiAqIFVwbG9hZHMgTmV4dEpTLWJ1aWx0IHN0YXRpYyBhbmQgcHVibGljIGZpbGVzIHRvIFMzLlxuICpcbiAqIFdpbGwgcmV3cml0ZSBDbG91ZEZvcm1hdGlvbiByZWZlcmVuY2VzIHdpdGggdGhlaXIgcmVzb2x2ZWQgdmFsdWVzIGFmdGVyIHVwbG9hZGluZy5cbiAqL1xuZXhwb3J0IGNsYXNzIE5leHRKc0Fzc2V0c0RlcGxveW1lbnQgZXh0ZW5kcyBDb25zdHJ1Y3Qge1xuICAvKipcbiAgICogQnVja2V0IGNvbnRhaW5pbmcgYXNzZXRzLlxuICAgKi9cbiAgYnVja2V0OiBzMy5JQnVja2V0O1xuXG4gIC8qKlxuICAgKiBBc3NldCBkZXBsb3ltZW50cyB0byBTMy5cbiAgICovXG4gIHB1YmxpYyBkZXBsb3ltZW50czogQnVja2V0RGVwbG95bWVudFtdO1xuXG4gIHB1YmxpYyBzdGF0aWNUZW1wRGlyOiBzdHJpbmc7XG5cbiAgcHJvdGVjdGVkIHByb3BzOiBOZXh0anNBc3NldHNEZXBsb3ltZW50UHJvcHM7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IE5leHRqc0Fzc2V0c0RlcGxveW1lbnRQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICB0aGlzLnByb3BzID0gcHJvcHM7XG5cbiAgICB0aGlzLmJ1Y2tldCA9IHByb3BzLmJ1Y2tldDtcbiAgICB0aGlzLnN0YXRpY1RlbXBEaXIgPSB0aGlzLnByZXBhcmVBcmNoaXZlRGlyZWN0b3J5KCk7XG4gICAgdGhpcy5kZXBsb3ltZW50cyA9IHRoaXMudXBsb2FkUzNBc3NldHModGhpcy5zdGF0aWNUZW1wRGlyKTtcblxuICAgIC8vIGRvIHJld3JpdGVzIG9mIHVucmVzb2x2ZWQgQ0RLIHRva2VucyBpbiBzdGF0aWMgZmlsZXNcbiAgICBpZiAodGhpcy5wcm9wcy5lbnZpcm9ubWVudCAmJiAhdGhpcy5wcm9wcy5pc1BsYWNlaG9sZGVyKSB7XG4gICAgICBjb25zdCByZXdyaXRlciA9IG5ldyBOZXh0anNTM0VudlJld3JpdGVyKHRoaXMsICdOZXh0anNTM0VudlJld3JpdGVyJywge1xuICAgICAgICAuLi5wcm9wcyxcbiAgICAgICAgczNCdWNrZXQ6IHRoaXMuYnVja2V0LFxuICAgICAgICBzM2tleXM6IHRoaXMuX2dldFN0YXRpY0ZpbGVzRm9yUmV3cml0ZSgpLFxuICAgICAgICByZXBsYWNlbWVudENvbmZpZzoge1xuICAgICAgICAgIGVudjogZ2V0UzNSZXBsYWNlVmFsdWVzKHRoaXMucHJvcHMuZW52aXJvbm1lbnQsIHRydWUpLFxuICAgICAgICB9LFxuICAgICAgICBkZWJ1ZzogZmFsc2UsXG4gICAgICAgIGNsb3VkZnJvbnREaXN0cmlidXRpb25JZDogdGhpcy5wcm9wcy5kaXN0cmlidXRpb24/LmRpc3RyaWJ1dGlvbklkLFxuICAgICAgfSk7XG4gICAgICAvLyB3YWl0IGZvciBzMyBhc3NldHMgdG8gYmUgdXBsb2FkZWQgZmlyc3QgYmVmb3JlIHJ1bm5pbmdcbiAgICAgIHJld3JpdGVyLm5vZGUuYWRkRGVwZW5kZW5jeSguLi50aGlzLmRlcGxveW1lbnRzKTtcbiAgICB9XG4gIH1cblxuICAvLyBhcnJhbmdlIGRpcmVjdG9yeSBzdHJ1Y3R1cmUgZm9yIFMzIGFzc2V0IGRlcGxveW1lbnRzXG4gIC8vIHNob3VsZCBjb250YWluIF9uZXh0L3N0YXRpYyBhbmQgLi8gZm9yIHB1YmxpYyBmaWxlc1xuICBwcm90ZWN0ZWQgcHJlcGFyZUFyY2hpdmVEaXJlY3RvcnkoKTogc3RyaW5nIHtcbiAgICBjb25zdCBhcmNoaXZlRGlyID0gdGhpcy5wcm9wcy50ZW1wQnVpbGREaXJcbiAgICAgID8gcGF0aC5yZXNvbHZlKHBhdGguam9pbih0aGlzLnByb3BzLnRlbXBCdWlsZERpciwgJ3N0YXRpYycpKVxuICAgICAgOiBmcy5ta2R0ZW1wU3luYyhwYXRoLmpvaW4ob3MudG1wZGlyKCksICdzdGF0aWMtJykpO1xuICAgIGZzLm1rZGlycFN5bmMoYXJjaGl2ZURpcik7XG5cbiAgICAvLyB0aGVvcmV0aWNhbGx5IHdlIGNvdWxkIG1vdmUgdGhlIGZpbGVzIGluc3RlYWQgb2YgY29weSBmb3Igc3BlZWQuLi5cblxuICAgIC8vIHBhdGggdG8gcHVibGljIGZvbGRlcjsgcm9vdCBzdGF0aWMgYXNzZXRzXG4gICAgY29uc3Qgc3RhdGljRGlyID0gdGhpcy5wcm9wcy5uZXh0QnVpbGQubmV4dFN0YXRpY0RpcjtcbiAgICBsZXQgcHVibGljRGlyID0gdGhpcy5wcm9wcy5pc1BsYWNlaG9sZGVyXG4gICAgICA/IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLi9hc3NldHMvUGxhY2Vob2xkZXJTaXRlJylcbiAgICAgIDogdGhpcy5wcm9wcy5uZXh0QnVpbGQubmV4dFB1YmxpY0RpcjtcblxuICAgIGlmICghdGhpcy5wcm9wcy5pc1BsYWNlaG9sZGVyICYmIGZzLmV4aXN0c1N5bmMoc3RhdGljRGlyKSkge1xuICAgICAgLy8gY29weSBzdGF0aWMgZmlsZXNcbiAgICAgIGNvbnN0IHN0YXRpY0Rlc3RpbmF0aW9uRGlyID0gcGF0aC5qb2luKGFyY2hpdmVEaXIsICdfbmV4dCcsICdzdGF0aWMnKTtcbiAgICAgIGZzLm1rZGlycFN5bmMoc3RhdGljRGVzdGluYXRpb25EaXIpO1xuICAgICAgZnMuY29weVN5bmModGhpcy5wcm9wcy5uZXh0QnVpbGQubmV4dFN0YXRpY0Rpciwgc3RhdGljRGVzdGluYXRpb25EaXIsIHtcbiAgICAgICAgcmVjdXJzaXZlOiB0cnVlLFxuICAgICAgICBkZXJlZmVyZW5jZTogdHJ1ZSxcbiAgICAgICAgcHJlc2VydmVUaW1lc3RhbXBzOiB0cnVlLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gY29weSBwdWJsaWMgZmlsZXMgdG8gcm9vdFxuICAgIGlmIChmcy5leGlzdHNTeW5jKHB1YmxpY0RpcikpIHtcbiAgICAgIGZzLmNvcHlTeW5jKHB1YmxpY0RpciwgYXJjaGl2ZURpciwge1xuICAgICAgICByZWN1cnNpdmU6IHRydWUsXG4gICAgICAgIGRlcmVmZXJlbmNlOiB0cnVlLFxuICAgICAgICBwcmVzZXJ2ZVRpbWVzdGFtcHM6IHRydWUsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gYXJjaGl2ZURpcjtcbiAgfVxuXG4gIHByaXZhdGUgdXBsb2FkUzNBc3NldHMoYXJjaGl2ZURpcjogc3RyaW5nKSB7XG4gICAgLy8gemlwIHVwIGJ1Y2tldCBjb250ZW50cyBhbmQgdXBsb2FkIHRvIGJ1Y2tldFxuICAgIGNvbnN0IGFyY2hpdmVaaXBGaWxlUGF0aCA9IGNyZWF0ZUFyY2hpdmUoe1xuICAgICAgZGlyZWN0b3J5OiBhcmNoaXZlRGlyLFxuICAgICAgemlwRmlsZU5hbWU6ICdhc3NldHMuemlwJyxcbiAgICAgIHppcE91dERpcjogcGF0aC5qb2luKHRoaXMucHJvcHMubmV4dEJ1aWxkLnRlbXBCdWlsZERpciwgJ2Fzc2V0cycpLFxuICAgICAgY29tcHJlc3Npb25MZXZlbDogdGhpcy5wcm9wcy5jb21wcmVzc2lvbkxldmVsLFxuICAgICAgcXVpZXQ6IHRoaXMucHJvcHMucXVpZXQsXG4gICAgfSk7XG4gICAgaWYgKCFhcmNoaXZlWmlwRmlsZVBhdGgpIHJldHVybiBbXTtcblxuICAgIGNvbnN0IG1heEFnZSA9IHRoaXMucHJvcHMuY2FjaGVQb2xpY2llcz8uc3RhdGljTWF4QWdlRGVmYXVsdD8udG9TZWNvbmRzKCkgPz8gREVGQVVMVF9TVEFUSUNfTUFYX0FHRTtcbiAgICBjb25zdCBzdGFsZVdoaWxlUmV2YWxpZGF0ZSA9XG4gICAgICB0aGlzLnByb3BzLmNhY2hlUG9saWNpZXM/LnN0YXRpY1N0YWxlV2hpbGVSZXZhbGlkYXRlRGVmYXVsdD8udG9TZWNvbmRzKCkgPz8gREVGQVVMVF9TVEFUSUNfU1RBTEVfV0hJTEVfUkVWQUxJREFURTtcbiAgICBjb25zdCBjYWNoZUNvbnRyb2wgPSBDYWNoZUNvbnRyb2wuZnJvbVN0cmluZyhcbiAgICAgIGBwdWJsaWMsbWF4LWFnZT0ke21heEFnZX0sc3RhbGUtd2hpbGUtcmV2YWxpZGF0ZT0ke3N0YWxlV2hpbGVSZXZhbGlkYXRlfSxpbW11dGFibGVgXG4gICAgKTtcbiAgICBjb25zdCBkZXBsb3ltZW50ID0gbmV3IEJ1Y2tldERlcGxveW1lbnQodGhpcywgJ05leHRTdGF0aWNBc3NldHNTM0RlcGxveW1lbnQnLCB7XG4gICAgICBkZXN0aW5hdGlvbkJ1Y2tldDogdGhpcy5idWNrZXQsXG4gICAgICBjYWNoZUNvbnRyb2w6IFtjYWNoZUNvbnRyb2xdLFxuICAgICAgc291cmNlczogW1NvdXJjZS5hc3NldChhcmNoaXZlWmlwRmlsZVBhdGgpXSxcbiAgICAgIGRpc3RyaWJ1dGlvbjogdGhpcy5wcm9wcy5kaXN0cmlidXRpb24sXG4gICAgICBwcnVuZTogdGhpcy5wcm9wcy5wcnVuZSxcbiAgICB9KTtcblxuICAgIHJldHVybiBbZGVwbG95bWVudF07XG4gIH1cblxuICBwcml2YXRlIF9nZXRTdGF0aWNGaWxlc0ZvclJld3JpdGUoKSB7XG4gICAgY29uc3Qgc3RhdGljRGlyID0gdGhpcy5zdGF0aWNUZW1wRGlyO1xuICAgIGNvbnN0IHMza2V5czogc3RyaW5nW10gPSBbXTtcbiAgICBpZiAoIWZzLmV4aXN0c1N5bmMoc3RhdGljRGlyKSkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBsaXN0RGlyZWN0b3J5KHN0YXRpY0RpcikuZm9yRWFjaCgoZmlsZSkgPT4ge1xuICAgICAgY29uc3QgcmVsYXRpdmVQYXRoID0gcGF0aC5yZWxhdGl2ZShzdGF0aWNEaXIsIGZpbGUpO1xuXG4gICAgICAvLyBza2lwIGJvZ3VzIHN5c3RlbSBmaWxlc1xuICAgICAgaWYgKHJlbGF0aXZlUGF0aC5lbmRzV2l0aCgnLkRTX1N0b3JlJykpIHJldHVybjtcblxuICAgICAgLy8gaXMgdGhpcyBmaWxlIGEgZ2xvYiBtYXRjaD9cbiAgICAgIGlmICghbWljcm9tYXRjaC5pc01hdGNoKHJlbGF0aXZlUGF0aCwgcmVwbGFjZVRva2VuR2xvYnMsIHsgZG90OiB0cnVlIH0pKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHMza2V5cy5wdXNoKHJlbGF0aXZlUGF0aCk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHMza2V5cztcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gbGlzdERpcmVjdG9yeShkaXI6IHN0cmluZykge1xuICBjb25zdCBmaWxlTGlzdDogc3RyaW5nW10gPSBbXTtcbiAgY29uc3QgcHVibGljRmlsZXMgPSBmcy5yZWFkZGlyU3luYyhkaXIpO1xuICBmb3IgKGNvbnN0IGZpbGVuYW1lIG9mIHB1YmxpY0ZpbGVzKSB7XG4gICAgY29uc3QgZmlsZXBhdGggPSBwYXRoLmpvaW4oZGlyLCBmaWxlbmFtZSk7XG4gICAgY29uc3Qgc3RhdCA9IGZzLnN0YXRTeW5jKGZpbGVwYXRoKTtcbiAgICBpZiAoc3RhdC5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICBmaWxlTGlzdC5wdXNoKC4uLmxpc3REaXJlY3RvcnkoZmlsZXBhdGgpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZmlsZUxpc3QucHVzaChmaWxlcGF0aCk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGZpbGVMaXN0O1xufVxuIl19