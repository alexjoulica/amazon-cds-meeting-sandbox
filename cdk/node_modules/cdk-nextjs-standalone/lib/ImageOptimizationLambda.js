"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.ImageOptimizationLambda = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const fs = require("fs");
const path = require("path");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const aws_lambda_nodejs_1 = require("aws-cdk-lib/aws-lambda-nodejs");
const constants_1 = require("./constants");
/**
 * This lambda handles image optimization.
 */
class ImageOptimizationLambda extends aws_lambda_nodejs_1.NodejsFunction {
    constructor(scope, id, props) {
        const { lambdaOptions, bucket, isPlaceholder } = props;
        const lambdaPath = path.resolve(__dirname, '../assets/lambda/ImageOptimization');
        const imageOptHandlerPath = path.resolve(lambdaPath, 'index.ts');
        /**
         * NOTE: This needs to be configured before calling super(), otherwise the build
         * will fail about missing modules.
         * Creates a symlink from the user's nextjs node_modules/next =>
         * assets/lambda/node_modules/next.
         * When NextjsFunction executes, it will use esbuild to bundle the required modules
         * in `imageOptimization.ts` to minimize the function size.
         */
        const source = path.join(props.nextBuild.nextDir, 'node_modules/next');
        const modulesPath = path.join(lambdaPath, 'node_modules');
        const target = path.join(modulesPath, 'next');
        if (!fs.existsSync(modulesPath))
            fs.mkdirSync(modulesPath);
        if (!fs.existsSync(target))
            fs.symlinkSync(source, target, 'dir');
        super(scope, id, {
            entry: isPlaceholder
                ? path.join(__dirname, '../assets/lambda/ImageOptimization/placeholder.ts')
                : imageOptHandlerPath,
            runtime: constants_1.LAMBDA_RUNTIME,
            bundling: isPlaceholder
                ? undefined
                : {
                    commandHooks: {
                        beforeBundling(_, outputDir) {
                            // Saves the required-server-files.json to the .next folder
                            const filePath = path.join(props.nextBuild.nextStandaloneBuildDir, 'required-server-files.json');
                            return [`mkdir -p "${outputDir}/.next"`, `cp "${filePath}" "${outputDir}/.next"`];
                        },
                        afterBundling() {
                            return [];
                        },
                        beforeInstall() {
                            return [];
                        },
                    },
                    minify: true,
                    target: 'node16',
                    externalModules: [],
                },
            layers: [props.nextLayer],
            ...lambdaOptions,
            // defaults
            memorySize: lambdaOptions?.memorySize || 1024,
            timeout: lambdaOptions?.timeout ?? aws_cdk_lib_1.Duration.seconds(10),
            environment: {
                S3_SOURCE_BUCKET: bucket.bucketName,
            },
        });
        this.bucket = bucket;
        this.addPolicy();
        fs.rmSync(modulesPath, { recursive: true, force: true });
    }
    /**
     * Adds policy statement to give GetObject permission Image Optimization lambda.
     */
    addPolicy() {
        const policyStatement = new aws_iam_1.PolicyStatement({
            actions: ['s3:GetObject'],
            resources: [this.bucket.arnForObjects('*')],
        });
        this.role?.attachInlinePolicy(new aws_iam_1.Policy(this, 'get-image-policy', {
            statements: [policyStatement],
        }));
    }
}
exports.ImageOptimizationLambda = ImageOptimizationLambda;
_a = JSII_RTTI_SYMBOL_1;
ImageOptimizationLambda[_a] = { fqn: "cdk-nextjs-standalone.ImageOptimizationLambda", version: "2.0.3" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSW1hZ2VPcHRpbWl6YXRpb25MYW1iZGEuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvSW1hZ2VPcHRpbWl6YXRpb25MYW1iZGEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSx5QkFBeUI7QUFDekIsNkJBQTZCO0FBQzdCLDZDQUF1QztBQUN2QyxpREFBOEQ7QUFFOUQscUVBQStEO0FBRy9ELDJDQUE2QztBQWtDN0M7O0dBRUc7QUFDSCxNQUFhLHVCQUF3QixTQUFRLGtDQUFjO0lBR3pELFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBNkI7UUFDckUsTUFBTSxFQUFFLGFBQWEsRUFBRSxNQUFNLEVBQUUsYUFBYSxFQUFFLEdBQUcsS0FBSyxDQUFDO1FBQ3ZELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLG9DQUFvQyxDQUFDLENBQUM7UUFDakYsTUFBTSxtQkFBbUIsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxVQUFVLENBQUMsQ0FBQztRQUVqRTs7Ozs7OztXQU9HO1FBQ0gsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxtQkFBbUIsQ0FBQyxDQUFDO1FBQ3ZFLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBQzFELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQzlDLElBQUksQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQztZQUFFLEVBQUUsQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDM0QsSUFBSSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDO1lBQUUsRUFBRSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRWxFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFO1lBQ2YsS0FBSyxFQUFFLGFBQWE7Z0JBQ2xCLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxtREFBbUQsQ0FBQztnQkFDM0UsQ0FBQyxDQUFDLG1CQUFtQjtZQUN2QixPQUFPLEVBQUUsMEJBQWM7WUFDdkIsUUFBUSxFQUFFLGFBQWE7Z0JBQ3JCLENBQUMsQ0FBQyxTQUFTO2dCQUNYLENBQUMsQ0FBQztvQkFDRSxZQUFZLEVBQUU7d0JBQ1osY0FBYyxDQUFDLENBQVMsRUFBRSxTQUFpQjs0QkFDekMsMkRBQTJEOzRCQUMzRCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsc0JBQXNCLEVBQUUsNEJBQTRCLENBQUMsQ0FBQzs0QkFDakcsT0FBTyxDQUFDLGFBQWEsU0FBUyxTQUFTLEVBQUUsT0FBTyxRQUFRLE1BQU0sU0FBUyxTQUFTLENBQUMsQ0FBQzt3QkFDcEYsQ0FBQzt3QkFDRCxhQUFhOzRCQUNYLE9BQU8sRUFBRSxDQUFDO3dCQUNaLENBQUM7d0JBQ0QsYUFBYTs0QkFDWCxPQUFPLEVBQUUsQ0FBQzt3QkFDWixDQUFDO3FCQUNGO29CQUNELE1BQU0sRUFBRSxJQUFJO29CQUNaLE1BQU0sRUFBRSxRQUFRO29CQUNoQixlQUFlLEVBQUUsRUFBRTtpQkFDcEI7WUFDTCxNQUFNLEVBQUUsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDO1lBQ3pCLEdBQUcsYUFBYTtZQUNoQixXQUFXO1lBQ1gsVUFBVSxFQUFFLGFBQWEsRUFBRSxVQUFVLElBQUksSUFBSTtZQUM3QyxPQUFPLEVBQUUsYUFBYSxFQUFFLE9BQU8sSUFBSSxzQkFBUSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7WUFDdkQsV0FBVyxFQUFFO2dCQUNYLGdCQUFnQixFQUFFLE1BQU0sQ0FBQyxVQUFVO2FBQ3BDO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBRWpCLEVBQUUsQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUMzRCxDQUFDO0lBRUQ7O09BRUc7SUFDSyxTQUFTO1FBQ2YsTUFBTSxlQUFlLEdBQUcsSUFBSSx5QkFBZSxDQUFDO1lBQzFDLE9BQU8sRUFBRSxDQUFDLGNBQWMsQ0FBQztZQUN6QixTQUFTLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUM1QyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsSUFBSSxFQUFFLGtCQUFrQixDQUMzQixJQUFJLGdCQUFNLENBQUMsSUFBSSxFQUFFLGtCQUFrQixFQUFFO1lBQ25DLFVBQVUsRUFBRSxDQUFDLGVBQWUsQ0FBQztTQUM5QixDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7O0FBN0VILDBEQThFQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBEdXJhdGlvbiB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7IFBvbGljeSwgUG9saWN5U3RhdGVtZW50IH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSc7XG5pbXBvcnQgeyBGdW5jdGlvbk9wdGlvbnMgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhJztcbmltcG9ydCB7IE5vZGVqc0Z1bmN0aW9uIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYS1ub2RlanMnO1xuaW1wb3J0IHsgSUJ1Y2tldCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1zMyc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IExBTUJEQV9SVU5USU1FIH0gZnJvbSAnLi9jb25zdGFudHMnO1xuaW1wb3J0IHsgTmV4dGpzQmFzZVByb3BzIH0gZnJvbSAnLi9OZXh0anNCYXNlJztcbmltcG9ydCB0eXBlIHsgTmV4dGpzQnVpbGQgfSBmcm9tICcuL05leHRqc0J1aWxkJztcbmltcG9ydCB7IE5leHRqc0xheWVyIH0gZnJvbSAnLi9OZXh0anNMYXllcic7XG4vLyBpbXBvcnQgeyBjb25maWcgfSBmcm9tICdwcm9jZXNzJztcblxuZXhwb3J0IHR5cGUgUmVtb3RlUGF0dGVybiA9IHtcbiAgcHJvdG9jb2w6IHN0cmluZztcbiAgaG9zdG5hbWU6IHN0cmluZztcbiAgcG9ydD86IHN0cmluZztcbiAgcGF0aG5hbWU/OiBzdHJpbmc7XG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIEltYWdlT3B0aW1pemF0aW9uUHJvcHMgZXh0ZW5kcyBOZXh0anNCYXNlUHJvcHMge1xuICAvKipcbiAgICogVGhlIFMzIGJ1Y2tldCBob2xkaW5nIGFwcGxpY2F0aW9uIGltYWdlcy5cbiAgICovXG4gIHJlYWRvbmx5IGJ1Y2tldDogSUJ1Y2tldDtcblxuICAvKipcbiAgICogT3ZlcnJpZGUgZnVuY3Rpb24gcHJvcGVydGllcy5cbiAgICovXG4gIHJlYWRvbmx5IGxhbWJkYU9wdGlvbnM/OiBGdW5jdGlvbk9wdGlvbnM7XG5cbiAgLyoqXG4gICAqIE5leHRqc0xheWVyIC0gc2hhcnAgcnVudGltZVxuICAgKi9cbiAgcmVhZG9ubHkgbmV4dExheWVyOiBOZXh0anNMYXllcjtcbiAgLyoqXG4gICAqIFRoZSBgTmV4dGpzQnVpbGRgIGluc3RhbmNlIHJlcHJlc2VudGluZyB0aGUgYnVpbHQgTmV4dGpzIGFwcGxpY2F0aW9uLlxuICAgKi9cbiAgcmVhZG9ubHkgbmV4dEJ1aWxkOiBOZXh0anNCdWlsZDtcbn1cblxuLyoqXG4gKiBUaGlzIGxhbWJkYSBoYW5kbGVzIGltYWdlIG9wdGltaXphdGlvbi5cbiAqL1xuZXhwb3J0IGNsYXNzIEltYWdlT3B0aW1pemF0aW9uTGFtYmRhIGV4dGVuZHMgTm9kZWpzRnVuY3Rpb24ge1xuICBidWNrZXQ6IElCdWNrZXQ7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IEltYWdlT3B0aW1pemF0aW9uUHJvcHMpIHtcbiAgICBjb25zdCB7IGxhbWJkYU9wdGlvbnMsIGJ1Y2tldCwgaXNQbGFjZWhvbGRlciB9ID0gcHJvcHM7XG4gICAgY29uc3QgbGFtYmRhUGF0aCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLi9hc3NldHMvbGFtYmRhL0ltYWdlT3B0aW1pemF0aW9uJyk7XG4gICAgY29uc3QgaW1hZ2VPcHRIYW5kbGVyUGF0aCA9IHBhdGgucmVzb2x2ZShsYW1iZGFQYXRoLCAnaW5kZXgudHMnKTtcblxuICAgIC8qKlxuICAgICAqIE5PVEU6IFRoaXMgbmVlZHMgdG8gYmUgY29uZmlndXJlZCBiZWZvcmUgY2FsbGluZyBzdXBlcigpLCBvdGhlcndpc2UgdGhlIGJ1aWxkXG4gICAgICogd2lsbCBmYWlsIGFib3V0IG1pc3NpbmcgbW9kdWxlcy5cbiAgICAgKiBDcmVhdGVzIGEgc3ltbGluayBmcm9tIHRoZSB1c2VyJ3MgbmV4dGpzIG5vZGVfbW9kdWxlcy9uZXh0ID0+XG4gICAgICogYXNzZXRzL2xhbWJkYS9ub2RlX21vZHVsZXMvbmV4dC5cbiAgICAgKiBXaGVuIE5leHRqc0Z1bmN0aW9uIGV4ZWN1dGVzLCBpdCB3aWxsIHVzZSBlc2J1aWxkIHRvIGJ1bmRsZSB0aGUgcmVxdWlyZWQgbW9kdWxlc1xuICAgICAqIGluIGBpbWFnZU9wdGltaXphdGlvbi50c2AgdG8gbWluaW1pemUgdGhlIGZ1bmN0aW9uIHNpemUuXG4gICAgICovXG4gICAgY29uc3Qgc291cmNlID0gcGF0aC5qb2luKHByb3BzLm5leHRCdWlsZC5uZXh0RGlyLCAnbm9kZV9tb2R1bGVzL25leHQnKTtcbiAgICBjb25zdCBtb2R1bGVzUGF0aCA9IHBhdGguam9pbihsYW1iZGFQYXRoLCAnbm9kZV9tb2R1bGVzJyk7XG4gICAgY29uc3QgdGFyZ2V0ID0gcGF0aC5qb2luKG1vZHVsZXNQYXRoLCAnbmV4dCcpO1xuICAgIGlmICghZnMuZXhpc3RzU3luYyhtb2R1bGVzUGF0aCkpIGZzLm1rZGlyU3luYyhtb2R1bGVzUGF0aCk7XG4gICAgaWYgKCFmcy5leGlzdHNTeW5jKHRhcmdldCkpIGZzLnN5bWxpbmtTeW5jKHNvdXJjZSwgdGFyZ2V0LCAnZGlyJyk7XG5cbiAgICBzdXBlcihzY29wZSwgaWQsIHtcbiAgICAgIGVudHJ5OiBpc1BsYWNlaG9sZGVyXG4gICAgICAgID8gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2Fzc2V0cy9sYW1iZGEvSW1hZ2VPcHRpbWl6YXRpb24vcGxhY2Vob2xkZXIudHMnKVxuICAgICAgICA6IGltYWdlT3B0SGFuZGxlclBhdGgsXG4gICAgICBydW50aW1lOiBMQU1CREFfUlVOVElNRSxcbiAgICAgIGJ1bmRsaW5nOiBpc1BsYWNlaG9sZGVyXG4gICAgICAgID8gdW5kZWZpbmVkXG4gICAgICAgIDoge1xuICAgICAgICAgICAgY29tbWFuZEhvb2tzOiB7XG4gICAgICAgICAgICAgIGJlZm9yZUJ1bmRsaW5nKF86IHN0cmluZywgb3V0cHV0RGlyOiBzdHJpbmcpOiBzdHJpbmdbXSB7XG4gICAgICAgICAgICAgICAgLy8gU2F2ZXMgdGhlIHJlcXVpcmVkLXNlcnZlci1maWxlcy5qc29uIHRvIHRoZSAubmV4dCBmb2xkZXJcbiAgICAgICAgICAgICAgICBjb25zdCBmaWxlUGF0aCA9IHBhdGguam9pbihwcm9wcy5uZXh0QnVpbGQubmV4dFN0YW5kYWxvbmVCdWlsZERpciwgJ3JlcXVpcmVkLXNlcnZlci1maWxlcy5qc29uJyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFtgbWtkaXIgLXAgXCIke291dHB1dERpcn0vLm5leHRcImAsIGBjcCBcIiR7ZmlsZVBhdGh9XCIgXCIke291dHB1dERpcn0vLm5leHRcImBdO1xuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBhZnRlckJ1bmRsaW5nKCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBbXTtcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgYmVmb3JlSW5zdGFsbCgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gW107XG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgbWluaWZ5OiB0cnVlLFxuICAgICAgICAgICAgdGFyZ2V0OiAnbm9kZTE2JyxcbiAgICAgICAgICAgIGV4dGVybmFsTW9kdWxlczogW10sXG4gICAgICAgICAgfSxcbiAgICAgIGxheWVyczogW3Byb3BzLm5leHRMYXllcl0sXG4gICAgICAuLi5sYW1iZGFPcHRpb25zLFxuICAgICAgLy8gZGVmYXVsdHNcbiAgICAgIG1lbW9yeVNpemU6IGxhbWJkYU9wdGlvbnM/Lm1lbW9yeVNpemUgfHwgMTAyNCxcbiAgICAgIHRpbWVvdXQ6IGxhbWJkYU9wdGlvbnM/LnRpbWVvdXQgPz8gRHVyYXRpb24uc2Vjb25kcygxMCksXG4gICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICBTM19TT1VSQ0VfQlVDS0VUOiBidWNrZXQuYnVja2V0TmFtZSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICB0aGlzLmJ1Y2tldCA9IGJ1Y2tldDtcbiAgICB0aGlzLmFkZFBvbGljeSgpO1xuXG4gICAgZnMucm1TeW5jKG1vZHVsZXNQYXRoLCB7IHJlY3Vyc2l2ZTogdHJ1ZSwgZm9yY2U6IHRydWUgfSk7XG4gIH1cblxuICAvKipcbiAgICogQWRkcyBwb2xpY3kgc3RhdGVtZW50IHRvIGdpdmUgR2V0T2JqZWN0IHBlcm1pc3Npb24gSW1hZ2UgT3B0aW1pemF0aW9uIGxhbWJkYS5cbiAgICovXG4gIHByaXZhdGUgYWRkUG9saWN5KCk6IHZvaWQge1xuICAgIGNvbnN0IHBvbGljeVN0YXRlbWVudCA9IG5ldyBQb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgYWN0aW9uczogWydzMzpHZXRPYmplY3QnXSxcbiAgICAgIHJlc291cmNlczogW3RoaXMuYnVja2V0LmFybkZvck9iamVjdHMoJyonKV0sXG4gICAgfSk7XG5cbiAgICB0aGlzLnJvbGU/LmF0dGFjaElubGluZVBvbGljeShcbiAgICAgIG5ldyBQb2xpY3kodGhpcywgJ2dldC1pbWFnZS1wb2xpY3knLCB7XG4gICAgICAgIHN0YXRlbWVudHM6IFtwb2xpY3lTdGF0ZW1lbnRdLFxuICAgICAgfSlcbiAgICApO1xuICB9XG59XG4iXX0=