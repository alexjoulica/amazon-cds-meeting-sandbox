"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getS3ReplaceValues = exports.NextjsS3EnvRewriter = exports.replaceTokenGlobs = void 0;
const path = require("path");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const iam = require("aws-cdk-lib/aws-iam");
const lambda = require("aws-cdk-lib/aws-lambda");
const aws_s3_1 = require("aws-cdk-lib/aws-s3");
const cr = require("aws-cdk-lib/custom-resources");
const constructs_1 = require("constructs");
const BundleFunction_1 = require("./BundleFunction");
const constants_1 = require("./constants");
const NextjsBuild_1 = require("./NextjsBuild");
// files to rewrite CloudFormation tokens in environment variables
exports.replaceTokenGlobs = ['**/*.html', '**/*.js', '**/*.cjs', '**/*.mjs', '**/*.json'];
/**
 * Rewrites variables in S3 objects after a deployment happens to
 * replace CloudFormation tokens with their values.
 * These values are not resolved at build time because they are
 * only known at deploy time.
 */
class NextjsS3EnvRewriter extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const { s3Bucket, s3keys, replacementConfig, nextBuild, debug, cloudfrontDistributionId } = props;
        if (s3keys.length === 0)
            return;
        const app = aws_cdk_lib_1.App.of(this);
        // create a custom resource to find and replace tokenized strings in static files
        // must happen after deployment when tokens can be resolved
        // compile function
        const inputPath = path.resolve(__dirname, '../assets/lambda/S3EnvRewriter.ts');
        const outputPath = path.join(nextBuild.tempBuildDir, 'deployment-scripts', 'S3EnvRewriter.cjs');
        const handlerDir = BundleFunction_1.bundleFunction({
            inputPath,
            outputPath,
            bundleOptions: {
                bundle: true,
                sourcemap: true,
                external: ['aws-sdk'],
                target: 'node16',
                platform: 'node',
                format: 'cjs',
            },
        });
        // rewriter lambda function
        const rewriteFn = new lambda.Function(this, 'RewriteOnEventHandler', {
            runtime: constants_1.LAMBDA_RUNTIME,
            memorySize: 1024,
            timeout: aws_cdk_lib_1.Duration.minutes(5),
            handler: 'S3EnvRewriter.handler',
            code: lambda.Code.fromAsset(handlerDir),
            initialPolicy: [
                new iam.PolicyStatement({
                    actions: ['s3:GetObject', 's3:PutObject'],
                    resources: [s3Bucket.arnForObjects('*')],
                }),
                ...(cloudfrontDistributionId
                    ? [
                        new iam.PolicyStatement({
                            actions: ['cloudfront:CreateInvalidation'],
                            resources: [`arn:aws:cloudfront::${app.account}:distribution/${cloudfrontDistributionId}`],
                        }),
                    ]
                    : []),
            ],
        });
        // grant permission to read env var config if provided
        if (replacementConfig.jsonS3Bucket && replacementConfig.jsonS3Key) {
            const bucket = typeof replacementConfig.jsonS3Bucket === 'string'
                ? aws_s3_1.Bucket.fromBucketName(this, 'EnvConfigBucket', replacementConfig.jsonS3Bucket)
                : replacementConfig.jsonS3Bucket;
            rewriteFn.addToRolePolicy(new iam.PolicyStatement({
                actions: ['s3:GetObject'],
                resources: [bucket.arnForObjects(replacementConfig.jsonS3Key)],
            }));
        }
        // custom resource to run the rewriter after files are copied and we can resolve token values
        const provider = new cr.Provider(this, 'RewriteStaticProvider', {
            onEventHandler: rewriteFn,
        });
        // params for the rewriter function
        const properties = {
            bucket: s3Bucket.bucketName,
            s3keys,
            replacementConfig: {
                ...replacementConfig,
                jsonS3Bucket: replacementConfig.jsonS3Bucket?.bucketName,
            },
            debug,
            cloudfrontDistributionId,
        };
        new aws_cdk_lib_1.CustomResource(this, 'RewriteStatic', {
            serviceToken: provider.serviceToken,
            properties,
        });
    }
}
exports.NextjsS3EnvRewriter = NextjsS3EnvRewriter;
// inline env vars for client and server code
// these are values to replace in built code after it's deployed to S3/lambda
function getS3ReplaceValues(environment, publicOnly) {
    const replacements = {};
    Object.entries(environment || {})
        .filter(([, value]) => aws_cdk_lib_1.Token.isUnresolved(value))
        .filter(([key]) => !publicOnly || key.startsWith('NEXT_PUBLIC_')) // don't replace server-only env vars
        .forEach(([key, value]) => {
        const token = NextjsBuild_1.makeTokenPlaceholder(key);
        replacements[token] = value.toString();
    });
    return replacements;
}
exports.getS3ReplaceValues = getS3ReplaceValues;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTmV4dGpzUzNFbnZSZXdyaXRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9OZXh0anNTM0VudlJld3JpdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDZCQUE2QjtBQUM3Qiw2Q0FBbUU7QUFDbkUsMkNBQTJDO0FBQzNDLGlEQUFpRDtBQUNqRCwrQ0FBcUQ7QUFDckQsbURBQW1EO0FBQ25ELDJDQUF1QztBQUN2QyxxREFBa0Q7QUFDbEQsMkNBQTZDO0FBRTdDLCtDQUFrRTtBQUVsRSxrRUFBa0U7QUFDckQsUUFBQSxpQkFBaUIsR0FBRyxDQUFDLFdBQVcsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxXQUFXLENBQUMsQ0FBQztBQW1CL0Y7Ozs7O0dBS0c7QUFDSCxNQUFhLG1CQUFvQixTQUFRLHNCQUFTO0lBQ2hELFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBK0I7UUFDdkUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixNQUFNLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLHdCQUF3QixFQUFFLEdBQUcsS0FBSyxDQUFDO1FBRWxHLElBQUksTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDO1lBQUUsT0FBTztRQUVoQyxNQUFNLEdBQUcsR0FBRyxpQkFBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQVEsQ0FBQztRQUVoQyxpRkFBaUY7UUFDakYsMkRBQTJEO1FBQzNELG1CQUFtQjtRQUNuQixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxtQ0FBbUMsQ0FBQyxDQUFDO1FBQy9FLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksRUFBRSxvQkFBb0IsRUFBRSxtQkFBbUIsQ0FBQyxDQUFDO1FBQ2hHLE1BQU0sVUFBVSxHQUFHLCtCQUFj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QUVoRCxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVcsSUFBSSxFQUFFLENBQUM7U0FDOUIsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FBQyxtQkFBSyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNoRCxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLFVBQVUsSUFBSSxHQUFHLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMscUNBQXFDO1NBQ3RHLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxFQUFFLEVBQUU7UUFDeEIsTUFBTSxLQUFLLEdBQUcsa0NBQW9CLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDeEMsWUFBWSxDQUFDLEtBQUssQ0FBQyxHQUFHLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUN6QyxDQUFDLENBQUMsQ0FBQztJQUVMLE9BQU8sWUFBWSxDQUFDO0FBQ3RCLENBQUM7QUFaRCxnREFZQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBBcHAsIEN1c3RvbVJlc291cmNlLCBEdXJhdGlvbiwgVG9rZW4gfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSc7XG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBCdWNrZXQsIElCdWNrZXQgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtczMnO1xuaW1wb3J0ICogYXMgY3IgZnJvbSAnYXdzLWNkay1saWIvY3VzdG9tLXJlc291cmNlcyc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IGJ1bmRsZUZ1bmN0aW9uIH0gZnJvbSAnLi9CdW5kbGVGdW5jdGlvbic7XG5pbXBvcnQgeyBMQU1CREFfUlVOVElNRSB9IGZyb20gJy4vY29uc3RhbnRzJztcbmltcG9ydCB7IE5leHRqc0Jhc2VQcm9wcyB9IGZyb20gJy4vTmV4dGpzQmFzZSc7XG5pbXBvcnQgeyBtYWtlVG9rZW5QbGFjZWhvbGRlciwgTmV4dGpzQnVpbGQgfSBmcm9tICcuL05leHRqc0J1aWxkJztcblxuLy8gZmlsZXMgdG8gcmV3cml0ZSBDbG91ZEZvcm1hdGlvbiB0b2tlbnMgaW4gZW52aXJvbm1lbnQgdmFyaWFibGVzXG5leHBvcnQgY29uc3QgcmVwbGFjZVRva2VuR2xvYnMgPSBbJyoqLyouaHRtbCcsICcqKi8qLmpzJywgJyoqLyouY2pzJywgJyoqLyoubWpzJywgJyoqLyouanNvbiddO1xuXG5leHBvcnQgaW50ZXJmYWNlIFJld3JpdGVSZXBsYWNlbWVudHNDb25maWcge1xuICByZWFkb25seSBlbnY/OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+OyAvLyByZXBsYWNlIGtleXMgd2l0aCB2YWx1ZXMgaW4gZmlsZXNcbiAgcmVhZG9ubHkganNvblMzQnVja2V0PzogSUJ1Y2tldDtcbiAgcmVhZG9ubHkganNvblMzS2V5Pzogc3RyaW5nO1xufVxuZXhwb3J0IGludGVyZmFjZSBSZXdyaXRlclBhcmFtcyB7XG4gIHJlYWRvbmx5IHMzQnVja2V0OiBJQnVja2V0O1xuICByZWFkb25seSBzM2tleXM6IHN0cmluZ1tdOyAvLyBmaWxlcyB0byByZXdyaXRlXG4gIHJlYWRvbmx5IHJlcGxhY2VtZW50Q29uZmlnOiBSZXdyaXRlUmVwbGFjZW1lbnRzQ29uZmlnO1xuICByZWFkb25seSBkZWJ1Zz86IGJvb2xlYW47XG4gIHJlYWRvbmx5IGNsb3VkZnJvbnREaXN0cmlidXRpb25JZD86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBOZXh0anNTM0VudlJld3JpdGVyUHJvcHMgZXh0ZW5kcyBOZXh0anNCYXNlUHJvcHMsIFJld3JpdGVyUGFyYW1zIHtcbiAgcmVhZG9ubHkgbmV4dEJ1aWxkOiBOZXh0anNCdWlsZDtcbn1cblxuLyoqXG4gKiBSZXdyaXRlcyB2YXJpYWJsZXMgaW4gUzMgb2JqZWN0cyBhZnRlciBhIGRlcGxveW1lbnQgaGFwcGVucyB0b1xuICogcmVwbGFjZSBDbG91ZEZvcm1hdGlvbiB0b2tlbnMgd2l0aCB0aGVpciB2YWx1ZXMuXG4gKiBUaGVzZSB2YWx1ZXMgYXJlIG5vdCByZXNvbHZlZCBhdCBidWlsZCB0aW1lIGJlY2F1c2UgdGhleSBhcmVcbiAqIG9ubHkga25vd24gYXQgZGVwbG95IHRpbWUuXG4gKi9cbmV4cG9ydCBjbGFzcyBOZXh0anNTM0VudlJld3JpdGVyIGV4dGVuZHMgQ29uc3RydWN0IHtcbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IE5leHRqc1MzRW52UmV3cml0ZXJQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICBjb25zdCB7IHMzQnVja2V0LCBzM2tleXMsIHJlcGxhY2VtZW50Q29uZmlnLCBuZXh0QnVpbGQsIGRlYnVnLCBjbG91ZGZyb250RGlzdHJpYnV0aW9uSWQgfSA9IHByb3BzO1xuXG4gICAgaWYgKHMza2V5cy5sZW5ndGggPT09IDApIHJldHVybjtcblxuICAgIGNvbnN0IGFwcCA9IEFwcC5vZih0aGlzKSBhcyBBcHA7XG5cbiAgICAvLyBjcmVhdGUgYSBjdXN0b20gcmVzb3VyY2UgdG8gZmluZCBhbmQgcmVwbGFjZSB0b2tlbml6ZWQgc3RyaW5ncyBpbiBzdGF0aWMgZmlsZXNcbiAgICAvLyBtdXN0IGhhcHBlbiBhZnRlciBkZXBsb3ltZW50IHdoZW4gdG9rZW5zIGNhbiBiZSByZXNvbHZlZFxuICAgIC8vIGNvbXBpbGUgZnVuY3Rpb25cbiAgICBjb25zdCBpbnB1dFBhdGggPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vYXNzZXRzL2xhbWJkYS9TM0VudlJld3JpdGVyLnRzJyk7XG4gICAgY29uc3Qgb3V0cHV0UGF0aCA9IHBhdGguam9pbihuZXh0QnVpbGQudGVtcEJ1aWxkRGlyLCAnZGVwbG95bWVudC1zY3JpcHRzJywgJ1MzRW52UmV3cml0ZXIuY2pzJyk7XG4gICAgY29uc3QgaGFuZGxlckRpciA9IGJ1bmRsZUZ1bmN0aW9uKHtcbiAgICAgIGlucHV0UGF0aCxcbiAgICAgIG91dHB1dFBhdGgsXG4gICAgICBidW5kbGVPcHRpb25zOiB7XG4gICAgICAgIGJ1bmRsZTogdHJ1ZSxcbiAgICAgICAgc291cmNlbWFwOiB0cnVlLFxuICAgICAgICBleHRlcm5hbDogWydhd3Mtc2RrJ10sXG4gICAgICAgIHRhcmdldDogJ25vZGUxNicsXG4gICAgICAgIHBsYXRmb3JtOiAnbm9kZScsXG4gICAgICAgIGZvcm1hdDogJ2NqcycsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gcmV3cml0ZXIgbGFtYmRhIGZ1bmN0aW9uXG4gICAgY29uc3QgcmV3cml0ZUZuID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCAnUmV3cml0ZU9uRXZlbnRIYW5kbGVyJywge1xuICAgICAgcnVudGltZTogTEFNQkRBX1JVTlRJTUUsXG4gICAgICBtZW1vcnlTaXplOiAxMDI0LFxuICAgICAgdGltZW91dDogRHVyYXRpb24ubWludXRlcyg1KSxcbiAgICAgIGhhbmRsZXI6ICdTM0VudlJld3JpdGVyLmhhbmRsZXInLFxuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KGhhbmRsZXJEaXIpLFxuICAgICAgaW5pdGlhbFBvbGljeTogW1xuICAgICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgYWN0aW9uczogWydzMzpHZXRPYmplY3QnLCAnczM6UHV0T2JqZWN0J10sXG4gICAgICAgICAgcmVzb3VyY2VzOiBbczNCdWNrZXQuYXJuRm9yT2JqZWN0cygnKicpXSxcbiAgICAgICAgfSksXG4gICAgICAgIC4uLihjbG91ZGZyb250RGlzdHJpYnV0aW9uSWRcbiAgICAgICAgICA/IFtcbiAgICAgICAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgICAgIGFjdGlvbnM6IFsnY2xvdWRmcm9udDpDcmVhdGVJbnZhbGlkYXRpb24nXSxcbiAgICAgICAgICAgICAgICByZXNvdXJjZXM6IFtgYXJuOmF3czpjbG91ZGZyb250Ojoke2FwcC5hY2NvdW50fTpkaXN0cmlidXRpb24vJHtjbG91ZGZyb250RGlzdHJpYnV0aW9uSWR9YF0sXG4gICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgXVxuICAgICAgICAgIDogW10pLFxuICAgICAgXSxcbiAgICB9KTtcbiAgICAvLyBncmFudCBwZXJtaXNzaW9uIHRvIHJlYWQgZW52IHZhciBjb25maWcgaWYgcHJvdmlkZWRcbiAgICBpZiAocmVwbGFjZW1lbnRDb25maWcuanNvblMzQnVja2V0ICYmIHJlcGxhY2VtZW50Q29uZmlnLmpzb25TM0tleSkge1xuICAgICAgY29uc3QgYnVja2V0OiBJQnVja2V0ID1cbiAgICAgICAgdHlwZW9mIHJlcGxhY2VtZW50Q29uZmlnLmpzb25TM0J1Y2tldCA9PT0gJ3N0cmluZydcbiAgICAgICAgICA/IEJ1Y2tldC5mcm9tQnVja2V0TmFtZSh0aGlzLCAnRW52Q29uZmlnQnVja2V0JywgcmVwbGFjZW1lbnRDb25maWcuanNvblMzQnVja2V0KVxuICAgICAgICAgIDogcmVwbGFjZW1lbnRDb25maWcuanNvblMzQnVja2V0O1xuICAgICAgcmV3cml0ZUZuLmFkZFRvUm9sZVBvbGljeShcbiAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgIGFjdGlvbnM6IFsnczM6R2V0T2JqZWN0J10sXG4gICAgICAgICAgcmVzb3VyY2VzOiBbYnVja2V0LmFybkZvck9iamVjdHMocmVwbGFjZW1lbnRDb25maWcuanNvblMzS2V5KV0sXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIGN1c3RvbSByZXNvdXJjZSB0byBydW4gdGhlIHJld3JpdGVyIGFmdGVyIGZpbGVzIGFyZSBjb3BpZWQgYW5kIHdlIGNhbiByZXNvbHZlIHRva2VuIHZhbHVlc1xuICAgIGNvbnN0IHByb3ZpZGVyID0gbmV3IGNyLlByb3ZpZGVyKHRoaXMsICdSZXdyaXRlU3RhdGljUHJvdmlkZXInLCB7XG4gICAgICBvbkV2ZW50SGFuZGxlcjogcmV3cml0ZUZuLFxuICAgIH0pO1xuICAgIC8vIHBhcmFtcyBmb3IgdGhlIHJld3JpdGVyIGZ1bmN0aW9uXG4gICAgY29uc3QgcHJvcGVydGllcyA9IHtcbiAgICAgIGJ1Y2tldDogczNCdWNrZXQuYnVja2V0TmFtZSxcbiAgICAgIHMza2V5cyxcbiAgICAgIHJlcGxhY2VtZW50Q29uZmlnOiB7XG4gICAgICAgIC4uLnJlcGxhY2VtZW50Q29uZmlnLFxuICAgICAgICBqc29uUzNCdWNrZXQ6IHJlcGxhY2VtZW50Q29uZmlnLmpzb25TM0J1Y2tldD8uYnVja2V0TmFtZSxcbiAgICAgIH0sXG4gICAgICBkZWJ1ZyxcbiAgICAgIGNsb3VkZnJvbnREaXN0cmlidXRpb25JZCxcbiAgICB9O1xuICAgIG5ldyBDdXN0b21SZXNvdXJjZSh0aGlzLCAnUmV3cml0ZVN0YXRpYycsIHtcbiAgICAgIHNlcnZpY2VUb2tlbjogcHJvdmlkZXIuc2VydmljZVRva2VuLFxuICAgICAgcHJvcGVydGllcyxcbiAgICB9KTtcbiAgfVxufVxuXG4vLyBpbmxpbmUgZW52IHZhcnMgZm9yIGNsaWVudCBhbmQgc2VydmVyIGNvZGVcbi8vIHRoZXNlIGFyZSB2YWx1ZXMgdG8gcmVwbGFjZSBpbiBidWlsdCBjb2RlIGFmdGVyIGl0J3MgZGVwbG95ZWQgdG8gUzMvbGFtYmRhXG5leHBvcnQgZnVuY3Rpb24gZ2V0UzNSZXBsYWNlVmFsdWVzKGVudmlyb25tZW50OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+LCBwdWJsaWNPbmx5OiBib29sZWFuKTogUmVjb3JkPHN0cmluZywgc3RyaW5nPiB7XG4gIGNvbnN0IHJlcGxhY2VtZW50czogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9O1xuXG4gIE9iamVjdC5lbnRyaWVzKGVudmlyb25tZW50IHx8IHt9KVxuICAgIC5maWx0ZXIoKFssIHZhbHVlXSkgPT4gVG9rZW4uaXNVbnJlc29sdmVkKHZhbHVlKSlcbiAgICAuZmlsdGVyKChba2V5XSkgPT4gIXB1YmxpY09ubHkgfHwga2V5LnN0YXJ0c1dpdGgoJ05FWFRfUFVCTElDXycpKSAvLyBkb24ndCByZXBsYWNlIHNlcnZlci1vbmx5IGVudiB2YXJzXG4gICAgLmZvckVhY2goKFtrZXksIHZhbHVlXSkgPT4ge1xuICAgICAgY29uc3QgdG9rZW4gPSBtYWtlVG9rZW5QbGFjZWhvbGRlcihrZXkpO1xuICAgICAgcmVwbGFjZW1lbnRzW3Rva2VuXSA9IHZhbHVlLnRvU3RyaW5nKCk7XG4gICAgfSk7XG5cbiAgcmV0dXJuIHJlcGxhY2VtZW50cztcbn1cbiJdfQ==