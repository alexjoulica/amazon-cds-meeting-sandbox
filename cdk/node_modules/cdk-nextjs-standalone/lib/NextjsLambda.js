"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.NextJsLambda = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const os = require("os");
const path = require("path");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const lambda = require("aws-cdk-lib/aws-lambda");
const aws_lambda_1 = require("aws-cdk-lib/aws-lambda");
const aws_s3_1 = require("aws-cdk-lib/aws-s3");
const s3Assets = require("aws-cdk-lib/aws-s3-assets");
const aws_s3_deployment_1 = require("aws-cdk-lib/aws-s3-deployment");
const aws_ssm_1 = require("aws-cdk-lib/aws-ssm");
const constructs_1 = require("constructs");
const fs = require("fs-extra");
const BundleFunction_1 = require("./BundleFunction");
const constants_1 = require("./constants");
const Nextjs_1 = require("./Nextjs");
const NextjsBuild_1 = require("./NextjsBuild");
const NextjsS3EnvRewriter_1 = require("./NextjsS3EnvRewriter");
function getEnvironment(props) {
    const environmentVariables = {
        ...props.environment,
        ...props.lambda?.environment,
        ...(props.nodeEnv ? { NODE_ENV: props.nodeEnv } : {}),
    };
    return environmentVariables;
}
/**
 * Build a lambda function from a NextJS application to handle server-side rendering, API routes, and image optimization.
 */
class NextJsLambda extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const { nextBuild, lambda: functionOptions, isPlaceholder } = props;
        // bundle server handler
        // delete default nextjs handler if it exists
        const defaultServerPath = path.join(nextBuild.nextStandaloneDir, 'server.js');
        if (fs.existsSync(defaultServerPath)) {
            fs.unlinkSync(defaultServerPath);
        }
        // build our server handler in build.nextStandaloneDir
        const serverHandler = path.resolve(__dirname, '../assets/lambda/NextJsHandler.ts');
        // server should live in the same dir as the nextjs app to access deps properly
        const serverPath = path.join(nextBuild.nextStandaloneDir, 'server.js');
        BundleFunction_1.bundleFunction({
            inputPath: serverHandler,
            outputPath: serverPath,
            bundleOptions: {
                bundle: true,
                minify: false,
                sourcemap: true,
                target: 'node16',
                platform: 'node',
                external: ['next', 'aws-sdk'],
                format: 'cjs',
            },
        });
        // zip up the standalone directory
        const zipOutDir = path.resolve(props.tempBuildDir
            ? path.resolve(path.join(props.tempBuildDir, `standalone`))
            : fs.mkdtempSync(path.join(os.tmpdir(), 'standalone-')));
        const zipFilePath = NextjsBuild_1.createArchive({
            directory: nextBuild.standaloneDir,
            zipFileName: 'standalone.zip',
            zipOutDir,
            fileGlob: '*',
            quiet: props.quiet,
        });
        if (!zipFilePath)
            throw new Error('Failed to create archive for lambda function code');
        // upload the lambda package to S3
        const s3asset = new s3Assets.Asset(scope, 'MainFnAsset', { path: zipFilePath });
        const code = isPlaceholder
            ? lambda.Code.fromInline("module.exports.handler = async () => { return { statusCode: 200, body: 'SST placeholder site' } }")
            : lambda.Code.fromBucket(s3asset.bucket, s3asset.s3ObjectKey);
        // build the lambda function
        const environment = getEnvironment(props);
        const fn = new aws_lambda_1.Function(scope, 'ServerHandler', {
            memorySize: functionOptions?.memorySize || 1024,
            timeout: functionOptions?.timeout ?? aws_cdk_lib_1.Duration.seconds(10),
            runtime: constants_1.LAMBDA_RUNTIME,
            handler: path.join(nextBuild.nextDirRelative, 'server.handler'),
            code,
            environment,
            ...functionOptions,
        });
        this.lambdaFunction = fn;
        // rewrite env var placeholders in server code
        const replacementParams = this._getReplacementParams(environment);
        if (!isPlaceholder && Object.keys(replacementParams).length) {
            // put JSON file with env var replacements in S3
            const [configBucket, configDeployment] = this.createConfigBucket(replacementParams);
            this.configBucket = configBucket;
            // replace env var placeholders in the lambda package with resolved values
            const rewriter = new NextjsS3EnvRewriter_1.NextjsS3EnvRewriter(this, 'LambdaCodeRewriter', {
                ...props,
                s3Bucket: s3asset.bucket,
                s3keys: [s3asset.s3ObjectKey],
                replacementConfig: {
                    // use json file in S3 for replacement values
                    // this can contain backend secrets so better to not have them in custom resource logs
                    jsonS3Bucket: configDeployment.deployedBucket,
                    jsonS3Key: Nextjs_1.CONFIG_ENV_JSON_PATH,
                },
                debug: true,
            });
            rewriter.node.addDependency(s3asset);
            // in order to create this dependency, the lambda function needs to be a child of the current construct
            // meaning we can't inherit from Function
            fn.node.addDependency(rewriter); // don't deploy lambda until rewriter is done - we are sort of 'intercepting' the deployment package
        }
    }
    _getReplacementParams(env) {
        const replacements = NextjsS3EnvRewriter_1.getS3ReplaceValues(env, false); // get placeholder => replacement values
        const replacementParams = {}; // JSON file with replacements to be uploaded to S3
        Object.entries(replacements).forEach(([key, value]) => {
            // is it a token?
            if (typeof value === 'undefined')
                return;
            if (!value || !aws_cdk_lib_1.Token.isUnresolved(value)) {
                replacementParams[key] = value;
                return;
            }
            // create param
            const param = new aws_ssm_1.StringParameter(this, `Config('${key}')`, {
                stringValue: value,
            });
            // add to env JSON
            replacementParams[key] = param.stringValue;
        });
        return replacementParams;
    }
    // this can hold our resolved environment vars for the server
    createConfigBucket(replacementParams) {
        // won't work until this is fixed: https://github.com/aws/aws-cdk/issues/19257
        const bucket = new aws_s3_1.Bucket(this, 'NextjsConfigBucket', {
            removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY,
            autoDeleteObjects: true,
        });
        // upload environment config to s3
        const deployment = new aws_s3_deployment_1.BucketDeployment(this, 'EnvJsonDeployment', {
            sources: [
                // serialize as JSON to S3 object
                aws_s3_deployment_1.Source.jsonData(Nextjs_1.CONFIG_ENV_JSON_PATH, replacementParams),
            ],
            destinationBucket: bucket,
        });
        return [bucket, deployment];
    }
}
exports.NextJsLambda = NextJsLambda;
_a = JSII_RTTI_SYMBOL_1;
NextJsLambda[_a] = { fqn: "cdk-nextjs-standalone.NextJsLambda", version: "2.0.3" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTmV4dGpzTGFtYmRhLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL05leHRqc0xhbWJkYS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLHlCQUF5QjtBQUN6Qiw2QkFBNkI7QUFDN0IsNkNBQTZEO0FBQzdELGlEQUFpRDtBQUNqRCx1REFBbUU7QUFDbkUsK0NBQTRDO0FBQzVDLHNEQUFzRDtBQUN0RCxxRUFBeUU7QUFDekUsaURBQXNEO0FBQ3RELDJDQUF1QztBQUN2QywrQkFBK0I7QUFDL0IscURBQWtEO0FBQ2xELDJDQUE2QztBQUM3QyxxQ0FBZ0Q7QUFFaEQsK0NBQTJEO0FBQzNELCtEQUFnRjtBQUloRixTQUFTLGNBQWMsQ0FBQyxLQUF3QjtJQUM5QyxNQUFNLG9CQUFvQixHQUErQjtRQUN2RCxHQUFHLEtBQUssQ0FBQyxXQUFXO1FBQ3BCLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxXQUFXO1FBQzVCLEdBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztLQUN0RCxDQUFDO0lBRUYsT0FBTyxvQkFBb0IsQ0FBQztBQUM5QixDQUFDO0FBY0Q7O0dBRUc7QUFDSCxNQUFhLFlBQWEsU0FBUSxzQkFBUztJQUl6QyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQXdCO1FBQ2hFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDakIsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsZUFBZSxFQUFFLGFBQWEsRUFBRSxHQUFHLEtBQUssQ0FBQztRQUNwRSx3QkFBd0I7UUFDeEIsNkNBQTZDO1FBQzdDLE1BQU0saUJBQWlCLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsaUJBQWlCLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFDOUUsSUFBSSxFQUFFLENB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QUssS0FBSyxXQUFXO2dCQUFFLE9BQU87WUFDekMsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLG1CQUFLLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxFQUFFO2dCQUN4QyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUM7Z0JBQy9CLE9BQU87YUFDUjtZQUVELGVBQWU7WUFDZixNQUFNLEtBQUssR0FBRyxJQUFJLHlCQUFlLENBQUMsSUFBSSxFQUFFLFdBQVcsR0FBRyxJQUFJLEVBQUU7Z0JBQzFELFdBQVcsRUFBRSxLQUFLO2FBQ25CLENBQUMsQ0FBQztZQUVILGtCQUFrQjtZQUNsQixpQkFBaUIsQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUMsV0FBVyxDQUFDO1FBQzdDLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxpQkFBaUIsQ0FBQztJQUMzQixDQUFDO0lBRUQsNkRBQTZEO0lBQ25ELGtCQUFrQixDQUFDLGlCQUF5QztRQUNwRSw4RUFBOEU7UUFDOUUsTUFBTSxNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsSUFBSSxFQUFFLG9CQUFvQixFQUFFO1lBQ3BELGFBQWEsRUFBRSwyQkFBYSxDQUFDLE9BQU87WUFDcEMsaUJBQWlCLEVBQUUsSUFBSTtTQUN4QixDQUFDLENBQUM7UUFFSCxrQ0FBa0M7UUFDbEMsTUFBTSxVQUFVLEdBQUcsSUFBSSxvQ0FBZ0IsQ0FBQyxJQUFJLEVBQUUsbUJBQW1CLEVBQUU7WUFDakUsT0FBTyxFQUFFO2dCQUNQLGlDQUFpQztnQkFDakMsMEJBQU0sQ0FBQyxRQUFRLENBQUMsNkJBQW9CLEVBQUUsaUJBQWlCLENBQUM7YUFDekQ7WUFDRCxpQkFBaUIsRUFBRSxNQUFNO1NBQzFCLENBQUMsQ0FBQztRQUNILE9BQU8sQ0FBQyxNQUFNLEVBQUUsVUFBVSxDQUFVLENBQUM7SUFDdkMsQ0FBQzs7QUF4SUgsb0NBeUlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgb3MgZnJvbSAnb3MnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IER1cmF0aW9uLCBSZW1vdmFsUG9saWN5LCBUb2tlbiB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhJztcbmltcG9ydCB7IEZ1bmN0aW9uLCBGdW5jdGlvbk9wdGlvbnMgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhJztcbmltcG9ydCB7IEJ1Y2tldCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1zMyc7XG5pbXBvcnQgKiBhcyBzM0Fzc2V0cyBmcm9tICdhd3MtY2RrLWxpYi9hd3MtczMtYXNzZXRzJztcbmltcG9ydCB7IEJ1Y2tldERlcGxveW1lbnQsIFNvdXJjZSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1zMy1kZXBsb3ltZW50JztcbmltcG9ydCB7IFN0cmluZ1BhcmFtZXRlciB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1zc20nO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgeyBidW5kbGVGdW5jdGlvbiB9IGZyb20gJy4vQnVuZGxlRnVuY3Rpb24nO1xuaW1wb3J0IHsgTEFNQkRBX1JVTlRJTUUgfSBmcm9tICcuL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBDT05GSUdfRU5WX0pTT05fUEFUSCB9IGZyb20gJy4vTmV4dGpzJztcbmltcG9ydCB7IE5leHRqc0Jhc2VQcm9wcyB9IGZyb20gJy4vTmV4dGpzQmFzZSc7XG5pbXBvcnQgeyBjcmVhdGVBcmNoaXZlLCBOZXh0anNCdWlsZCB9IGZyb20gJy4vTmV4dGpzQnVpbGQnO1xuaW1wb3J0IHsgZ2V0UzNSZXBsYWNlVmFsdWVzLCBOZXh0anNTM0VudlJld3JpdGVyIH0gZnJvbSAnLi9OZXh0anNTM0VudlJld3JpdGVyJztcblxuZXhwb3J0IHR5cGUgRW52aXJvbm1lbnRWYXJzID0gUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcblxuZnVuY3Rpb24gZ2V0RW52aXJvbm1lbnQocHJvcHM6IE5leHRqc0xhbWJkYVByb3BzKTogeyBbbmFtZTogc3RyaW5nXTogc3RyaW5nIH0ge1xuICBjb25zdCBlbnZpcm9ubWVudFZhcmlhYmxlczogeyBbbmFtZTogc3RyaW5nXTogc3RyaW5nIH0gPSB7XG4gICAgLi4ucHJvcHMuZW52aXJvbm1lbnQsXG4gICAgLi4ucHJvcHMubGFtYmRhPy5lbnZpcm9ubWVudCxcbiAgICAuLi4ocHJvcHMubm9kZUVudiA/IHsgTk9ERV9FTlY6IHByb3BzLm5vZGVFbnYgfSA6IHt9KSxcbiAgfTtcblxuICByZXR1cm4gZW52aXJvbm1lbnRWYXJpYWJsZXM7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgTmV4dGpzTGFtYmRhUHJvcHMgZXh0ZW5kcyBOZXh0anNCYXNlUHJvcHMge1xuICAvKipcbiAgICogQnVpbHQgbmV4dEpTIGFwcGxpY2F0aW9uLlxuICAgKi9cbiAgcmVhZG9ubHkgbmV4dEJ1aWxkOiBOZXh0anNCdWlsZDtcblxuICAvKipcbiAgICogT3ZlcnJpZGUgZnVuY3Rpb24gcHJvcGVydGllcy5cbiAgICovXG4gIHJlYWRvbmx5IGxhbWJkYT86IEZ1bmN0aW9uT3B0aW9ucztcbn1cblxuLyoqXG4gKiBCdWlsZCBhIGxhbWJkYSBmdW5jdGlvbiBmcm9tIGEgTmV4dEpTIGFwcGxpY2F0aW9uIHRvIGhhbmRsZSBzZXJ2ZXItc2lkZSByZW5kZXJpbmcsIEFQSSByb3V0ZXMsIGFuZCBpbWFnZSBvcHRpbWl6YXRpb24uXG4gKi9cbmV4cG9ydCBjbGFzcyBOZXh0SnNMYW1iZGEgZXh0ZW5kcyBDb25zdHJ1Y3Qge1xuICBjb25maWdCdWNrZXQ/OiBCdWNrZXQ7XG4gIGxhbWJkYUZ1bmN0aW9uOiBGdW5jdGlvbjtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogTmV4dGpzTGFtYmRhUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuICAgIGNvbnN0IHsgbmV4dEJ1aWxkLCBsYW1iZGE6IGZ1bmN0aW9uT3B0aW9ucywgaXNQbGFjZWhvbGRlciB9ID0gcHJvcHM7XG4gICAgLy8gYnVuZGxlIHNlcnZlciBoYW5kbGVyXG4gICAgLy8gZGVsZXRlIGRlZmF1bHQgbmV4dGpzIGhhbmRsZXIgaWYgaXQgZXhpc3RzXG4gICAgY29uc3QgZGVmYXVsdFNlcnZlclBhdGggPSBwYXRoLmpvaW4obmV4dEJ1aWxkLm5leHRTdGFuZGFsb25lRGlyLCAnc2VydmVyLmpzJyk7XG4gICAgaWYgKGZzLmV4aXN0c1N5bmMoZGVmYXVsdFNlcnZlclBhdGgpKSB7XG4gICAgICBmcy51bmxpbmtTeW5jKGRlZmF1bHRTZXJ2ZXJQYXRoKTtcbiAgICB9XG5cbiAgICAvLyBidWlsZCBvdXIgc2VydmVyIGhhbmRsZXIgaW4gYnVpbGQubmV4dFN0YW5kYWxvbmVEaXJcbiAgICBjb25zdCBzZXJ2ZXJIYW5kbGVyID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uL2Fzc2V0cy9sYW1iZGEvTmV4dEpzSGFuZGxlci50cycpO1xuICAgIC8vIHNlcnZlciBzaG91bGQgbGl2ZSBpbiB0aGUgc2FtZSBkaXIgYXMgdGhlIG5leHRqcyBhcHAgdG8gYWNjZXNzIGRlcHMgcHJvcGVybHlcbiAgICBjb25zdCBzZXJ2ZXJQYXRoID0gcGF0aC5qb2luKG5leHRCdWlsZC5uZXh0U3RhbmRhbG9uZURpciwgJ3NlcnZlci5qcycpO1xuICAgIGJ1bmRsZUZ1bmN0aW9uKHtcbiAgICAgIGlucHV0UGF0aDogc2VydmVySGFuZGxlcixcbiAgICAgIG91dHB1dFBhdGg6IHNlcnZlclBhdGgsXG4gICAgICBidW5kbGVPcHRpb25zOiB7XG4gICAgICAgIGJ1bmRsZTogdHJ1ZSxcbiAgICAgICAgbWluaWZ5OiBmYWxzZSxcbiAgICAgICAgc291cmNlbWFwOiB0cnVlLFxuICAgICAgICB0YXJnZXQ6ICdub2RlMTYnLFxuICAgICAgICBwbGF0Zm9ybTogJ25vZGUnLFxuICAgICAgICBleHRlcm5hbDogWyduZXh0JywgJ2F3cy1zZGsnXSxcbiAgICAgICAgZm9ybWF0OiAnY2pzJywgLy8gaG9wZSBvbmUgZGF5IHdlIGNhbiB1c2UgZXNtXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gemlwIHVwIHRoZSBzdGFuZGFsb25lIGRpcmVjdG9yeVxuICAgIGNvbnN0IHppcE91dERpciA9IHBhdGgucmVzb2x2ZShcbiAgICAgIHByb3BzLnRlbXBCdWlsZERpclxuICAgICAgICA/IHBhdGgucmVzb2x2ZShwYXRoLmpvaW4ocHJvcHMudGVtcEJ1aWxkRGlyLCBgc3RhbmRhbG9uZWApKVxuICAgICAgICA6IGZzLm1rZHRlbXBTeW5jKHBhdGguam9pbihvcy50bXBkaXIoKSwgJ3N0YW5kYWxvbmUtJykpXG4gICAgKTtcbiAgICBjb25zdCB6aXBGaWxlUGF0aCA9IGNyZWF0ZUFyY2hpdmUoe1xuICAgICAgZGlyZWN0b3J5OiBuZXh0QnVpbGQuc3RhbmRhbG9uZURpcixcbiAgICAgIHppcEZpbGVOYW1lOiAnc3RhbmRhbG9uZS56aXAnLFxuICAgICAgemlwT3V0RGlyLFxuICAgICAgZmlsZUdsb2I6ICcqJyxcbiAgICAgIHF1aWV0OiBwcm9wcy5xdWlldCxcbiAgICB9KTtcbiAgICBpZiAoIXppcEZpbGVQYXRoKSB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBjcmVhdGUgYXJjaGl2ZSBmb3IgbGFtYmRhIGZ1bmN0aW9uIGNvZGUnKTtcblxuICAgIC8vIHVwbG9hZCB0aGUgbGFtYmRhIHBhY2thZ2UgdG8gUzNcbiAgICBjb25zdCBzM2Fzc2V0ID0gbmV3IHMzQXNzZXRzLkFzc2V0KHNjb3BlLCAnTWFpbkZuQXNzZXQnLCB7IHBhdGg6IHppcEZpbGVQYXRoIH0pO1xuICAgIGNvbnN0IGNvZGUgPSBpc1BsYWNlaG9sZGVyXG4gICAgICA/IGxhbWJkYS5Db2RlLmZyb21JbmxpbmUoXG4gICAgICAgICAgXCJtb2R1bGUuZXhwb3J0cy5oYW5kbGVyID0gYXN5bmMgKCkgPT4geyByZXR1cm4geyBzdGF0dXNDb2RlOiAyMDAsIGJvZHk6ICdTU1QgcGxhY2Vob2xkZXIgc2l0ZScgfSB9XCJcbiAgICAgICAgKVxuICAgICAgOiBsYW1iZGEuQ29kZS5mcm9tQnVja2V0KHMzYXNzZXQuYnVja2V0LCBzM2Fzc2V0LnMzT2JqZWN0S2V5KTtcblxuICAgIC8vIGJ1aWxkIHRoZSBsYW1iZGEgZnVuY3Rpb25cbiAgICBjb25zdCBlbnZpcm9ubWVudCA9IGdldEVudmlyb25tZW50KHByb3BzKTtcbiAgICBjb25zdCBmbiA9IG5ldyBGdW5jdGlvbihzY29wZSwgJ1NlcnZlckhhbmRsZXInLCB7XG4gICAgICBtZW1vcnlTaXplOiBmdW5jdGlvbk9wdGlvbnM/Lm1lbW9yeVNpemUgfHwgMTAyNCxcbiAgICAgIHRpbWVvdXQ6IGZ1bmN0aW9uT3B0aW9ucz8udGltZW91dCA/PyBEdXJhdGlvbi5zZWNvbmRzKDEwKSxcbiAgICAgIHJ1bnRpbWU6IExBTUJEQV9SVU5USU1FLFxuICAgICAgaGFuZGxlcjogcGF0aC5qb2luKG5leHRCdWlsZC5uZXh0RGlyUmVsYXRpdmUsICdzZXJ2ZXIuaGFuZGxlcicpLFxuICAgICAgY29kZSxcbiAgICAgIGVudmlyb25tZW50LFxuXG4gICAgICAuLi5mdW5jdGlvbk9wdGlvbnMsXG4gICAgfSk7XG4gICAgdGhpcy5sYW1iZGFGdW5jdGlvbiA9IGZuO1xuXG4gICAgLy8gcmV3cml0ZSBlbnYgdmFyIHBsYWNlaG9sZGVycyBpbiBzZXJ2ZXIgY29kZVxuICAgIGNvbnN0IHJlcGxhY2VtZW50UGFyYW1zID0gdGhpcy5fZ2V0UmVwbGFjZW1lbnRQYXJhbXMoZW52aXJvbm1lbnQpO1xuICAgIGlmICghaXNQbGFjZWhvbGRlciAmJiBPYmplY3Qua2V5cyhyZXBsYWNlbWVudFBhcmFtcykubGVuZ3RoKSB7XG4gICAgICAvLyBwdXQgSlNPTiBmaWxlIHdpdGggZW52IHZhciByZXBsYWNlbWVudHMgaW4gUzNcbiAgICAgIGNvbnN0IFtjb25maWdCdWNrZXQsIGNvbmZpZ0RlcGxveW1lbnRdID0gdGhpcy5jcmVhdGVDb25maWdCdWNrZXQocmVwbGFjZW1lbnRQYXJhbXMpO1xuICAgICAgdGhpcy5jb25maWdCdWNrZXQgPSBjb25maWdCdWNrZXQ7XG5cbiAgICAgIC8vIHJlcGxhY2UgZW52IHZhciBwbGFjZWhvbGRlcnMgaW4gdGhlIGxhbWJkYSBwYWNrYWdlIHdpdGggcmVzb2x2ZWQgdmFsdWVzXG4gICAgICBjb25zdCByZXdyaXRlciA9IG5ldyBOZXh0anNTM0VudlJld3JpdGVyKHRoaXMsICdMYW1iZGFDb2RlUmV3cml0ZXInLCB7XG4gICAgICAgIC4uLnByb3BzLFxuICAgICAgICBzM0J1Y2tldDogczNhc3NldC5idWNrZXQsXG4gICAgICAgIHMza2V5czogW3MzYXNzZXQuczNPYmplY3RLZXldLFxuICAgICAgICByZXBsYWNlbWVudENvbmZpZzoge1xuICAgICAgICAgIC8vIHVzZSBqc29uIGZpbGUgaW4gUzMgZm9yIHJlcGxhY2VtZW50IHZhbHVlc1xuICAgICAgICAgIC8vIHRoaXMgY2FuIGNvbnRhaW4gYmFja2VuZCBzZWNyZXRzIHNvIGJldHRlciB0byBub3QgaGF2ZSB0aGVtIGluIGN1c3RvbSByZXNvdXJjZSBsb2dzXG4gICAgICAgICAganNvblMzQnVja2V0OiBjb25maWdEZXBsb3ltZW50LmRlcGxveWVkQnVja2V0LFxuICAgICAgICAgIGpzb25TM0tleTogQ09ORklHX0VOVl9KU09OX1BBVEgsXG4gICAgICAgIH0sXG4gICAgICAgIGRlYnVnOiB0cnVlLCAvLyBlbmFibGUgZm9yIG1vcmUgdmVyYm9zZSBvdXRwdXQgZnJvbSB0aGUgcmV3cml0ZXIgZnVuY3Rpb25cbiAgICAgIH0pO1xuICAgICAgcmV3cml0ZXIubm9kZS5hZGREZXBlbmRlbmN5KHMzYXNzZXQpO1xuXG4gICAgICAvLyBpbiBvcmRlciB0byBjcmVhdGUgdGhpcyBkZXBlbmRlbmN5LCB0aGUgbGFtYmRhIGZ1bmN0aW9uIG5lZWRzIHRvIGJlIGEgY2hpbGQgb2YgdGhlIGN1cnJlbnQgY29uc3RydWN0XG4gICAgICAvLyBtZWFuaW5nIHdlIGNhbid0IGluaGVyaXQgZnJvbSBGdW5jdGlvblxuICAgICAgZm4ubm9kZS5hZGREZXBlbmRlbmN5KHJld3JpdGVyKTsgLy8gZG9uJ3QgZGVwbG95IGxhbWJkYSB1bnRpbCByZXdyaXRlciBpcyBkb25lIC0gd2UgYXJlIHNvcnQgb2YgJ2ludGVyY2VwdGluZycgdGhlIGRlcGxveW1lbnQgcGFja2FnZVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX2dldFJlcGxhY2VtZW50UGFyYW1zKGVudjogUmVjb3JkPHN0cmluZywgc3RyaW5nPikge1xuICAgIGNvbnN0IHJlcGxhY2VtZW50cyA9IGdldFMzUmVwbGFjZVZhbHVlcyhlbnYsIGZhbHNlKTsgLy8gZ2V0IHBsYWNlaG9sZGVyID0+IHJlcGxhY2VtZW50IHZhbHVlc1xuICAgIGNvbnN0IHJlcGxhY2VtZW50UGFyYW1zOiBFbnZpcm9ubWVudFZhcnMgPSB7fTsgLy8gSlNPTiBmaWxlIHdpdGggcmVwbGFjZW1lbnRzIHRvIGJlIHVwbG9hZGVkIHRvIFMzXG4gICAgT2JqZWN0LmVudHJpZXMocmVwbGFjZW1lbnRzKS5mb3JFYWNoKChba2V5LCB2YWx1ZV0pID0+IHtcbiAgICAgIC8vIGlzIGl0IGEgdG9rZW4/XG4gICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAndW5kZWZpbmVkJykgcmV0dXJuO1xuICAgICAgaWYgKCF2YWx1ZSB8fCAhVG9rZW4uaXNVbnJlc29sdmVkKHZhbHVlKSkge1xuICAgICAgICByZXBsYWNlbWVudFBhcmFtc1trZXldID0gdmFsdWU7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8gY3JlYXRlIHBhcmFtXG4gICAgICBjb25zdCBwYXJhbSA9IG5ldyBTdHJpbmdQYXJhbWV0ZXIodGhpcywgYENvbmZpZygnJHtrZXl9JylgLCB7XG4gICAgICAgIHN0cmluZ1ZhbHVlOiB2YWx1ZSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBhZGQgdG8gZW52IEpTT05cbiAgICAgIHJlcGxhY2VtZW50UGFyYW1zW2tleV0gPSBwYXJhbS5zdHJpbmdWYWx1ZTtcbiAgICB9KTtcbiAgICByZXR1cm4gcmVwbGFjZW1lbnRQYXJhbXM7XG4gIH1cblxuICAvLyB0aGlzIGNhbiBob2xkIG91ciByZXNvbHZlZCBlbnZpcm9ubWVudCB2YXJzIGZvciB0aGUgc2VydmVyXG4gIHByb3RlY3RlZCBjcmVhdGVDb25maWdCdWNrZXQocmVwbGFjZW1lbnRQYXJhbXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4pIHtcbiAgICAvLyB3b24ndCB3b3JrIHVudGlsIHRoaXMgaXMgZml4ZWQ6IGh0dHBzOi8vZ2l0aHViLmNvbS9hd3MvYXdzLWNkay9pc3N1ZXMvMTkyNTdcbiAgICBjb25zdCBidWNrZXQgPSBuZXcgQnVja2V0KHRoaXMsICdOZXh0anNDb25maWdCdWNrZXQnLCB7XG4gICAgICByZW1vdmFsUG9saWN5OiBSZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgICBhdXRvRGVsZXRlT2JqZWN0czogdHJ1ZSxcbiAgICB9KTtcblxuICAgIC8vIHVwbG9hZCBlbnZpcm9ubWVudCBjb25maWcgdG8gczNcbiAgICBjb25zdCBkZXBsb3ltZW50ID0gbmV3IEJ1Y2tldERlcGxveW1lbnQodGhpcywgJ0Vudkpzb25EZXBsb3ltZW50Jywge1xuICAgICAgc291cmNlczogW1xuICAgICAgICAvLyBzZXJpYWxpemUgYXMgSlNPTiB0byBTMyBvYmplY3RcbiAgICAgICAgU291cmNlLmpzb25EYXRhKENPTkZJR19FTlZfSlNPTl9QQVRILCByZXBsYWNlbWVudFBhcmFtcyksXG4gICAgICBdLFxuICAgICAgZGVzdGluYXRpb25CdWNrZXQ6IGJ1Y2tldCxcbiAgICB9KTtcbiAgICByZXR1cm4gW2J1Y2tldCwgZGVwbG95bWVudF0gYXMgY29uc3Q7XG4gIH1cbn1cbiJdfQ==