"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.NextjsDistribution = exports.CONFIG_ENV_JSON_PATH = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const os = require("os");
const path = require("path");
const path_1 = require("path");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const acm = require("aws-cdk-lib/aws-certificatemanager");
const cloudfront = require("aws-cdk-lib/aws-cloudfront");
const aws_cloudfront_1 = require("aws-cdk-lib/aws-cloudfront");
const origins = require("aws-cdk-lib/aws-cloudfront-origins");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const lambda = require("aws-cdk-lib/aws-lambda");
const route53 = require("aws-cdk-lib/aws-route53");
const route53Patterns = require("aws-cdk-lib/aws-route53-patterns");
const route53Targets = require("aws-cdk-lib/aws-route53-targets");
const constructs_1 = require("constructs");
const fs = require("fs-extra");
const BundleFunction_1 = require("./BundleFunction");
const constants_1 = require("./constants");
const NextjsBase_1 = require("./NextjsBase");
// contains server-side resolved environment vars in config bucket
exports.CONFIG_ENV_JSON_PATH = 'next-env.json';
/**
 * Create a CloudFront distribution to serve a Next.js application.
 */
class NextjsDistribution extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        // get dir to store temp build files in
        this.tempBuildDir = props.tempBuildDir
            ? path.resolve(path.join(props.tempBuildDir, `nextjs-cdk-build-${this.node.id}-${this.node.addr.substring(0, 4)}`))
            : fs.mkdtempSync(path.join(os.tmpdir(), 'nextjs-cdk-build-'));
        // save props
        this.props = { ...props, tempBuildDir: this.tempBuildDir };
        // Create Custom Domain
        this.validateCustomDomainSettings();
        this.hostedZone = this.lookupHostedZone();
        this.certificate = this.createCertificate();
        // Create CloudFront
        this.distribution = this.props.isPlaceholder
            ? this.createCloudFrontDistributionForStub()
            : this.createCloudFrontDistribution();
        // Connect Custom Domain to CloudFront Distribution
        this.createRoute53Records();
    }
    /**
     * The CloudFront URL of the website.
     */
    get url() {
        return `https://${this.distribution.distributionDomainName}`;
    }
    /**
     * If the custom domain is enabled, this is the URL of the website with the
     * custom domain.
     */
    get customDomainUrl() {
        const { customDomain } = this.props;
        if (!customDomain) {
            return;
        }
        if (typeof customDomain === 'string') {
            return `https://${customDomain}`;
        }
        else {
            return `https://${customDomain.domainName}`;
        }
    }
    /**
     * The ID of the internally created CloudFront Distribution.
     */
    get distributionId() {
        return this.distribution.distributionId;
    }
    /**
     * The domain name of the internally created CloudFront Distribution.
     */
    get distributionDomain() {
        return this.distribution.distributionDomainName;
    }
    /////////////////////
    // CloudFront Distribution
    /////////////////////
    createCloudFrontDistribution() {
        const { cdk: cdkProps, cachePolicies, lambdaOriginRequestPolicy: lambdaOriginRequestPolicyOverride } = this.props;
        const cfDistributionProps = cdkProps?.distribution;
        // build domainNames
        const domainNames = this.buildDistributionDomainNames();
        // S3 origin
        const s3Origin = new origins.S3Origin(this.props.staticAssetsBucket);
        const viewerProtocolPolicy = cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS;
        // handle placeholder
        if (this.props.isPlaceholder) {
            return new cloudfront.Distribution(this, 'Distribution', {
                defaultRootObject: 'index.html',
                errorResponses: NextjsBase_1.buildErrorResponsesForRedirectToIndex('index.html'),
                domainNames,
                certificate: this.certificate,
                defaultBehavior: {
                    origin: s3Origin,
                    viewerProtocolPolicy,
                },
            });
        }
        // cache policies
        const staticCachePolicy = cachePolicies?.staticCachePolicy ?? this.createCloudFrontStaticCachePolicy();
        const imageCachePolicy = cachePolicies?.imageCachePolicy ?? this.createCloudFrontImageCachePolicy();
        // origin request policies
        const lambdaOriginRequestPolicy = lambdaOriginRequestPolicyOverride ?? this.createLambdaOriginRequestPolicy();
        // main server function origin (lambda URL HTTP origin)
        const fnUrl = this.props.serverFunction.addFunctionUrl({
            authType: lambda.FunctionUrlAuthType.NONE,
        });
        const serverFunctionOrigin = new origins.HttpOrigin(aws_cdk_lib_1.Fn.parseDomainName(fnUrl.url), {
            customHeaders: {
                // provide config to edge lambda function
                'x-origin-url': fnUrl.url,
            },
        });
        // Image Optimization
        const imageOptFnUrl = this.props.imageOptFunction.addFunctionUrl({
            authType: lambda.FunctionUrlAuthType.NONE,
        });
        const imageOptFunctionOrigin = new origins.HttpOrigin(aws_cdk_lib_1.Fn.parseDomainName(imageOptFnUrl.url));
        const imageOptORP = new cloudfront.OriginRequestPolicy(this, 'ImageOptPolicy', {
            queryStringBehavior: cloudfront.OriginRequestQueryStringBehavior.allowList('q', 'w', 'url'),
            headerBehavior: cloudfront.OriginRequestHeaderBehavior.allowList('accept'),
            cookieBehavior: cloudfront.OriginRequestCookieBehavior.none(),
        });
        // lambda behavior edge function
        const lambdaOriginRequestEdgeFn = this.buildLambdaOriginRequestEdgeFunction();
        const lambdaOriginRequestEdgeFnVersion = lambda.Version.fromVersionArn(this, 'Version', lambdaOriginRequestEdgeFn.currentVersion.functionArn);
        const lambdaOriginEdgeFns = [
            {
                eventType: cloudfront.LambdaEdgeEventType.ORIGIN_REQUEST,
                functionVersion: lambdaOriginRequestEdgeFnVersion,
                includeBody: false,
            },
        ];
        // default handler for requests that don't match any other path:
        //   - try lambda handler first (/some-page, etc...)
        //   - if 403, fall back to S3
        //   - if 404, fall back to lambda handler
        const fallbackOriginGroup = new origins.OriginGroup({
            primaryOrigin: serverFunctionOrigin,
            fallbackOrigin: s3Origin,
            fallbackStatusCodes: [403, 404],
        });
        const lambdaCachePolicy = cachePolicies?.lambdaCachePolicy ?? this.createCloudFrontLambdaCachePolicy();
        // requests for static objects
        const defaultStaticMaxAge = cachePolicies?.staticClientMaxAgeDefault?.toSeconds() || constants_1.DEFAULT_STATIC_MAX_AGE;
        const staticResponseHeadersPolicy = new aws_cloudfront_1.ResponseHeadersPolicy(this, 'StaticResponseHeadersPolicy', {
            // add default header for static assets
            customHeadersBehavior: {
                customHeaders: [
                    {
                        header: 'cache-control',
                        override: false,
                        // by default tell browser to cache static files for this long
                        // this is separate from the origin cache policy
                        value: `public,max-age=${defaultStaticMaxAge},immutable`,
                    },
                ],
            },
        });
        const staticBehavior = {
            viewerProtocolPolicy,
            origin: s3Origin,
            allowedMethods: cloudfront.AllowedMethods.ALLOW_GET_HEAD_OPTIONS,
            cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS,
            compress: true,
            cachePolicy: staticCachePolicy,
            responseHeadersPolicy: staticResponseHeadersPolicy,
        };
        // requests going to lambda (api, etc)
        const lambdaBehavior = {
            viewerProtocolPolicy,
            origin: serverFunctionOrigin,
            allowedMethods: cloudfront.AllowedMethods.ALLOW_ALL,
            // cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS, // this should be configurable
            originRequestPolicy: lambdaOriginRequestPolicy,
            compress: true,
            cachePolicy: cloudfront.CachePolicy.CACHING_DISABLED,
            edgeLambdas: lambdaOriginEdgeFns,
        };
        // requests to fallback origin group (default behavior)
        // used for S3 and lambda. would prefer to forward all headers to lambda but need to strip out host
        // TODO: try to do this with headers whitelist or edge lambda
        const fallbackOriginRequestPolicy = new cloudfront.OriginRequestPolicy(this, 'FallbackOriginRequestPolicy', {
            cookieBehavior: cloudfront.OriginRequestCookieBehavior.all(),
            queryStringBehavior: cloudfront.OriginRequestQueryStringBehavior.all(),
            headerBehavior: cloudfront.OriginRequestHeaderBehavior.all(),
            comment: 'Nextjs Fallback Origin Request Policy',
        });
        // if we don't have a static file called index.html then we should
        // redirect to the lambda handler
        const hasIndexHtml = this.props.nextBuild.readPublicFileList().includes('index.html');
        return new cloudfront.Distribution(this, 'Distribution', {
            // defaultRootObject: "index.html",
            defaultRootObject: '',
            // Override props.
            ...cfDistributionProps,
            // these values can NOT be overwritten by cfDistributionProps
            domainNames,
            certificate: this.certificate,
            defaultBehavior: {
                origin: fallbackOriginGroup,
                viewerProtocolPolicy: cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,
                compress: true,
                // what goes here? static or lambda?
                cachePolicy: lambdaCachePolicy,
                originRequestPolicy: fallbackOriginRequestPolicy,
                edgeLambdas: lambdaOriginEdgeFns,
            },
            additionalBehaviors: {
                // is index.html static or dynamic?
                ...(hasIndexHtml ? {} : { '/': lambdaBehavior }),
                // known dynamic routes
                'api/*': lambdaBehavior,
                '_next/data/*': lambdaBehavior,
                // dynamic images go to lambda
                '_next/image*': {
                    viewerProtocolPolicy,
                    origin: imageOptFunctionOrigin,
                    allowedMethods: cloudfront.AllowedMethods.ALLOW_GET_HEAD_OPTIONS,
                    cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS,
                    compress: true,
                    cachePolicy: imageCachePolicy,
                    originRequestPolicy: imageOptORP,
                },
                // known static routes
                // it would be nice to create routes for all the static files we know of
                // but we run into the limit of CacheBehaviors per distribution
                '_next/*': staticBehavior,
            },
        });
    }
    createCloudFrontStaticCachePolicy() {
        return new cloudfront.CachePolicy(this, 'StaticsCache', NextjsDistribution.staticCachePolicyProps);
    }
    createCloudFrontImageCachePolicy() {
        return new cloudfront.CachePolicy(this, 'ImageCache', NextjsDistribution.imageCachePolicyProps);
    }
    createLambdaOriginRequestPolicy() {
        return new cloudfront.OriginRequestPolicy(this, 'LambdaOriginPolicy', NextjsDistribution.lambdaOriginRequestPolicyProps);
    }
    createCloudFrontLambdaCachePolicy() {
        return new cloudfront.CachePolicy(this, 'LambdaCache', NextjsDistribution.lambdaCachePolicyProps);
    }
    createCloudFrontDistributionForStub() {
        return new cloudfront.Distribution(this, 'Distribution', {
            defaultRootObject: 'index.html',
            errorResponses: NextjsBase_1.buildErrorResponsesForRedirectToIndex('index.html'),
            domainNames: this.buildDistributionDomainNames(),
            certificate: this.certificate,
            defaultBehavior: {
                origin: new origins.S3Origin(this.props.staticAssetsBucket),
                viewerProtocolPolicy: cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,
            },
            ...this.props.cdk?.distribution,
        });
    }
    buildDistributionDomainNames() {
        const { customDomain } = this.props;
        const domainNames = [];
        if (!customDomain) {
            // no domain
        }
        else if (typeof customDomain === 'string') {
            domainNames.push(customDomain);
        }
        else {
            domainNames.push(customDomain.domainName);
        }
        return domainNames;
    }
    /**
     * Create an edge function to handle requests to the lambda server handler origin.
     * It overrides the host header in the request to be the lambda URL's host.
     * It's needed because we forward all headers to the origin, but the origin is itself an
     *  HTTP server so it needs the host header to be the address of the lambda and not
     *  the distribution.
     *
     */
    buildLambdaOriginRequestEdgeFunction() {
        const app = aws_cdk_lib_1.App.of(this);
        // bundle the edge function
        const inputPath = path.join(__dirname, '..', 'assets', 'lambda@edge', 'LambdaOriginRequest');
        const outputPath = path.join(this.tempBuildDir, 'lambda@edge', 'LambdaOriginRequest.js');
        BundleFunction_1.bundleFunction({
            inputPath,
            outputPath,
            bundleOptions: {
                bundle: true,
                external: ['aws-sdk', 'url'],
                minify: true,
                target: 'node16',
                platform: 'node',
            },
        });
        const fn = new cloudfront.experimental.EdgeFunction(this, 'DefaultOriginRequestEdgeFn', {
            runtime: constants_1.LAMBDA_RUNTIME,
            // role,
            handler: 'LambdaOriginRequest.handler',
            code: lambda.Code.fromAsset(path_1.dirname(outputPath)),
            currentVersionOptions: {
                removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY,
                retryAttempts: 1,
            },
            stackId: `Nextjs-${this.props.stageName || app.stageName || 'default'}-EdgeFunctions-` + this.node.addr.substring(0, 5),
        });
        fn.currentVersion.grantInvoke(new aws_iam_1.ServicePrincipal('edgelambda.amazonaws.com'));
        fn.currentVersion.grantInvoke(new aws_iam_1.ServicePrincipal('lambda.amazonaws.com'));
        return fn;
    }
    /////////////////////
    // Custom Domain
    /////////////////////
    validateCustomDomainSettings() {
        const { customDomain } = this.props;
        if (!customDomain) {
            return;
        }
        if (typeof customDomain === 'string') {
            return;
        }
        if (customDomain.isExternalDomain === true) {
            if (!customDomain.certificate) {
                throw new Error('A valid certificate is required when "isExternalDomain" is set to "true".');
            }
            if (customDomain.domainAlias) {
                throw new Error('Domain alias is only supported for domains hosted on Amazon Route 53. Do not set the "customDomain.domainAlias" when "isExternalDomain" is enabled.');
            }
            if (customDomain.hostedZone) {
                throw new Error('Hosted zones can only be configured for domains hosted on Amazon Route 53. Do not set the "customDomain.hostedZone" when "isExternalDomain" is enabled.');
            }
        }
    }
    lookupHostedZone() {
        const { customDomain } = this.props;
        // Skip if customDomain is not configured
        if (!customDomain) {
            return;
        }
        let hostedZone;
        if (typeof customDomain === 'string') {
            hostedZone = route53.HostedZone.fromLookup(this, 'HostedZone', {
                domainName: customDomain,
            });
        }
        else if (typeof customDomain.hostedZone === 'string') {
            hostedZone = route53.HostedZone.fromLookup(this, 'HostedZone', {
                domainName: customDomain.hostedZone,
            });
        }
        else if (customDomain.hostedZone) {
            hostedZone = customDomain.hostedZone;
        }
        else if (typeof customDomain.domainName === 'string') {
            // Skip if domain is not a Route53 domain
            if (customDomain.isExternalDomain === true) {
                return;
            }
            hostedZone = route53.HostedZone.fromLookup(this, 'HostedZone', {
                domainName: customDomain.domainName,
            });
        }
        else {
            hostedZone = customDomain.hostedZone;
        }
        return hostedZone;
    }
    createCertificate() {
        const { customDomain } = this.props;
        if (!customDomain) {
            return;
        }
        let acmCertificate;
        // HostedZone is set for Route 53 domains
        if (this.hostedZone) {
            if (typeof customDomain === 'string') {
                acmCertificate = new acm.DnsValidatedCertificate(this, 'Certificate', {
                    domainName: customDomain,
                    hostedZone: this.hostedZone,
                    region: 'us-east-1',
                });
            }
            else if (customDomain.certificate) {
                acmCertificate = customDomain.certificate;
            }
            else {
                acmCertificate = new acm.DnsValidatedCertificate(this, 'Certificate', {
                    domainName: customDomain.domainName,
                    hostedZone: this.hostedZone,
                    region: 'us-east-1',
                });
            }
        }
        // HostedZone is NOT set for non-Route 53 domains
        else {
            if (typeof customDomain !== 'string') {
                acmCertificate = customDomain.certificate;
            }
        }
        return acmCertificate;
    }
    createRoute53Records() {
        const { customDomain } = this.props;
        if (!customDomain || !this.hostedZone) {
            return;
        }
        let recordName;
        let domainAlias;
        if (typeof customDomain === 'string') {
            recordName = customDomain;
        }
        else {
            recordName = customDomain.domainName;
            domainAlias = customDomain.domainAlias;
        }
        // Create DNS record
        const recordProps = {
            recordName,
            zone: this.hostedZone,
            target: route53.RecordTarget.fromAlias(new route53Targets.CloudFrontTarget(this.distribution)),
        };
        new route53.ARecord(this, 'AliasRecord', recordProps);
        new route53.AaaaRecord(this, 'AliasRecordAAAA', recordProps);
        // Create Alias redirect record
        if (domainAlias) {
            new route53Patterns.HttpsRedirect(this, 'Redirect', {
                zone: this.hostedZone,
                recordNames: [domainAlias],
                targetDomain: recordName,
            });
        }
    }
}
exports.NextjsDistribution = NextjsDistribution;
_a = JSII_RTTI_SYMBOL_1;
NextjsDistribution[_a] = { fqn: "cdk-nextjs-standalone.NextjsDistribution", version: "2.0.3" };
/**
 * The default CloudFront cache policy properties for static pages.
 */
NextjsDistribution.staticCachePolicyProps = {
    queryStringBehavior: cloudfront.CacheQueryStringBehavior.none(),
    headerBehavior: cloudfront.CacheHeaderBehavior.none(),
    cookieBehavior: cloudfront.CacheCookieBehavior.none(),
    defaultTtl: aws_cdk_lib_1.Duration.days(30),
    maxTtl: aws_cdk_lib_1.Duration.days(60),
    minTtl: aws_cdk_lib_1.Duration.days(30),
    enableAcceptEncodingBrotli: true,
    enableAcceptEncodingGzip: true,
    comment: 'Nextjs Static Default Cache Policy',
};
/**
 * The default CloudFront cache policy properties for images.
 */
NextjsDistribution.imageCachePolicyProps = {
    queryStringBehavior: cloudfront.CacheQueryStringBehavior.all(),
    headerBehavior: cloudfront.CacheHeaderBehavior.allowList('Accept'),
    cookieBehavior: cloudfront.CacheCookieBehavior.none(),
    defaultTtl: aws_cdk_lib_1.Duration.days(1),
    maxTtl: aws_cdk_lib_1.Duration.days(365),
    minTtl: aws_cdk_lib_1.Duration.days(0),
    enableAcceptEncodingBrotli: true,
    enableAcceptEncodingGzip: true,
    comment: 'Nextjs Image Default Cache Policy',
};
/**
 * The default CloudFront cache policy properties for the Lambda server handler.
 */
NextjsDistribution.lambdaCachePolicyProps = {
    queryStringBehavior: cloudfront.CacheQueryStringBehavior.all(),
    headerBehavior: cloudfront.CacheHeaderBehavior.none(),
    cookieBehavior: cloudfront.CacheCookieBehavior.all(),
    defaultTtl: aws_cdk_lib_1.Duration.seconds(0),
    maxTtl: aws_cdk_lib_1.Duration.days(365),
    minTtl: aws_cdk_lib_1.Duration.seconds(0),
    enableAcceptEncodingBrotli: true,
    enableAcceptEncodingGzip: true,
    comment: 'Nextjs Lambda Default Cache Policy',
};
/**
 * The default CloudFront lambda origin request policy.
 */
NextjsDistribution.lambdaOriginRequestPolicyProps = {
    cookieBehavior: cloudfront.OriginRequestCookieBehavior.all(),
    queryStringBehavior: cloudfront.OriginRequestQueryStringBehavior.all(),
    headerBehavior: cloudfront.OriginRequestHeaderBehavior.all(),
    comment: 'Nextjs Lambda Origin Request Policy',
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTmV4dGpzRGlzdHJpYnV0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL05leHRqc0Rpc3RyaWJ1dGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLHlCQUF5QjtBQUN6Qiw2QkFBNkI7QUFDN0IsK0JBQStCO0FBQy9CLDZDQUErRDtBQUMvRCwwREFBMEQ7QUFDMUQseURBQXlEO0FBQ3pELCtEQUFpRjtBQUNqRiw4REFBOEQ7QUFDOUQsaURBQXVEO0FBQ3ZELGlEQUFpRDtBQUNqRCxtREFBbUQ7QUFDbkQsb0VBQW9FO0FBQ3BFLGtFQUFrRTtBQUVsRSwyQ0FBdUM7QUFDdkMsK0JBQStCO0FBQy9CLHFEQUFrRDtBQUNsRCwyQ0FBcUU7QUFDckUsNkNBQTJHO0FBRzNHLGtFQUFrRTtBQUNyRCxRQUFBLG9CQUFvQixHQUFHLGVBQWUsQ0FBQztBQStGcEQ7O0dBRUc7QUFDSCxNQUFhLGtCQUFtQixTQUFRLHNCQUFTO0lBNEUvQyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQThCO1FBQ3RFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsdUNBQXVDO1FBQ3ZDLElBQUksQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDLFlBQVk7WUFDcEMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQ1YsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxFQUFFLG9CQUFvQixJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FDcEc7WUFDSCxDQUFDLENBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsRUFBRSxtQkFBbUIsQ0FBQyxDQUFDLENBQUM7UUFFaEUsYUFBYTtRQUNiLElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBRSxHQUFHLEtBQUssRUFBRSxZQUFZLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBRTNELHVCQUF1QjtRQUN2QixJQUFJLENBQUMsNEJBQTRCLEVBQUUsQ0FBQztRQUNwQyxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQzFDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFFNUMsb0JBQW9CO1FBQ3BCLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhO1lBQzFDLENBQUMsQ0FBQyxJQUFJLENBQUMsbUNBQW1DLEVBQUU7WUFDNUMsQ0FBQyxDQUFDLElBQUksQ0FBQyw0QkFBNEIsRUFBRSxDQUFDO1FBRXhDLG1EQUFtRDtRQUNuRCxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztJQUM5QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxJQUFXLEdBQUc7UUFDWixPQUFPLFdBQVcsSUFBSSxDQUFDLFlBQVksQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO0lBQy9ELENBQUM7SUFFRDs7O09BR0c7SUFDSCxJQUFXLGVBQWU7UUFDeEIsTUFBTSxFQUFFLFlBQVksRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDcEMsSUFBSSxDQUFDLFlBQVksRUFBRTtZQUNqQixPQUFPO1NBQ1I7UUFFRCxJQUFJLE9BQU8sWUFBWSxLQUFLLFFBQVEsRUFBRTtZQUNwQyxPQUFPLFdBQVcsWUFBWSxFQUFFLENBQUM7U0FDbEM7YUFBTTtZQUNMLE9BQU8sV0FBVyxZQUFZLENBQUMsVUFBVSxFQUFFLENBQUM7U0FDN0M7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxJQUFXLGNBQWM7UUFDdkIsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLGNBQWMsQ0FBQztJQUMxQyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxJQUFXLGtCQUFrQjtRQUMzQixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsc0JBQXNCLENBQUM7SUFDbEQsQ0FBQztJQUVELHFCQUFxQjtJQUNyQiwwQkFBMEI7SUFDMUIscUJBQXFCO0lBRWIsNEJBQTRCO1FBQ2xDLE1BQU0sRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLGFBQWEsRUFBRSx5QkFBeUIsRUFBRSxpQ0FBaUMsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDbEgsTUFBTSxtQkFBbUIsR0FBRyxRQUFRLEVBQUUsWUFBWSxDQUFDO1FBRW5ELG9CQUFvQjtRQUNwQixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsNEJBQTRCLEVBQUUsQ0FBQztRQUV4RCxZQUFZO1FBQ1osTUFBTSxRQUFRLEdBQUcsSUFBSSxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUVyRSxNQUFNLG9CQUFvQixHQUFHLFVBQVUsQ0FBQyxvQkFBb0IsQ0FBQyxpQkFBaUIsQ0FBQztRQUUvRSxxQkFBcUI7UUFDckIsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRTtZQUM1QixPQUFPLElBQUksVUFBVSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsY0FBYyxFQUFFO2dCQUN2RCxpQkFBaUIsRUFBRSxZQUFZO2dCQUMvQixjQUFjLEVBQUUsa0RBQXFDLENBQUMsWUFBWSxDQUFDO2dCQUNuRSxXQUFXO2dCQUNYLFdBQVcsRUFBRSxJQUFJLENBQUMsV0FBVztnQkFDN0IsZUFBZSxFQUFFO29CQUNmLE1BQU0sRUFBRSxRQUFRO29CQUNoQixvQkFBb0I7aUJBQ3JCO2FBQ0YsQ0FBQyxDQUFDO1NBQ0o7UUFFRCxpQkFBaUI7UUFDakIsTUFBTSxpQkFBaUIsR0FBRyxhQUFhLEVBQUUsaUJBQWlCLElBQUksSUFBSSxDQUFDLGlDQUFpQyxFQUFFLENBQUM7UUFDdkcsTUFBTSxnQkFBZ0IsR0FBRyxhQUFhLEVBQUUsZ0JBQWdCLElBQUksSUFBSSxDQUFDLGdDQUFnQyxFQUFFLENBQUM7UUFFcEcsMEJBQTBCO1FBQzFCLE1BQU0seUJBQXlCLEdBQUcsaUNBQWlDLElBQUksSUFBSSxDQUFDLCtCQUErQixFQUFFLENBQUM7UUFFOUcsdURBQXVEO1FBQ3ZELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLGNBQWMsQ0FBQztZQUNyRCxRQUFRLEVBQUUsTUFBTSxDQUFDLG1CQUFtQixDQUFDLElBQUk7U0FDMUMsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxvQkFBb0IsR0FBRyxJQUFJLE9BQU8sQ0FBQyxVQUFVLENBQUMsZ0JBQUUsQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ2pGLGFBQWEsRUFBRTtnQkFDYix5Q0FBeUM7Z0JBQ3pDLGNBQWMsRUFBRSxLQUFLLENBQUMsR0FBRzthQUMxQjtTQUNGLENBQUMsQ0FBQztRQUVILHFCQUFxQjtRQUNyQixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLGNBQWMsQ0FBQztZQUMvRCxRQUFRLEVBQUUsTUFBTSxDQUFDLG1CQUFtQixDQUFDLElBQUk7U0FDMUMsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxzQkFBc0IsR0FBRyxJQUFJLE9BQU8sQ0FBQyxVQUFVLENBQUMsZ0JBQUUsQ0FBQyxlQUFlLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDN0YsTUFBTSxXQUFXLEdBQUcsSUFBSSxVQUFVLENBQUMsbUJBQW1CLENBQUMsSUFBSSxFQUFFLGdCQUFnQixFQUFFO1lBQzdFLG1CQUFtQixFQUFFLFVBQVUsQ0FBQyxnQ0FBZ0MsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxLQUFLLENBQUM7WUFDM0YsY0FBYyxFQUFFLFVBQVUsQ0FBQywyQkFBMkIsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDO1lBQzFFLGNBQWMsRUFBRSxVQUFVLENBQUMsMkJBQTJCLENBQUMsSUFBSSxFQUFFO1NBQzlELENBQUMsQ0FBQztRQUVILGdDQUFnQztRQUNoQyxNQUFNLHlCQUF5QixHQUFHLElBQUksQ0FBQyxvQ0FBb0MsRUFBRSxDQUFDO1FBQzlFLE1BQU0sZ0NBQWdDLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQ3BFLElBQUksRUFDSixTQUFTLEVBQ1QseUJBQXlCLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FDckQsQ0FBQztRQUNGLE1BQU0sbUJBQW1CLEdBQTRCO1lBQ25EO2dCQUNFLFNBQVMsRUFBRSxVQUFVLENBQUMsbUJBQW1CLENBQUMsY0FBYztnQkFDeEQsZUFBZSxFQUFFLGdDQUFnQztnQkFDakQsV0FBVyxFQUFFLEtBQUs7YUFDbkI7U0FDRixDQUFDO1FBRUYsZ0VBQWdFO1FBQ2hFLG9EQUFvRDtRQUNwRCw4QkFBOEI7UUFDOUIsMENBQTBDO1FBQzFDLE1BQU0sbUJBQW1CLEdBQUcsSUFBSSxPQUFPLENBQUMsV0FBVyxDQUFDO1lBQ2xELGFBQWEsRUFBRSxvQkFBb0I7WUFDbkMsY0FBYyxFQUFFLFFBQVE7WUFDeEIsbUJBQW1CLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDO1NBQ2hDLENBQUMsQ0FBQztRQUVILE1BQU0saUJBQWlCLEdBQUcsYUFBYSxFQUFFLGlCQUFpQixJQUFJLElBQUksQ0FBQyxpQ0FBaUMsRUFBRSxDQUFDO1FBRXZHLDhCQUE4QjtRQUM5QixNQUFNLG1CQUFtQixHQUFHLGFBQWEsRUFBRSx5QkFBeUIsRUFBRSxTQUFTLEVBQUUsSUFBSSxrQ0FBc0IsQ0FBQztRQUM1RyxNQUFNLDJCQUEyQixHQUFHLElBQUksc0NBQXFCLENBQUMsSUFBSSxFQUFFLDZCQUE2QixFQUFFO1lBQ2pHLHVDQUF1QztZQUN2QyxxQkFBcUIsRUFBRTtnQkFDckIsYUFBYSxFQUFFO29CQUNiO3dCQUNFLE1BQU0sRUFBRSxlQUFlO3dCQUN2QixRQUFRLEVBQUUsS0FBSzt3QkFDZiw4REFBOEQ7d0JBQzlELGdEQUFnRDt3QkFDaEQsS0FBSyxFQUFFLGtCQUFrQixtQkFBbUIsWUFBWTtxQkFDekQ7aUJBQ0Y7YUFDRjtTQUNGLENBQUMsQ0FBQztRQUNILE1BQU0sY0FBYyxHQUErQjtZQUNqRCxvQkFBb0I7WUFDcEIsTUFBTSxFQUFFLFFBQVE7WUFDaEIsY0FBYyxFQUFFLFVBQVUsQ0FBQyxjQUFjLENBQUMsc0JBQXNCO1lBQ2hFLGFBQWEsRUFBRSxVQUFVLENBQUMsYUFBYSxDQUFDLHNCQUFzQjtZQUM5RCxRQUFRLEVBQUUsSUFBSTtZQUNkLFdBQVcsRUFBRSxpQkFBaUI7WUFDOUIscUJBQXFCLEVBQUUsMkJBQTJCO1NBQ25ELENBQUM7UUFFRixzQ0FBc0M7UUFDdEMsTUFBTSxjQUFjLEdBQStCO1lBQ2pELG9CQUFvQjtZQUNwQixNQUFNLEVBQUUsb0JBQW9CO1lBQzVCLGNBQWMsRUFBRSxVQUFVLENBQUMsY0FBYyxDQUFDLFNBQVM7WUFDbkQsaUdBQWlHO1lBQ2pHLG1CQUFtQixFQUFFLHlCQUF5QjtZQUM5QyxRQUFRLEVBQUUsSUFBSTtZQUNkLFdBQVcsRUFBRSxVQUFVLENBQUMsV0FBVyxDQUFDLGdCQUFnQjtZQUNwRCxXQUFXLEVBQUUsbUJBQW1CO1NBQ2pDLENBQUM7UUFFRix1REFBdUQ7UUFDdkQsbUdBQW1HO1FBQ25HLDZEQUE2RDtRQUM3RCxNQUFNLDJCQUEyQixHQUFHLElBQUksVUFBVSxDQUFDLG1CQUFtQixDQUFDLElBQUksRUFBRSw2QkFBNkIsRUFBRTtZQUMxRyxjQUFjLEVBQUUsVUFBVSxDQUFDLDJCQUEyQixDQUFDLEdBQUcsRUFBRTtZQUM1RCxtQkFBbUIsRUFBRSxVQUFVLENBQUMsZ0NBQWdDLENBQUMsR0FBRyxFQUFFO1lBQ3RFLGNBQWMsRUFBRSxVQUFVLENBQUMsMkJBQTJCLENBQUMsR0FBRyxFQUFFO1lBQzVELE9BQU8sRUFBRSx1Q0FBdUM7U0FDakQsQ0FBQyxDQUFDO1FBRUgsa0VBQWtFO1FBQ2xFLGlDQUFpQztRQUNqQyxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxrQkFBa0IsRUFBRSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUV0RixPQUFPLElBQUksVUFBVSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsY0FBYyxFQUFFO1lBQ3ZELG1DQUFtQztZQUNuQyxpQkFBaUIsRUFBRSxFQUFFO1lBRXJCLGtCQUFrQjtZQUNsQixHQUFHLG1CQUFtQjtZQUV0Qiw2REFBNkQ7WUFDN0QsV0FBVztZQUNYLFdBQVcsRUFBRSxJQUFJLENBQUMsV0FBVztZQUM3QixlQUFlLEVBQUU7Z0JBQ2YsTUFBTSxFQUFFLG1CQUFtQjtnQkFDM0Isb0JBQW9CLEVBQUUsVUFBVSxDQUFDLG9CQUFvQixDQUFDLGlCQUFpQjtnQkFDdkUsUUFBUSxFQUFFLElBQUk7Z0JBRWQsb0NBQW9DO2dCQUNwQyxXQUFXLEVBQUUsaUJBQWlCO2dCQUM5QixtQkFBbUIsRUFBRSwyQkFBMkI7Z0JBRWhELFdBQVcsRUFBRSxtQkFBbUI7YUFDakM7WUFFRCxtQkFBbUIsRUFBRTtnQkFDbkIsbUNBQW1DO2dCQUNuQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLGNBQWMsRUFBRSxDQUFDO2dCQUVoRCx1QkFBdUI7Z0JBQ3ZCLE9BQU8sRUFBRSxjQUFjO2dCQUN2QixjQUFjLEVBQUUsY0FBYztnQkFFOUIsOEJBQThCO2dCQUM5QixjQUFjLEVBQUU7b0JBQ2Qsb0JBQW9CO29CQUNwQixNQUFNLEVBQUUsc0JBQXNCO29CQUM5QixjQUFjLEVBQUUsVUFBVSxDQUFDLGNBQWMsQ0FBQyxzQkFBc0I7b0JBQ2hFLGFBQWEsRUFBRSxVQUFVLENBQUMsYUFBYSxDQUFDLHNCQUFzQjtvQkFDOUQsUUFBUSxFQUFFLElBQUk7b0JBQ2QsV0FBVyxFQUFFLGdCQUFnQjtvQkFDN0IsbUJBQW1CLEVBQUUsV0FBVztpQkFDakM7Z0JBRUQsc0JBQXNCO2dCQUN0Qix3RUFBd0U7Z0JBQ3hFLCtEQUErRDtnQkFDL0QsU0FBUyxFQUFFLGNBQWM7YUFDMUI7U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8saUNBQWlDO1FBQ3ZDLE9BQU8sSUFBSSxVQUFVLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxjQUFjLEVBQUUsa0JBQWtCLENBQUMsc0JBQXNCLENBQUMsQ0FBQztJQUNyRyxDQUFDO0lBRU8sZ0NBQWdDO1FBQ3RDLE9BQU8sSUFBSSxVQUFVLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxZQUFZLEVBQUUsa0JBQWtCLENBQUMscUJBQXFCLENBQUMsQ0FBQztJQUNsRyxDQUFDO0lBRU8sK0JBQStCO1FBQ3JDLE9BQU8sSUFBSSxVQUFVLENBQUMsbUJBQW1CLENBQ3ZDLElBQUksRUFDSixvQkFBb0IsRUFDcEIsa0JBQWtCLENBQUMsOEJBQThCLENBQ2xELENBQUM7SUFDSixDQUFDO0lBRU8saUNBQWlDO1FBQ3ZDLE9BQU8sSUFBSSxVQUFVLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxhQUFhLEVBQUUsa0JBQWtCLENBQUMsc0JBQXNCLENBQUMsQ0FBQztJQUNwRyxDQUFDO0lBRU8sbUNBQW1DO1FBQ3pDLE9BQU8sSUFBSSxVQUFVLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxjQUFjLEVBQUU7WUFDdkQsaUJBQWlCLEVBQUUsWUFBWTtZQUMvQixjQUFjLEVBQUUsa0RBQXFDLENBQUMsWUFBWSxDQUFDO1lBQ25FLFdBQVcsRUFBRSxJQUFJLENBQUMsNEJBQTRCLEVBQUU7WUFDaEQsV0FBVyxFQUFFLElBQUksQ0FBQyxXQUFXO1lBQzdCLGVBQWUsRUFBRTtnQkFDZixNQUFNLEVBQUUsSUFBSSxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsa0JBQWtCLENBQUM7Z0JBQzNELG9CQUFvQixFQUFFLFVBQVUsQ0FBQyxvQkFBb0IsQ0FBQyxpQkFBaUI7YUFDeEU7WUFDRCxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLFlBQVk7U0FDaEMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLDRCQUE0QjtRQUNsQyxNQUFNLEVBQUUsWUFBWSxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUNwQyxNQUFNLFdBQVcsR0FBRyxFQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLFlBQVksRUFBRTtZQUNqQixZQUFZO1NBQ2I7YUFBTSxJQUFJLE9BQU8sWUFBWSxLQUFLLFFBQVEsRUFBRTtZQUMzQyxXQUFXLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1NBQ2hDO2FBQU07WUFDTCxXQUFXLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsQ0FBQztTQUMzQztRQUNELE9BQU8sV0FBVyxDQUFDO0lBQ3JCLENBQUM7SUFFRDs7Ozs7OztPQU9HO0lBQ0ssb0NBQW9DO1FBQzFDLE1BQU0sR0FBRyxHQUFHLGlCQUFHLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBUSxDQUFDO1FBRWhDLDJCQUEyQjtRQUMzQixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLGFBQWEsRUFBRSxxQkFBcUIsQ0FBQyxDQUFDO1FBQzdGLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxhQUFhLEVBQUUsd0JBQXdCLENBQUMsQ0FBQztRQUN6RiwrQkFBYyxDQUFDO1lBQ2IsU0FBUztZQUNULFVBQVU7WUFDVixhQUFhLEVBQUU7Z0JBQ2IsTUFBTSxFQUFFLElBQUk7Z0JBQ1osUUFBUSxFQUFFLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQztnQkFDNUIsTUFBTSxFQUFFLElBQUk7Z0JBQ1osTUFBTSxFQUFFLFFBQVE7Z0JBQ2hCLFFBQVEsRUFBRSxNQUFNO2FBQ2pCO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsTUFBTSxFQUFFLEdBQUcsSUFBSSxVQUFVLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsNEJBQTRCLEVBQUU7WUFDdEYsT0FBTyxFQUFFLDBCQUFjO1lBQ3ZCLFFBQVE7WUFDUixPQUFPLEVBQUUsNkJBQTZCO1lBQ3RDLElBQUksRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxjQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDaEQscUJBQXFCLEVBQUU7Z0JBQ3JCLGFBQWEsRUFBRSwyQkFBYSxDQUFDLE9BQU87Z0JBQ3BDLGFBQWEsRUFBRSxDQUFDO2FBQ2pCO1lBQ0QsT0FBTyxFQUNMLFVBQVUsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLElBQUksR0FBRyxDQUFDLFNBQVMsSUFBSSxTQUFTLGlCQUFpQixHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQ2pILENBQUMsQ0FBQztRQUNILEVBQUUsQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDLElBQUksMEJBQWdCLENBQUMsMEJBQTBCLENBQUMsQ0FBQyxDQUFDO1FBQ2hGLEVBQUUsQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDLElBQUksMEJBQWdCLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxDQUFDO1FBRTVFLE9BQU8sRUFBRSxDQUFDO0lBQ1osQ0FBQztJQUVELHFCQUFxQjtJQUNyQixnQkFBZ0I7SUFDaEIscUJBQXFCO0lBRVgsNEJBQTRCO1FBQ3BDLE1BQU0sRUFBRSxZQUFZLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBRXBDLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDakIsT0FBTztTQUNSO1FBRUQsSUFBSSxPQUFPLFlBQVksS0FBSyxRQUFRLEVBQUU7WUFDcEMsT0FBTztTQUNSO1FBRUQsSUFBSSxZQUFZLENBQUMsZ0JBQWdCLEtBQUssSUFBSSxFQUFFO1lBQzFDLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFO2dCQUM3QixNQUFNLElBQUksS0FBSyxDQUFDLDJFQUEyRSxDQUFDLENBQUM7YUFDOUY7WUFDRCxJQUFJLFlBQVksQ0FBQyxXQUFXLEVBQUU7Z0JBQzVCLE1BQU0sSUFBSSxLQUFLLENBQ2IscUpBQXFKLENBQ3RKLENBQUM7YUFDSDtZQUNELElBQUksWUFBWSxDQUFDLFVBQVUsRUFBRTtnQkFDM0IsTUFBTSxJQUFJLEtBQUssQ0FDYix5SkFBeUosQ0FDMUosQ0FBQzthQUNIO1NBQ0Y7SUFDSCxDQUFDO0lBRVMsZ0JBQWdCO1FBQ3hCLE1BQU0sRUFBRSxZQUFZLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBRXBDLHlDQUF5QztRQUN6QyxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ2pCLE9BQU87U0FDUjtRQUVELElBQUksVUFBVSxDQUFDO1FBRWYsSUFBSSxPQUFPLFlBQVksS0FBSyxRQUFRLEVBQUU7WUFDcEMsVUFBVSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxZQUFZLEVBQUU7Z0JBQzdELFVBQVUsRUFBRSxZQUFZO2FBQ3pCLENBQUMsQ0FBQztTQUNKO2FBQU0sSUFBSSxPQUFPLFlBQVksQ0FBQyxVQUFVLEtBQUssUUFBUSxFQUFFO1lBQ3RELFVBQVUsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsWUFBWSxFQUFFO2dCQUM3RCxVQUFVLEVBQUUsWUFBWSxDQUFDLFVBQVU7YUFDcEMsQ0FBQyxDQUFDO1NBQ0o7YUFBTSxJQUFJLFlBQVksQ0FBQyxVQUFVLEVBQUU7WUFDbEMsVUFBVSxHQUFHLFlBQVksQ0FBQyxVQUFVLENBQUM7U0FDdEM7YUFBTSxJQUFJLE9BQU8sWUFBWSxDQUFDLFVBQVUsS0FBSyxRQUFRLEVBQUU7WUFDdEQseUNBQXlDO1lBQ3pDLElBQUksWUFBWSxDQUFDLGdCQUFnQixLQUFLLElBQUksRUFBRTtnQkFDMUMsT0FBTzthQUNSO1lBRUQsVUFBVSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxZQUFZLEVBQUU7Z0JBQzdELFVBQVUsRUFBRSxZQUFZLENBQUMsVUFBVTthQUNwQyxDQUFDLENBQUM7U0FDSjthQUFNO1lBQ0wsVUFBVSxHQUFHLFlBQVksQ0FBQyxVQUFVLENBQUM7U0FDdEM7UUFFRCxPQUFPLFVBQVUsQ0FBQztJQUNwQixDQUFDO0lBRU8saUJBQWlCO1FBQ3ZCLE1BQU0sRUFBRSxZQUFZLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBRXBDLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDakIsT0FBTztTQUNSO1FBRUQsSUFBSSxjQUFjLENBQUM7UUFFbkIseUNBQXlDO1FBQ3pDLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNuQixJQUFJLE9BQU8sWUFBWSxLQUFLLFFBQVEsRUFBRTtnQkFDcEMsY0FBYyxHQUFHLElBQUksR0FBRyxDQUFDLHVCQUF1QixDQUFDLElBQUksRUFBRSxhQUFhLEVBQUU7b0JBQ3BFLFVBQVUsRUFBRSxZQUFZO29CQUN4QixVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVU7b0JBQzNCLE1BQU0sRUFBRSxXQUFXO2lCQUNwQixDQUFDLENBQUM7YUFDSjtpQkFBTSxJQUFJLFlBQVksQ0FBQyxXQUFXLEVBQUU7Z0JBQ25DLGNBQWMsR0FBRyxZQUFZLENBQUMsV0FBVyxDQUFDO2FBQzNDO2lCQUFNO2dCQUNMLGNBQWMsR0FBRyxJQUFJLEdBQUcsQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLEVBQUUsYUFBYSxFQUFFO29CQUNwRSxVQUFVLEVBQUUsWUFBWSxDQUFDLFVBQVU7b0JBQ25DLFVBQVUsRUFBRSxJQUFJLENBQUMsVUFBVTtvQkFDM0IsTUFBTSxFQUFFLFdBQVc7aUJBQ3BCLENBQUMsQ0FBQzthQUNKO1NBQ0Y7UUFDRCxpREFBaUQ7YUFDNUM7WUFDSCxJQUFJLE9BQU8sWUFBWSxLQUFLLFFBQVEsRUFBRTtnQkFDcEMsY0FBYyxHQUFHLFlBQVksQ0FBQyxXQUFXLENBQUM7YUFDM0M7U0FDRjtRQUVELE9BQU8sY0FBYyxDQUFDO0lBQ3hCLENBQUM7SUFFTyxvQkFBb0I7UUFDMUIsTUFBTSxFQUFFLFlBQVksRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFFcEMsSUFBSSxDQUFDLFlBQVksSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDckMsT0FBTztTQUNSO1FBRUQsSUFBSSxVQUFVLENBQUM7UUFDZixJQUFJLFdBQVcsQ0FBQztRQUNoQixJQUFJLE9BQU8sWUFBWSxLQUFLLFFBQVEsRUFBRTtZQUNwQyxVQUFVLEdBQUcsWUFBWSxDQUFDO1NBQzNCO2FBQU07WUFDTCxVQUFVLEdBQUcsWUFBWSxDQUFDLFVBQVUsQ0FBQztZQUNyQyxXQUFXLEdBQUcsWUFBWSxDQUFDLFdBQVcsQ0FBQztTQUN4QztRQUVELG9CQUFvQjtRQUNwQixNQUFNLFdBQVcsR0FBRztZQUNsQixVQUFVO1lBQ1YsSUFBSSxFQUFFLElBQUksQ0FBQyxVQUFVO1lBQ3JCLE1BQU0sRUFBRSxPQUFPLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxJQUFJLGNBQWMsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7U0FDL0YsQ0FBQztRQUNGLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsYUFBYSxFQUFFLFdBQVcsQ0FBQyxDQUFDO1FBQ3RELElBQUksT0FBTyxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsaUJBQWlCLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFFN0QsK0JBQStCO1FBQy9CLElBQUksV0FBVyxFQUFFO1lBQ2YsSUFBSSxlQUFlLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxVQUFVLEVBQUU7Z0JBQ2xELElBQUksRUFBRSxJQUFJLENBQUMsVUFBVTtnQkFDckIsV0FBVyxFQUFFLENBQUMsV0FBVyxDQUFDO2dCQUMxQixZQUFZLEVBQUUsVUFBVTthQUN6QixDQUFDLENBQUM7U0FDSjtJQUNILENBQUM7O0FBN2lCSCxnREE4aUJDOzs7QUE3aUJDOztHQUVHO0FBQ1cseUNBQXNCLEdBQWdDO0lBQ2xFLG1CQUFtQixFQUFFLFVBQVUsQ0FBQyx3QkFBd0IsQ0FBQyxJQUFJLEVBQUU7SUFDL0QsY0FBYyxFQUFFLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLEVBQUU7SUFDckQsY0FBYyxFQUFFLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLEVBQUU7SUFDckQsVUFBVSxFQUFFLHNCQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztJQUM3QixNQUFNLEVBQUUsc0JBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO0lBQ3pCLE1BQU0sRUFBRSxzQkFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7SUFDekIsMEJBQTBCLEVBQUUsSUFBSTtJQUNoQyx3QkFBd0IsRUFBRSxJQUFJO0lBQzlCLE9BQU8sRUFBRSxvQ0FBb0M7Q0FDOUMsQ0FBQztBQUVGOztHQUVHO0FBQ1csd0NBQXFCLEdBQWdDO0lBQ2pFLG1CQUFtQixFQUFFLFVBQVUsQ0FBQyx3QkFBd0IsQ0FBQyxHQUFHLEVBQUU7SUFDOUQsY0FBYyxFQUFFLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDO0lBQ2xFLGNBQWMsRUFBRSxVQUFVLENBQUMsbUJBQW1CLENBQUMsSUFBSSxFQUFFO0lBQ3JELFVBQVUsRUFBRSxzQkFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDNUIsTUFBTSxFQUFFLHNCQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQztJQUMxQixNQUFNLEVBQUUsc0JBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ3hCLDBCQUEwQixFQUFFLElBQUk7SUFDaEMsd0JBQXdCLEVBQUUsSUFBSTtJQUM5QixPQUFPLEVBQUUsbUNBQW1DO0NBQzdDLENBQUM7QUFFRjs7R0FFRztBQUNXLHlDQUFzQixHQUFnQztJQUNsRSxtQkFBbUIsRUFBRSxVQUFVLENBQUMsd0JBQXdCLENBQUMsR0FBRyxFQUFFO0lBQzlELGNBQWMsRUFBRSxVQUFVLENBQUMsbUJBQW1CLENBQUMsSUFBSSxFQUFFO0lBQ3JELGNBQWMsRUFBRSxVQUFVLENBQUMsbUJBQW1CLENBQUMsR0FBRyxFQUFFO0lBQ3BELFVBQVUsRUFBRSxzQkFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7SUFDL0IsTUFBTSxFQUFFLHNCQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQztJQUMxQixNQUFNLEVBQUUsc0JBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQzNCLDBCQUEwQixFQUFFLElBQUk7SUFDaEMsd0JBQXdCLEVBQUUsSUFBSTtJQUM5QixPQUFPLEVBQUUsb0NBQW9DO0NBQzlDLENBQUM7QUFFRjs7R0FFRztBQUNXLGlEQUE4QixHQUF3QztJQUNsRixjQUFjLEVBQUUsVUFBVSxDQUFDLDJCQUEyQixDQUFDLEdBQUcsRUFBRTtJQUM1RCxtQkFBbUIsRUFBRSxVQUFVLENBQUMsZ0NBQWdDLENBQUMsR0FBRyxFQUFFO0lBQ3RFLGNBQWMsRUFBRSxVQUFVLENBQUMsMkJBQTJCLENBQUMsR0FBRyxFQUFFO0lBQzVELE9BQU8sRUFBRSxxQ0FBcUM7Q0FDL0MsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIG9zIGZyb20gJ29zJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBkaXJuYW1lIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBBcHAsIER1cmF0aW9uLCBGbiwgUmVtb3ZhbFBvbGljeSB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCAqIGFzIGFjbSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtY2VydGlmaWNhdGVtYW5hZ2VyJztcbmltcG9ydCAqIGFzIGNsb3VkZnJvbnQgZnJvbSAnYXdzLWNkay1saWIvYXdzLWNsb3VkZnJvbnQnO1xuaW1wb3J0IHsgRGlzdHJpYnV0aW9uLCBSZXNwb25zZUhlYWRlcnNQb2xpY3kgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtY2xvdWRmcm9udCc7XG5pbXBvcnQgKiBhcyBvcmlnaW5zIGZyb20gJ2F3cy1jZGstbGliL2F3cy1jbG91ZGZyb250LW9yaWdpbnMnO1xuaW1wb3J0IHsgU2VydmljZVByaW5jaXBhbCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1pYW0nO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEnO1xuaW1wb3J0ICogYXMgcm91dGU1MyBmcm9tICdhd3MtY2RrLWxpYi9hd3Mtcm91dGU1Myc7XG5pbXBvcnQgKiBhcyByb3V0ZTUzUGF0dGVybnMgZnJvbSAnYXdzLWNkay1saWIvYXdzLXJvdXRlNTMtcGF0dGVybnMnO1xuaW1wb3J0ICogYXMgcm91dGU1M1RhcmdldHMgZnJvbSAnYXdzLWNkay1saWIvYXdzLXJvdXRlNTMtdGFyZ2V0cyc7XG5pbXBvcnQgKiBhcyBzMyBmcm9tICdhd3MtY2RrLWxpYi9hd3MtczMnO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgeyBidW5kbGVGdW5jdGlvbiB9IGZyb20gJy4vQnVuZGxlRnVuY3Rpb24nO1xuaW1wb3J0IHsgREVGQVVMVF9TVEFUSUNfTUFYX0FHRSwgTEFNQkRBX1JVTlRJTUUgfSBmcm9tICcuL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBCYXNlU2l0ZURvbWFpblByb3BzLCBidWlsZEVycm9yUmVzcG9uc2VzRm9yUmVkaXJlY3RUb0luZGV4LCBOZXh0anNCYXNlUHJvcHMgfSBmcm9tICcuL05leHRqc0Jhc2UnO1xuaW1wb3J0IHsgTmV4dGpzQnVpbGQgfSBmcm9tICcuL05leHRqc0J1aWxkJztcblxuLy8gY29udGFpbnMgc2VydmVyLXNpZGUgcmVzb2x2ZWQgZW52aXJvbm1lbnQgdmFycyBpbiBjb25maWcgYnVja2V0XG5leHBvcnQgY29uc3QgQ09ORklHX0VOVl9KU09OX1BBVEggPSAnbmV4dC1lbnYuanNvbic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTmV4dGpzRG9tYWluUHJvcHMgZXh0ZW5kcyBCYXNlU2l0ZURvbWFpblByb3BzIHt9XG5cbmV4cG9ydCB0eXBlIE5leHRqc0Rpc3RyaWJ1dGlvbkNka092ZXJyaWRlUHJvcHMgPSBjbG91ZGZyb250LkRpc3RyaWJ1dGlvblByb3BzO1xuXG5leHBvcnQgaW50ZXJmYWNlIE5leHRqc0Rpc3RyaWJ1dGlvbkNka1Byb3BzIHtcbiAgLyoqXG4gICAqIFBhc3MgaW4gYSB2YWx1ZSB0byBvdmVycmlkZSB0aGUgZGVmYXVsdCBzZXR0aW5ncyB0aGlzIGNvbnN0cnVjdCB1c2VzIHRvXG4gICAqIGNyZWF0ZSB0aGUgQ2xvdWRGcm9udCBgRGlzdHJpYnV0aW9uYCBpbnRlcm5hbGx5LlxuICAgKi9cbiAgcmVhZG9ubHkgZGlzdHJpYnV0aW9uPzogTmV4dGpzRGlzdHJpYnV0aW9uQ2RrT3ZlcnJpZGVQcm9wcztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBOZXh0anNDYWNoZVBvbGljeVByb3BzIHtcbiAgcmVhZG9ubHkgc3RhdGljQ2FjaGVQb2xpY3k/OiBjbG91ZGZyb250LklDYWNoZVBvbGljeTtcbiAgcmVhZG9ubHkgbGFtYmRhQ2FjaGVQb2xpY3k/OiBjbG91ZGZyb250LklDYWNoZVBvbGljeTtcbiAgcmVhZG9ubHkgaW1hZ2VDYWNoZVBvbGljeT86IGNsb3VkZnJvbnQuSUNhY2hlUG9saWN5O1xuXG4gIC8qKlxuICAgKiBDYWNoZS1jb250cm9sIG1heC1hZ2UgZGVmYXVsdCBmb3Igc3RhdGljIGFzc2V0cyAoL19uZXh0LyopLlxuICAgKiBEZWZhdWx0OiAzMCBkYXlzLlxuICAgKi9cbiAgcmVhZG9ubHkgc3RhdGljQ2xpZW50TWF4QWdlRGVmYXVsdD86IER1cmF0aW9uO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE5leHRqc0Rpc3RyaWJ1dGlvblByb3BzIGV4dGVuZHMgTmV4dGpzQmFzZVByb3BzIHtcbiAgLyoqXG4gICAqIEJ1Y2tldCBjb250YWluaW5nIHN0YXRpYyBhc3NldHMuXG4gICAqIE11c3QgYmUgcHJvdmlkZWQgaWYgeW91IHdhbnQgdG8gc2VydmUgc3RhdGljIGZpbGVzLlxuICAgKi9cbiAgcmVhZG9ubHkgc3RhdGljQXNzZXRzQnVja2V0OiBzMy5JQnVja2V0O1xuXG4gIC8qKlxuICAgKiBMYW1iZGEgZnVuY3Rpb24gdG8gcm91dGUgYWxsIG5vbi1zdGF0aWMgcmVxdWVzdHMgdG8uXG4gICAqIE11c3QgYmUgcHJvdmlkZWQgaWYgeW91IHdhbnQgdG8gc2VydmUgZHluYW1pYyByZXF1ZXN0cy5cbiAgICovXG4gIHJlYWRvbmx5IHNlcnZlckZ1bmN0aW9uOiBsYW1iZGEuSUZ1bmN0aW9uO1xuXG4gIC8qKlxuICAgKiBMYW1iZGEgZnVuY3Rpb24gdG8gb3B0aW1pemUgaW1hZ2VzLlxuICAgKiBNdXN0IGJlIHByb3ZpZGVkIGlmIHlvdSB3YW50IHRvIHNlcnZlIGR5bmFtaWMgcmVxdWVzdHMuXG4gICAqL1xuICByZWFkb25seSBpbWFnZU9wdEZ1bmN0aW9uOiBsYW1iZGEuSUZ1bmN0aW9uO1xuXG4gIC8qKlxuICAgKiBPdmVycmlkZXMgZm9yIGNyZWF0ZWQgQ0RLIHJlc291cmNlcy5cbiAgICovXG4gIHJlYWRvbmx5IGNkaz86IE5leHRqc0Rpc3RyaWJ1dGlvbkNka1Byb3BzO1xuXG4gIC8qKlxuICAgKiBCdWlsdCBOZXh0SlMgYXBwLlxuICAgKi9cbiAgcmVhZG9ubHkgbmV4dEJ1aWxkOiBOZXh0anNCdWlsZDtcblxuICAvKipcbiAgICogT3ZlcnJpZGUgdGhlIGRlZmF1bHQgQ2xvdWRGcm9udCBjYWNoZSBwb2xpY2llcyBjcmVhdGVkIGludGVybmFsbHkuXG4gICAqL1xuICByZWFkb25seSBjYWNoZVBvbGljaWVzPzogTmV4dGpzQ2FjaGVQb2xpY3lQcm9wcztcblxuICAvKipcbiAgICogT3ZlcnJpZGUgdGhlIGRlZmF1bHQgQ2xvdWRGcm9udCBsYW1iZGEgb3JpZ2luIHJlcXVlc3QgcG9saWN5IGNyZWF0ZWQgaW50ZXJuYWxseVxuICAgKi9cbiAgcmVhZG9ubHkgbGFtYmRhT3JpZ2luUmVxdWVzdFBvbGljeT86IGNsb3VkZnJvbnQuSU9yaWdpblJlcXVlc3RQb2xpY3k7XG5cbiAgLyoqXG4gICAqIFRoZSBjdXN0b21Eb21haW4gZm9yIHRoaXMgd2Vic2l0ZS4gU3VwcG9ydHMgZG9tYWlucyB0aGF0IGFyZSBob3N0ZWRcbiAgICogZWl0aGVyIG9uIFtSb3V0ZSA1M10oaHR0cHM6Ly9hd3MuYW1hem9uLmNvbS9yb3V0ZTUzLykgb3IgZXh0ZXJuYWxseS5cbiAgICpcbiAgICogTm90ZSB0aGF0IHlvdSBjYW4gYWxzbyBtaWdyYXRlIGV4dGVybmFsbHkgaG9zdGVkIGRvbWFpbnMgdG8gUm91dGUgNTMgYnlcbiAgICogW2ZvbGxvd2luZyB0aGlzIGd1aWRlXShodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vUm91dGU1My9sYXRlc3QvRGV2ZWxvcGVyR3VpZGUvTWlncmF0aW5nRE5TLmh0bWwpLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBuZXcgTmV4dGpzRGlzdHJpYnV0aW9uKHRoaXMsIFwiRGlzdFwiLCB7XG4gICAqICAgY3VzdG9tRG9tYWluOiBcImRvbWFpbi5jb21cIixcbiAgICogfSk7XG4gICAqXG4gICAqIG5ldyBOZXh0anNEaXN0cmlidXRpb24odGhpcywgXCJEaXN0XCIsIHtcbiAgICogICBjdXN0b21Eb21haW46IHtcbiAgICogICAgIGRvbWFpbk5hbWU6IFwiZG9tYWluLmNvbVwiLFxuICAgKiAgICAgZG9tYWluQWxpYXM6IFwid3d3LmRvbWFpbi5jb21cIixcbiAgICogICAgIGhvc3RlZFpvbmU6IFwiZG9tYWluLmNvbVwiXG4gICAqICAgfSxcbiAgICogfSk7XG4gICAqL1xuICByZWFkb25seSBjdXN0b21Eb21haW4/OiBzdHJpbmcgfCBOZXh0anNEb21haW5Qcm9wcztcblxuICAvKipcbiAgICogSW5jbHVkZSB0aGUgbmFtZSBvZiB5b3VyIGRlcGxveW1lbnQgc3RhZ2UgaWYgcHJlc2VudC5cbiAgICogVXNlZCB0byBuYW1lIHRoZSBlZGdlIGZ1bmN0aW9ucyBzdGFjay5cbiAgICogUmVxdWlyZWQgaWYgdXNpbmcgU1NULlxuICAgKi9cbiAgcmVhZG9ubHkgc3RhZ2VOYW1lPzogc3RyaW5nO1xufVxuXG4vKipcbiAqIENyZWF0ZSBhIENsb3VkRnJvbnQgZGlzdHJpYnV0aW9uIHRvIHNlcnZlIGEgTmV4dC5qcyBhcHBsaWNhdGlvbi5cbiAqL1xuZXhwb3J0IGNsYXNzIE5leHRqc0Rpc3RyaWJ1dGlvbiBleHRlbmRzIENvbnN0cnVjdCB7XG4gIC8qKlxuICAgKiBUaGUgZGVmYXVsdCBDbG91ZEZyb250IGNhY2hlIHBvbGljeSBwcm9wZXJ0aWVzIGZvciBzdGF0aWMgcGFnZXMuXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIHN0YXRpY0NhY2hlUG9saWN5UHJvcHM6IGNsb3VkZnJvbnQuQ2FjaGVQb2xpY3lQcm9wcyA9IHtcbiAgICBxdWVyeVN0cmluZ0JlaGF2aW9yOiBjbG91ZGZyb250LkNhY2hlUXVlcnlTdHJpbmdCZWhhdmlvci5ub25lKCksXG4gICAgaGVhZGVyQmVoYXZpb3I6IGNsb3VkZnJvbnQuQ2FjaGVIZWFkZXJCZWhhdmlvci5ub25lKCksXG4gICAgY29va2llQmVoYXZpb3I6IGNsb3VkZnJvbnQuQ2FjaGVDb29raWVCZWhhdmlvci5ub25lKCksXG4gICAgZGVmYXVsdFR0bDogRHVyYXRpb24uZGF5cygzMCksXG4gICAgbWF4VHRsOiBEdXJhdGlvbi5kYXlzKDYwKSxcbiAgICBtaW5UdGw6IER1cmF0aW9uLmRheXMoMzApLFxuICAgIGVuYWJsZUFjY2VwdEVuY29kaW5nQnJvdGxpOiB0cnVlLFxuICAgIGVuYWJsZUFjY2VwdEVuY29kaW5nR3ppcDogdHJ1ZSxcbiAgICBjb21tZW50OiAnTmV4dGpzIFN0YXRpYyBEZWZhdWx0IENhY2hlIFBvbGljeScsXG4gIH07XG5cbiAgLyoqXG4gICAqIFRoZSBkZWZhdWx0IENsb3VkRnJvbnQgY2FjaGUgcG9saWN5IHByb3BlcnRpZXMgZm9yIGltYWdlcy5cbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgaW1hZ2VDYWNoZVBvbGljeVByb3BzOiBjbG91ZGZyb250LkNhY2hlUG9saWN5UHJvcHMgPSB7XG4gICAgcXVlcnlTdHJpbmdCZWhhdmlvcjogY2xvdWRmcm9udC5DYWNoZVF1ZXJ5U3RyaW5nQmVoYXZpb3IuYWxsKCksXG4gICAgaGVhZGVyQmVoYXZpb3I6IGNsb3VkZnJvbnQuQ2FjaGVIZWFkZXJCZWhhdmlvci5hbGxvd0xpc3QoJ0FjY2VwdCcpLFxuICAgIGNvb2tpZUJlaGF2aW9yOiBjbG91ZGZyb250LkNhY2hlQ29va2llQmVoYXZpb3Iubm9uZSgpLFxuICAgIGRlZmF1bHRUdGw6IER1cmF0aW9uLmRheXMoMSksXG4gICAgbWF4VHRsOiBEdXJhdGlvbi5kYXlzKDM2NSksXG4gICAgbWluVHRsOiBEdXJhdGlvbi5kYXlzKDApLFxuICAgIGVuYWJsZUFjY2VwdEVuY29kaW5nQnJvdGxpOiB0cnVlLFxuICAgIGVuYWJsZUFjY2VwdEVuY29kaW5nR3ppcDogdHJ1ZSxcbiAgICBjb21tZW50OiAnTmV4dGpzIEltYWdlIERlZmF1bHQgQ2FjaGUgUG9saWN5JyxcbiAgfTtcblxuICAvKipcbiAgICogVGhlIGRlZmF1bHQgQ2xvdWRGcm9udCBjYWNoZSBwb2xpY3kgcHJvcGVydGllcyBmb3IgdGhlIExhbWJkYSBzZXJ2ZXIgaGFuZGxlci5cbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgbGFtYmRhQ2FjaGVQb2xpY3lQcm9wczogY2xvdWRmcm9udC5DYWNoZVBvbGljeVByb3BzID0ge1xuICAgIHF1ZXJ5U3RyaW5nQmVoYXZpb3I6IGNsb3VkZnJvbnQuQ2FjaGVRdWVyeVN0cmluZ0JlaGF2aW9yLmFsbCgpLFxuICAgIGhlYWRlckJlaGF2aW9yOiBjbG91ZGZyb250LkNhY2hlSGVhZGVyQmVoYXZpb3Iubm9uZSgpLFxuICAgIGNvb2tpZUJlaGF2aW9yOiBjbG91ZGZyb250LkNhY2hlQ29va2llQmVoYXZpb3IuYWxsKCksXG4gICAgZGVmYXVsdFR0bDogRHVyYXRpb24uc2Vjb25kcygwKSxcbiAgICBtYXhUdGw6IER1cmF0aW9uLmRheXMoMzY1KSxcbiAgICBtaW5UdGw6IER1cmF0aW9uLnNlY29uZHMoMCksXG4gICAgZW5hYmxlQWNjZXB0RW5jb2RpbmdCcm90bGk6IHRydWUsXG4gICAgZW5hYmxlQWNjZXB0RW5jb2RpbmdHemlwOiB0cnVlLFxuICAgIGNvbW1lbnQ6ICdOZXh0anMgTGFtYmRhIERlZmF1bHQgQ2FjaGUgUG9saWN5JyxcbiAgfTtcblxuICAvKipcbiAgICogVGhlIGRlZmF1bHQgQ2xvdWRGcm9udCBsYW1iZGEgb3JpZ2luIHJlcXVlc3QgcG9saWN5LlxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBsYW1iZGFPcmlnaW5SZXF1ZXN0UG9saWN5UHJvcHM6IGNsb3VkZnJvbnQuT3JpZ2luUmVxdWVzdFBvbGljeVByb3BzID0ge1xuICAgIGNvb2tpZUJlaGF2aW9yOiBjbG91ZGZyb250Lk9yaWdpblJlcXVlc3RDb29raWVCZWhhdmlvci5hbGwoKSxcbiAgICBxdWVyeVN0cmluZ0JlaGF2aW9yOiBjbG91ZGZyb250Lk9yaWdpblJlcXVlc3RRdWVyeVN0cmluZ0JlaGF2aW9yLmFsbCgpLFxuICAgIGhlYWRlckJlaGF2aW9yOiBjbG91ZGZyb250Lk9yaWdpblJlcXVlc3RIZWFkZXJCZWhhdmlvci5hbGwoKSwgLy8gY2FuJ3QgaW5jbHVkZSBob3N0XG4gICAgY29tbWVudDogJ05leHRqcyBMYW1iZGEgT3JpZ2luIFJlcXVlc3QgUG9saWN5JyxcbiAgfTtcblxuICBwcm90ZWN0ZWQgcHJvcHM6IE5leHRqc0Rpc3RyaWJ1dGlvblByb3BzO1xuXG4gIC8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAvLyBQdWJsaWMgUHJvcGVydGllc1xuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgLyoqXG4gICAqIFRoZSBpbnRlcm5hbGx5IGNyZWF0ZWQgQ2xvdWRGcm9udCBgRGlzdHJpYnV0aW9uYCBpbnN0YW5jZS5cbiAgICovXG4gIHB1YmxpYyBkaXN0cmlidXRpb246IERpc3RyaWJ1dGlvbjtcbiAgLyoqXG4gICAqIFRoZSBSb3V0ZSA1MyBob3N0ZWQgem9uZSBmb3IgdGhlIGN1c3RvbSBkb21haW4uXG4gICAqL1xuICBob3N0ZWRab25lPzogcm91dGU1My5JSG9zdGVkWm9uZTtcbiAgLyoqXG4gICAqIFRoZSBBV1MgQ2VydGlmaWNhdGUgTWFuYWdlciBjZXJ0aWZpY2F0ZSBmb3IgdGhlIGN1c3RvbSBkb21haW4uXG4gICAqL1xuICBjZXJ0aWZpY2F0ZT86IGFjbS5JQ2VydGlmaWNhdGU7XG5cbiAgcHVibGljIHRlbXBCdWlsZERpcjogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBOZXh0anNEaXN0cmlidXRpb25Qcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICAvLyBnZXQgZGlyIHRvIHN0b3JlIHRlbXAgYnVpbGQgZmlsZXMgaW5cbiAgICB0aGlzLnRlbXBCdWlsZERpciA9IHByb3BzLnRlbXBCdWlsZERpclxuICAgICAgPyBwYXRoLnJlc29sdmUoXG4gICAgICAgICAgcGF0aC5qb2luKHByb3BzLnRlbXBCdWlsZERpciwgYG5leHRqcy1jZGstYnVpbGQtJHt0aGlzLm5vZGUuaWR9LSR7dGhpcy5ub2RlLmFkZHIuc3Vic3RyaW5nKDAsIDQpfWApXG4gICAgICAgIClcbiAgICAgIDogZnMubWtkdGVtcFN5bmMocGF0aC5qb2luKG9zLnRtcGRpcigpLCAnbmV4dGpzLWNkay1idWlsZC0nKSk7XG5cbiAgICAvLyBzYXZlIHByb3BzXG4gICAgdGhpcy5wcm9wcyA9IHsgLi4ucHJvcHMsIHRlbXBCdWlsZERpcjogdGhpcy50ZW1wQnVpbGREaXIgfTtcblxuICAgIC8vIENyZWF0ZSBDdXN0b20gRG9tYWluXG4gICAgdGhpcy52YWxpZGF0ZUN1c3RvbURvbWFpblNldHRpbmdzKCk7XG4gICAgdGhpcy5ob3N0ZWRab25lID0gdGhpcy5sb29rdXBIb3N0ZWRab25lKCk7XG4gICAgdGhpcy5jZXJ0aWZpY2F0ZSA9IHRoaXMuY3JlYXRlQ2VydGlmaWNhdGUoKTtcblxuICAgIC8vIENyZWF0ZSBDbG91ZEZyb250XG4gICAgdGhpcy5kaXN0cmlidXRpb24gPSB0aGlzLnByb3BzLmlzUGxhY2Vob2xkZXJcbiAgICAgID8gdGhpcy5jcmVhdGVDbG91ZEZyb250RGlzdHJpYnV0aW9uRm9yU3R1YigpXG4gICAgICA6IHRoaXMuY3JlYXRlQ2xvdWRGcm9udERpc3RyaWJ1dGlvbigpO1xuXG4gICAgLy8gQ29ubmVjdCBDdXN0b20gRG9tYWluIHRvIENsb3VkRnJvbnQgRGlzdHJpYnV0aW9uXG4gICAgdGhpcy5jcmVhdGVSb3V0ZTUzUmVjb3JkcygpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBDbG91ZEZyb250IFVSTCBvZiB0aGUgd2Vic2l0ZS5cbiAgICovXG4gIHB1YmxpYyBnZXQgdXJsKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGBodHRwczovLyR7dGhpcy5kaXN0cmlidXRpb24uZGlzdHJpYnV0aW9uRG9tYWluTmFtZX1gO1xuICB9XG5cbiAgLyoqXG4gICAqIElmIHRoZSBjdXN0b20gZG9tYWluIGlzIGVuYWJsZWQsIHRoaXMgaXMgdGhlIFVSTCBvZiB0aGUgd2Vic2l0ZSB3aXRoIHRoZVxuICAgKiBjdXN0b20gZG9tYWluLlxuICAgKi9cbiAgcHVibGljIGdldCBjdXN0b21Eb21haW5VcmwoKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCB7IGN1c3RvbURvbWFpbiB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAoIWN1c3RvbURvbWFpbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluID09PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIGBodHRwczovLyR7Y3VzdG9tRG9tYWlufWA7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBgaHR0cHM6Ly8ke2N1c3RvbURvbWFpbi5kb21haW5OYW1lfWA7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBJRCBvZiB0aGUgaW50ZXJuYWxseSBjcmVhdGVkIENsb3VkRnJvbnQgRGlzdHJpYnV0aW9uLlxuICAgKi9cbiAgcHVibGljIGdldCBkaXN0cmlidXRpb25JZCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmRpc3RyaWJ1dGlvbi5kaXN0cmlidXRpb25JZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgZG9tYWluIG5hbWUgb2YgdGhlIGludGVybmFsbHkgY3JlYXRlZCBDbG91ZEZyb250IERpc3RyaWJ1dGlvbi5cbiAgICovXG4gIHB1YmxpYyBnZXQgZGlzdHJpYnV0aW9uRG9tYWluKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuZGlzdHJpYnV0aW9uLmRpc3RyaWJ1dGlvbkRvbWFpbk5hbWU7XG4gIH1cblxuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgLy8gQ2xvdWRGcm9udCBEaXN0cmlidXRpb25cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgcHJpdmF0ZSBjcmVhdGVDbG91ZEZyb250RGlzdHJpYnV0aW9uKCk6IGNsb3VkZnJvbnQuRGlzdHJpYnV0aW9uIHtcbiAgICBjb25zdCB7IGNkazogY2RrUHJvcHMsIGNhY2hlUG9saWNpZXMsIGxhbWJkYU9yaWdpblJlcXVlc3RQb2xpY3k6IGxhbWJkYU9yaWdpblJlcXVlc3RQb2xpY3lPdmVycmlkZSB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCBjZkRpc3RyaWJ1dGlvblByb3BzID0gY2RrUHJvcHM/LmRpc3RyaWJ1dGlvbjtcblxuICAgIC8vIGJ1aWxkIGRvbWFpbk5hbWVzXG4gICAgY29uc3QgZG9tYWluTmFtZXMgPSB0aGlzLmJ1aWxkRGlzdHJpYnV0aW9uRG9tYWluTmFtZXMoKTtcblxuICAgIC8vIFMzIG9yaWdpblxuICAgIGNvbnN0IHMzT3JpZ2luID0gbmV3IG9yaWdpbnMuUzNPcmlnaW4odGhpcy5wcm9wcy5zdGF0aWNBc3NldHNCdWNrZXQpO1xuXG4gICAgY29uc3Qgdmlld2VyUHJvdG9jb2xQb2xpY3kgPSBjbG91ZGZyb250LlZpZXdlclByb3RvY29sUG9saWN5LlJFRElSRUNUX1RPX0hUVFBTO1xuXG4gICAgLy8gaGFuZGxlIHBsYWNlaG9sZGVyXG4gICAgaWYgKHRoaXMucHJvcHMuaXNQbGFjZWhvbGRlcikge1xuICAgICAgcmV0dXJuIG5ldyBjbG91ZGZyb250LkRpc3RyaWJ1dGlvbih0aGlzLCAnRGlzdHJpYnV0aW9uJywge1xuICAgICAgICBkZWZhdWx0Um9vdE9iamVjdDogJ2luZGV4Lmh0bWwnLFxuICAgICAgICBlcnJvclJlc3BvbnNlczogYnVpbGRFcnJvclJlc3BvbnNlc0ZvclJlZGlyZWN0VG9JbmRleCgnaW5kZXguaHRtbCcpLFxuICAgICAgICBkb21haW5OYW1lcyxcbiAgICAgICAgY2VydGlmaWNhdGU6IHRoaXMuY2VydGlmaWNhdGUsXG4gICAgICAgIGRlZmF1bHRCZWhhdmlvcjoge1xuICAgICAgICAgIG9yaWdpbjogczNPcmlnaW4sXG4gICAgICAgICAgdmlld2VyUHJvdG9jb2xQb2xpY3ksXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBjYWNoZSBwb2xpY2llc1xuICAgIGNvbnN0IHN0YXRpY0NhY2hlUG9saWN5ID0gY2FjaGVQb2xpY2llcz8uc3RhdGljQ2FjaGVQb2xpY3kgPz8gdGhpcy5jcmVhdGVDbG91ZEZyb250U3RhdGljQ2FjaGVQb2xpY3koKTtcbiAgICBjb25zdCBpbWFnZUNhY2hlUG9saWN5ID0gY2FjaGVQb2xpY2llcz8uaW1hZ2VDYWNoZVBvbGljeSA/PyB0aGlzLmNyZWF0ZUNsb3VkRnJvbnRJbWFnZUNhY2hlUG9saWN5KCk7XG5cbiAgICAvLyBvcmlnaW4gcmVxdWVzdCBwb2xpY2llc1xuICAgIGNvbnN0IGxhbWJkYU9yaWdpblJlcXVlc3RQb2xpY3kgPSBsYW1iZGFPcmlnaW5SZXF1ZXN0UG9saWN5T3ZlcnJpZGUgPz8gdGhpcy5jcmVhdGVMYW1iZGFPcmlnaW5SZXF1ZXN0UG9saWN5KCk7XG5cbiAgICAvLyBtYWluIHNlcnZlciBmdW5jdGlvbiBvcmlnaW4gKGxhbWJkYSBVUkwgSFRUUCBvcmlnaW4pXG4gICAgY29uc3QgZm5VcmwgPSB0aGlzLnByb3BzLnNlcnZlckZ1bmN0aW9uLmFkZEZ1bmN0aW9uVXJsKHtcbiAgICAgIGF1dGhUeXBlOiBsYW1iZGEuRnVuY3Rpb25VcmxBdXRoVHlwZS5OT05FLFxuICAgIH0pO1xuICAgIGNvbnN0IHNlcnZlckZ1bmN0aW9uT3JpZ2luID0gbmV3IG9yaWdpbnMuSHR0cE9yaWdpbihGbi5wYXJzZURvbWFpbk5hbWUoZm5VcmwudXJsKSwge1xuICAgICAgY3VzdG9tSGVhZGVyczoge1xuICAgICAgICAvLyBwcm92aWRlIGNvbmZpZyB0byBlZGdlIGxhbWJkYSBmdW5jdGlvblxuICAgICAgICAneC1vcmlnaW4tdXJsJzogZm5VcmwudXJsLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIEltYWdlIE9wdGltaXphdGlvblxuICAgIGNvbnN0IGltYWdlT3B0Rm5VcmwgPSB0aGlzLnByb3BzLmltYWdlT3B0RnVuY3Rpb24uYWRkRnVuY3Rpb25Vcmwoe1xuICAgICAgYXV0aFR5cGU6IGxhbWJkYS5GdW5jdGlvblVybEF1dGhUeXBlLk5PTkUsXG4gICAgfSk7XG4gICAgY29uc3QgaW1hZ2VPcHRGdW5jdGlvbk9yaWdpbiA9IG5ldyBvcmlnaW5zLkh0dHBPcmlnaW4oRm4ucGFyc2VEb21haW5OYW1lKGltYWdlT3B0Rm5VcmwudXJsKSk7XG4gICAgY29uc3QgaW1hZ2VPcHRPUlAgPSBuZXcgY2xvdWRmcm9udC5PcmlnaW5SZXF1ZXN0UG9saWN5KHRoaXMsICdJbWFnZU9wdFBvbGljeScsIHtcbiAgICAgIHF1ZXJ5U3RyaW5nQmVoYXZpb3I6IGNsb3VkZnJvbnQuT3JpZ2luUmVxdWVzdFF1ZXJ5U3RyaW5nQmVoYXZpb3IuYWxsb3dMaXN0KCdxJywgJ3cnLCAndXJsJyksXG4gICAgICBoZWFkZXJCZWhhdmlvcjogY2xvdWRmcm9udC5PcmlnaW5SZXF1ZXN0SGVhZGVyQmVoYXZpb3IuYWxsb3dMaXN0KCdhY2NlcHQnKSxcbiAgICAgIGNvb2tpZUJlaGF2aW9yOiBjbG91ZGZyb250Lk9yaWdpblJlcXVlc3RDb29raWVCZWhhdmlvci5ub25lKCksXG4gICAgfSk7XG5cbiAgICAvLyBsYW1iZGEgYmVoYXZpb3IgZWRnZSBmdW5jdGlvblxuICAgIGNvbnN0IGxhbWJkYU9yaWdpblJlcXVlc3RFZGdlRm4gPSB0aGlzLmJ1aWxkTGFtYmRhT3JpZ2luUmVxdWVzdEVkZ2VGdW5jdGlvbigpO1xuICAgIGNvbnN0IGxhbWJkYU9yaWdpblJlcXVlc3RFZGdlRm5WZXJzaW9uID0gbGFtYmRhLlZlcnNpb24uZnJvbVZlcnNpb25Bcm4oXG4gICAgICB0aGlzLFxuICAgICAgJ1ZlcnNpb24nLFxuICAgICAgbGFtYmRhT3JpZ2luUmVxdWVzdEVkZ2VGbi5jdXJyZW50VmVyc2lvbi5mdW5jdGlvbkFyblxuICAgICk7XG4gICAgY29uc3QgbGFtYmRhT3JpZ2luRWRnZUZuczogY2xvdWRmcm9udC5FZGdlTGFtYmRhW10gPSBbXG4gICAgICB7XG4gICAgICAgIGV2ZW50VHlwZTogY2xvdWRmcm9udC5MYW1iZGFFZGdlRXZlbnRUeXBlLk9SSUdJTl9SRVFVRVNULFxuICAgICAgICBmdW5jdGlvblZlcnNpb246IGxhbWJkYU9yaWdpblJlcXVlc3RFZGdlRm5WZXJzaW9uLFxuICAgICAgICBpbmNsdWRlQm9keTogZmFsc2UsXG4gICAgICB9LFxuICAgIF07XG5cbiAgICAvLyBkZWZhdWx0IGhhbmRsZXIgZm9yIHJlcXVlc3RzIHRoYXQgZG9uJ3QgbWF0Y2ggYW55IG90aGVyIHBhdGg6XG4gICAgLy8gICAtIHRyeSBsYW1iZGEgaGFuZGxlciBmaXJzdCAoL3NvbWUtcGFnZSwgZXRjLi4uKVxuICAgIC8vICAgLSBpZiA0MDMsIGZhbGwgYmFjayB0byBTM1xuICAgIC8vICAgLSBpZiA0MDQsIGZhbGwgYmFjayB0byBsYW1iZGEgaGFuZGxlclxuICAgIGNvbnN0IGZhbGxiYWNrT3JpZ2luR3JvdXAgPSBuZXcgb3JpZ2lucy5PcmlnaW5Hcm91cCh7XG4gICAgICBwcmltYXJ5T3JpZ2luOiBzZXJ2ZXJGdW5jdGlvbk9yaWdpbixcbiAgICAgIGZhbGxiYWNrT3JpZ2luOiBzM09yaWdpbixcbiAgICAgIGZhbGxiYWNrU3RhdHVzQ29kZXM6IFs0MDMsIDQwNF0sXG4gICAgfSk7XG5cbiAgICBjb25zdCBsYW1iZGFDYWNoZVBvbGljeSA9IGNhY2hlUG9saWNpZXM/LmxhbWJkYUNhY2hlUG9saWN5ID8/IHRoaXMuY3JlYXRlQ2xvdWRGcm9udExhbWJkYUNhY2hlUG9saWN5KCk7XG5cbiAgICAvLyByZXF1ZXN0cyBmb3Igc3RhdGljIG9iamVjdHNcbiAgICBjb25zdCBkZWZhdWx0U3RhdGljTWF4QWdlID0gY2FjaGVQb2xpY2llcz8uc3RhdGljQ2xpZW50TWF4QWdlRGVmYXVsdD8udG9TZWNvbmRzKCkgfHwgREVGQVVMVF9TVEFUSUNfTUFYX0FHRTtcbiAgICBjb25zdCBzdGF0aWNSZXNwb25zZUhlYWRlcnNQb2xpY3kgPSBuZXcgUmVzcG9uc2VIZWFkZXJzUG9saWN5KHRoaXMsICdTdGF0aWNSZXNwb25zZUhlYWRlcnNQb2xpY3knLCB7XG4gICAgICAvLyBhZGQgZGVmYXVsdCBoZWFkZXIgZm9yIHN0YXRpYyBhc3NldHNcbiAgICAgIGN1c3RvbUhlYWRlcnNCZWhhdmlvcjoge1xuICAgICAgICBjdXN0b21IZWFkZXJzOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgaGVhZGVyOiAnY2FjaGUtY29udHJvbCcsXG4gICAgICAgICAgICBvdmVycmlkZTogZmFsc2UsXG4gICAgICAgICAgICAvLyBieSBkZWZhdWx0IHRlbGwgYnJvd3NlciB0byBjYWNoZSBzdGF0aWMgZmlsZXMgZm9yIHRoaXMgbG9uZ1xuICAgICAgICAgICAgLy8gdGhpcyBpcyBzZXBhcmF0ZSBmcm9tIHRoZSBvcmlnaW4gY2FjaGUgcG9saWN5XG4gICAgICAgICAgICB2YWx1ZTogYHB1YmxpYyxtYXgtYWdlPSR7ZGVmYXVsdFN0YXRpY01heEFnZX0saW1tdXRhYmxlYCxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICBjb25zdCBzdGF0aWNCZWhhdmlvcjogY2xvdWRmcm9udC5CZWhhdmlvck9wdGlvbnMgPSB7XG4gICAgICB2aWV3ZXJQcm90b2NvbFBvbGljeSxcbiAgICAgIG9yaWdpbjogczNPcmlnaW4sXG4gICAgICBhbGxvd2VkTWV0aG9kczogY2xvdWRmcm9udC5BbGxvd2VkTWV0aG9kcy5BTExPV19HRVRfSEVBRF9PUFRJT05TLFxuICAgICAgY2FjaGVkTWV0aG9kczogY2xvdWRmcm9udC5DYWNoZWRNZXRob2RzLkNBQ0hFX0dFVF9IRUFEX09QVElPTlMsXG4gICAgICBjb21wcmVzczogdHJ1ZSxcbiAgICAgIGNhY2hlUG9saWN5OiBzdGF0aWNDYWNoZVBvbGljeSxcbiAgICAgIHJlc3BvbnNlSGVhZGVyc1BvbGljeTogc3RhdGljUmVzcG9uc2VIZWFkZXJzUG9saWN5LFxuICAgIH07XG5cbiAgICAvLyByZXF1ZXN0cyBnb2luZyB0byBsYW1iZGEgKGFwaSwgZXRjKVxuICAgIGNvbnN0IGxhbWJkYUJlaGF2aW9yOiBjbG91ZGZyb250LkJlaGF2aW9yT3B0aW9ucyA9IHtcbiAgICAgIHZpZXdlclByb3RvY29sUG9saWN5LFxuICAgICAgb3JpZ2luOiBzZXJ2ZXJGdW5jdGlvbk9yaWdpbixcbiAgICAgIGFsbG93ZWRNZXRob2RzOiBjbG91ZGZyb250LkFsbG93ZWRNZXRob2RzLkFMTE9XX0FMTCxcbiAgICAgIC8vIGNhY2hlZE1ldGhvZHM6IGNsb3VkZnJvbnQuQ2FjaGVkTWV0aG9kcy5DQUNIRV9HRVRfSEVBRF9PUFRJT05TLCAvLyB0aGlzIHNob3VsZCBiZSBjb25maWd1cmFibGVcbiAgICAgIG9yaWdpblJlcXVlc3RQb2xpY3k6IGxhbWJkYU9yaWdpblJlcXVlc3RQb2xpY3ksXG4gICAgICBjb21wcmVzczogdHJ1ZSxcbiAgICAgIGNhY2hlUG9saWN5OiBjbG91ZGZyb250LkNhY2hlUG9saWN5LkNBQ0hJTkdfRElTQUJMRUQsXG4gICAgICBlZGdlTGFtYmRhczogbGFtYmRhT3JpZ2luRWRnZUZucyxcbiAgICB9O1xuXG4gICAgLy8gcmVxdWVzdHMgdG8gZmFsbGJhY2sgb3JpZ2luIGdyb3VwIChkZWZhdWx0IGJlaGF2aW9yKVxuICAgIC8vIHVzZWQgZm9yIFMzIGFuZCBsYW1iZGEuIHdvdWxkIHByZWZlciB0byBmb3J3YXJkIGFsbCBoZWFkZXJzIHRvIGxhbWJkYSBidXQgbmVlZCB0byBzdHJpcCBvdXQgaG9zdFxuICAgIC8vIFRPRE86IHRyeSB0byBkbyB0aGlzIHdpdGggaGVhZGVycyB3aGl0ZWxpc3Qgb3IgZWRnZSBsYW1iZGFcbiAgICBjb25zdCBmYWxsYmFja09yaWdpblJlcXVlc3RQb2xpY3kgPSBuZXcgY2xvdWRmcm9udC5PcmlnaW5SZXF1ZXN0UG9saWN5KHRoaXMsICdGYWxsYmFja09yaWdpblJlcXVlc3RQb2xpY3knLCB7XG4gICAgICBjb29raWVCZWhhdmlvcjogY2xvdWRmcm9udC5PcmlnaW5SZXF1ZXN0Q29va2llQmVoYXZpb3IuYWxsKCksIC8vIHByZXR0eSBtdWNoIGRpc2FibGVzIGNhY2hpbmcgLSBtYXliZSBjYW4gYmUgY2hhbmdlZFxuICAgICAgcXVlcnlTdHJpbmdCZWhhdmlvcjogY2xvdWRmcm9udC5PcmlnaW5SZXF1ZXN0UXVlcnlTdHJpbmdCZWhhdmlvci5hbGwoKSxcbiAgICAgIGhlYWRlckJlaGF2aW9yOiBjbG91ZGZyb250Lk9yaWdpblJlcXVlc3RIZWFkZXJCZWhhdmlvci5hbGwoKSxcbiAgICAgIGNvbW1lbnQ6ICdOZXh0anMgRmFsbGJhY2sgT3JpZ2luIFJlcXVlc3QgUG9saWN5JyxcbiAgICB9KTtcblxuICAgIC8vIGlmIHdlIGRvbid0IGhhdmUgYSBzdGF0aWMgZmlsZSBjYWxsZWQgaW5kZXguaHRtbCB0aGVuIHdlIHNob3VsZFxuICAgIC8vIHJlZGlyZWN0IHRvIHRoZSBsYW1iZGEgaGFuZGxlclxuICAgIGNvbnN0IGhhc0luZGV4SHRtbCA9IHRoaXMucHJvcHMubmV4dEJ1aWxkLnJlYWRQdWJsaWNGaWxlTGlzdCgpLmluY2x1ZGVzKCdpbmRleC5odG1sJyk7XG5cbiAgICByZXR1cm4gbmV3IGNsb3VkZnJvbnQuRGlzdHJpYnV0aW9uKHRoaXMsICdEaXN0cmlidXRpb24nLCB7XG4gICAgICAvLyBkZWZhdWx0Um9vdE9iamVjdDogXCJpbmRleC5odG1sXCIsXG4gICAgICBkZWZhdWx0Um9vdE9iamVjdDogJycsXG5cbiAgICAgIC8vIE92ZXJyaWRlIHByb3BzLlxuICAgICAgLi4uY2ZEaXN0cmlidXRpb25Qcm9wcyxcblxuICAgICAgLy8gdGhlc2UgdmFsdWVzIGNhbiBOT1QgYmUgb3ZlcndyaXR0ZW4gYnkgY2ZEaXN0cmlidXRpb25Qcm9wc1xuICAgICAgZG9tYWluTmFtZXMsXG4gICAgICBjZXJ0aWZpY2F0ZTogdGhpcy5jZXJ0aWZpY2F0ZSxcbiAgICAgIGRlZmF1bHRCZWhhdmlvcjoge1xuICAgICAgICBvcmlnaW46IGZhbGxiYWNrT3JpZ2luR3JvdXAsIC8vIHRyeSBTMyBmaXJzdCwgdGhlbiBsYW1iZGFcbiAgICAgICAgdmlld2VyUHJvdG9jb2xQb2xpY3k6IGNsb3VkZnJvbnQuVmlld2VyUHJvdG9jb2xQb2xpY3kuUkVESVJFQ1RfVE9fSFRUUFMsXG4gICAgICAgIGNvbXByZXNzOiB0cnVlLFxuXG4gICAgICAgIC8vIHdoYXQgZ29lcyBoZXJlPyBzdGF0aWMgb3IgbGFtYmRhP1xuICAgICAgICBjYWNoZVBvbGljeTogbGFtYmRhQ2FjaGVQb2xpY3ksXG4gICAgICAgIG9yaWdpblJlcXVlc3RQb2xpY3k6IGZhbGxiYWNrT3JpZ2luUmVxdWVzdFBvbGljeSxcblxuICAgICAgICBlZGdlTGFtYmRhczogbGFtYmRhT3JpZ2luRWRnZUZucyxcbiAgICAgIH0sXG5cbiAgICAgIGFkZGl0aW9uYWxCZWhhdmlvcnM6IHtcbiAgICAgICAgLy8gaXMgaW5kZXguaHRtbCBzdGF0aWMgb3IgZHluYW1pYz9cbiAgICAgICAgLi4uKGhhc0luZGV4SHRtbCA/IHt9IDogeyAnLyc6IGxhbWJkYUJlaGF2aW9yIH0pLFxuXG4gICAgICAgIC8vIGtub3duIGR5bmFtaWMgcm91dGVzXG4gICAgICAgICdhcGkvKic6IGxhbWJkYUJlaGF2aW9yLFxuICAgICAgICAnX25leHQvZGF0YS8qJzogbGFtYmRhQmVoYXZpb3IsXG5cbiAgICAgICAgLy8gZHluYW1pYyBpbWFnZXMgZ28gdG8gbGFtYmRhXG4gICAgICAgICdfbmV4dC9pbWFnZSonOiB7XG4gICAgICAgICAgdmlld2VyUHJvdG9jb2xQb2xpY3ksXG4gICAgICAgICAgb3JpZ2luOiBpbWFnZU9wdEZ1bmN0aW9uT3JpZ2luLFxuICAgICAgICAgIGFsbG93ZWRNZXRob2RzOiBjbG91ZGZyb250LkFsbG93ZWRNZXRob2RzLkFMTE9XX0dFVF9IRUFEX09QVElPTlMsXG4gICAgICAgICAgY2FjaGVkTWV0aG9kczogY2xvdWRmcm9udC5DYWNoZWRNZXRob2RzLkNBQ0hFX0dFVF9IRUFEX09QVElPTlMsXG4gICAgICAgICAgY29tcHJlc3M6IHRydWUsXG4gICAgICAgICAgY2FjaGVQb2xpY3k6IGltYWdlQ2FjaGVQb2xpY3ksXG4gICAgICAgICAgb3JpZ2luUmVxdWVzdFBvbGljeTogaW1hZ2VPcHRPUlAsXG4gICAgICAgIH0sXG5cbiAgICAgICAgLy8ga25vd24gc3RhdGljIHJvdXRlc1xuICAgICAgICAvLyBpdCB3b3VsZCBiZSBuaWNlIHRvIGNyZWF0ZSByb3V0ZXMgZm9yIGFsbCB0aGUgc3RhdGljIGZpbGVzIHdlIGtub3cgb2ZcbiAgICAgICAgLy8gYnV0IHdlIHJ1biBpbnRvIHRoZSBsaW1pdCBvZiBDYWNoZUJlaGF2aW9ycyBwZXIgZGlzdHJpYnV0aW9uXG4gICAgICAgICdfbmV4dC8qJzogc3RhdGljQmVoYXZpb3IsXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVDbG91ZEZyb250U3RhdGljQ2FjaGVQb2xpY3koKTogY2xvdWRmcm9udC5DYWNoZVBvbGljeSB7XG4gICAgcmV0dXJuIG5ldyBjbG91ZGZyb250LkNhY2hlUG9saWN5KHRoaXMsICdTdGF0aWNzQ2FjaGUnLCBOZXh0anNEaXN0cmlidXRpb24uc3RhdGljQ2FjaGVQb2xpY3lQcm9wcyk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUNsb3VkRnJvbnRJbWFnZUNhY2hlUG9saWN5KCk6IGNsb3VkZnJvbnQuQ2FjaGVQb2xpY3kge1xuICAgIHJldHVybiBuZXcgY2xvdWRmcm9udC5DYWNoZVBvbGljeSh0aGlzLCAnSW1hZ2VDYWNoZScsIE5leHRqc0Rpc3RyaWJ1dGlvbi5pbWFnZUNhY2hlUG9saWN5UHJvcHMpO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVMYW1iZGFPcmlnaW5SZXF1ZXN0UG9saWN5KCk6IGNsb3VkZnJvbnQuT3JpZ2luUmVxdWVzdFBvbGljeSB7XG4gICAgcmV0dXJuIG5ldyBjbG91ZGZyb250Lk9yaWdpblJlcXVlc3RQb2xpY3koXG4gICAgICB0aGlzLFxuICAgICAgJ0xhbWJkYU9yaWdpblBvbGljeScsXG4gICAgICBOZXh0anNEaXN0cmlidXRpb24ubGFtYmRhT3JpZ2luUmVxdWVzdFBvbGljeVByb3BzXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQ2xvdWRGcm9udExhbWJkYUNhY2hlUG9saWN5KCk6IGNsb3VkZnJvbnQuQ2FjaGVQb2xpY3kge1xuICAgIHJldHVybiBuZXcgY2xvdWRmcm9udC5DYWNoZVBvbGljeSh0aGlzLCAnTGFtYmRhQ2FjaGUnLCBOZXh0anNEaXN0cmlidXRpb24ubGFtYmRhQ2FjaGVQb2xpY3lQcm9wcyk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUNsb3VkRnJvbnREaXN0cmlidXRpb25Gb3JTdHViKCk6IGNsb3VkZnJvbnQuRGlzdHJpYnV0aW9uIHtcbiAgICByZXR1cm4gbmV3IGNsb3VkZnJvbnQuRGlzdHJpYnV0aW9uKHRoaXMsICdEaXN0cmlidXRpb24nLCB7XG4gICAgICBkZWZhdWx0Um9vdE9iamVjdDogJ2luZGV4Lmh0bWwnLFxuICAgICAgZXJyb3JSZXNwb25zZXM6IGJ1aWxkRXJyb3JSZXNwb25zZXNGb3JSZWRpcmVjdFRvSW5kZXgoJ2luZGV4Lmh0bWwnKSxcbiAgICAgIGRvbWFpbk5hbWVzOiB0aGlzLmJ1aWxkRGlzdHJpYnV0aW9uRG9tYWluTmFtZXMoKSxcbiAgICAgIGNlcnRpZmljYXRlOiB0aGlzLmNlcnRpZmljYXRlLFxuICAgICAgZGVmYXVsdEJlaGF2aW9yOiB7XG4gICAgICAgIG9yaWdpbjogbmV3IG9yaWdpbnMuUzNPcmlnaW4odGhpcy5wcm9wcy5zdGF0aWNBc3NldHNCdWNrZXQpLFxuICAgICAgICB2aWV3ZXJQcm90b2NvbFBvbGljeTogY2xvdWRmcm9udC5WaWV3ZXJQcm90b2NvbFBvbGljeS5SRURJUkVDVF9UT19IVFRQUyxcbiAgICAgIH0sXG4gICAgICAuLi50aGlzLnByb3BzLmNkaz8uZGlzdHJpYnV0aW9uLCAvLyBub3Qgc3VyZSBpZiBuZWVkZWRcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGREaXN0cmlidXRpb25Eb21haW5OYW1lcygpOiBzdHJpbmdbXSB7XG4gICAgY29uc3QgeyBjdXN0b21Eb21haW4gfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgZG9tYWluTmFtZXMgPSBbXTtcbiAgICBpZiAoIWN1c3RvbURvbWFpbikge1xuICAgICAgLy8gbm8gZG9tYWluXG4gICAgfSBlbHNlIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluID09PSAnc3RyaW5nJykge1xuICAgICAgZG9tYWluTmFtZXMucHVzaChjdXN0b21Eb21haW4pO1xuICAgIH0gZWxzZSB7XG4gICAgICBkb21haW5OYW1lcy5wdXNoKGN1c3RvbURvbWFpbi5kb21haW5OYW1lKTtcbiAgICB9XG4gICAgcmV0dXJuIGRvbWFpbk5hbWVzO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhbiBlZGdlIGZ1bmN0aW9uIHRvIGhhbmRsZSByZXF1ZXN0cyB0byB0aGUgbGFtYmRhIHNlcnZlciBoYW5kbGVyIG9yaWdpbi5cbiAgICogSXQgb3ZlcnJpZGVzIHRoZSBob3N0IGhlYWRlciBpbiB0aGUgcmVxdWVzdCB0byBiZSB0aGUgbGFtYmRhIFVSTCdzIGhvc3QuXG4gICAqIEl0J3MgbmVlZGVkIGJlY2F1c2Ugd2UgZm9yd2FyZCBhbGwgaGVhZGVycyB0byB0aGUgb3JpZ2luLCBidXQgdGhlIG9yaWdpbiBpcyBpdHNlbGYgYW5cbiAgICogIEhUVFAgc2VydmVyIHNvIGl0IG5lZWRzIHRoZSBob3N0IGhlYWRlciB0byBiZSB0aGUgYWRkcmVzcyBvZiB0aGUgbGFtYmRhIGFuZCBub3RcbiAgICogIHRoZSBkaXN0cmlidXRpb24uXG4gICAqXG4gICAqL1xuICBwcml2YXRlIGJ1aWxkTGFtYmRhT3JpZ2luUmVxdWVzdEVkZ2VGdW5jdGlvbigpIHtcbiAgICBjb25zdCBhcHAgPSBBcHAub2YodGhpcykgYXMgQXBwO1xuXG4gICAgLy8gYnVuZGxlIHRoZSBlZGdlIGZ1bmN0aW9uXG4gICAgY29uc3QgaW5wdXRQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uJywgJ2Fzc2V0cycsICdsYW1iZGFAZWRnZScsICdMYW1iZGFPcmlnaW5SZXF1ZXN0Jyk7XG4gICAgY29uc3Qgb3V0cHV0UGF0aCA9IHBhdGguam9pbih0aGlzLnRlbXBCdWlsZERpciwgJ2xhbWJkYUBlZGdlJywgJ0xhbWJkYU9yaWdpblJlcXVlc3QuanMnKTtcbiAgICBidW5kbGVGdW5jdGlvbih7XG4gICAgICBpbnB1dFBhdGgsXG4gICAgICBvdXRwdXRQYXRoLFxuICAgICAgYnVuZGxlT3B0aW9uczoge1xuICAgICAgICBidW5kbGU6IHRydWUsXG4gICAgICAgIGV4dGVybmFsOiBbJ2F3cy1zZGsnLCAndXJsJ10sXG4gICAgICAgIG1pbmlmeTogdHJ1ZSxcbiAgICAgICAgdGFyZ2V0OiAnbm9kZTE2JyxcbiAgICAgICAgcGxhdGZvcm06ICdub2RlJyxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBjb25zdCBmbiA9IG5ldyBjbG91ZGZyb250LmV4cGVyaW1lbnRhbC5FZGdlRnVuY3Rpb24odGhpcywgJ0RlZmF1bHRPcmlnaW5SZXF1ZXN0RWRnZUZuJywge1xuICAgICAgcnVudGltZTogTEFNQkRBX1JVTlRJTUUsXG4gICAgICAvLyByb2xlLFxuICAgICAgaGFuZGxlcjogJ0xhbWJkYU9yaWdpblJlcXVlc3QuaGFuZGxlcicsXG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQoZGlybmFtZShvdXRwdXRQYXRoKSksXG4gICAgICBjdXJyZW50VmVyc2lvbk9wdGlvbnM6IHtcbiAgICAgICAgcmVtb3ZhbFBvbGljeTogUmVtb3ZhbFBvbGljeS5ERVNUUk9ZLCAvLyBkZXN0cm95IG9sZCB2ZXJzaW9uc1xuICAgICAgICByZXRyeUF0dGVtcHRzOiAxLCAvLyBhc3luYyByZXRyeSBhdHRlbXB0c1xuICAgICAgfSxcbiAgICAgIHN0YWNrSWQ6XG4gICAgICAgIGBOZXh0anMtJHt0aGlzLnByb3BzLnN0YWdlTmFtZSB8fCBhcHAuc3RhZ2VOYW1lIHx8ICdkZWZhdWx0J30tRWRnZUZ1bmN0aW9ucy1gICsgdGhpcy5ub2RlLmFkZHIuc3Vic3RyaW5nKDAsIDUpLFxuICAgIH0pO1xuICAgIGZuLmN1cnJlbnRWZXJzaW9uLmdyYW50SW52b2tlKG5ldyBTZXJ2aWNlUHJpbmNpcGFsKCdlZGdlbGFtYmRhLmFtYXpvbmF3cy5jb20nKSk7XG4gICAgZm4uY3VycmVudFZlcnNpb24uZ3JhbnRJbnZva2UobmV3IFNlcnZpY2VQcmluY2lwYWwoJ2xhbWJkYS5hbWF6b25hd3MuY29tJykpO1xuXG4gICAgcmV0dXJuIGZuO1xuICB9XG5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gIC8vIEN1c3RvbSBEb21haW5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgcHJvdGVjdGVkIHZhbGlkYXRlQ3VzdG9tRG9tYWluU2V0dGluZ3MoKSB7XG4gICAgY29uc3QgeyBjdXN0b21Eb21haW4gfSA9IHRoaXMucHJvcHM7XG5cbiAgICBpZiAoIWN1c3RvbURvbWFpbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluID09PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChjdXN0b21Eb21haW4uaXNFeHRlcm5hbERvbWFpbiA9PT0gdHJ1ZSkge1xuICAgICAgaWYgKCFjdXN0b21Eb21haW4uY2VydGlmaWNhdGUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBIHZhbGlkIGNlcnRpZmljYXRlIGlzIHJlcXVpcmVkIHdoZW4gXCJpc0V4dGVybmFsRG9tYWluXCIgaXMgc2V0IHRvIFwidHJ1ZVwiLicpO1xuICAgICAgfVxuICAgICAgaWYgKGN1c3RvbURvbWFpbi5kb21haW5BbGlhcykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgJ0RvbWFpbiBhbGlhcyBpcyBvbmx5IHN1cHBvcnRlZCBmb3IgZG9tYWlucyBob3N0ZWQgb24gQW1hem9uIFJvdXRlIDUzLiBEbyBub3Qgc2V0IHRoZSBcImN1c3RvbURvbWFpbi5kb21haW5BbGlhc1wiIHdoZW4gXCJpc0V4dGVybmFsRG9tYWluXCIgaXMgZW5hYmxlZC4nXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoY3VzdG9tRG9tYWluLmhvc3RlZFpvbmUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICdIb3N0ZWQgem9uZXMgY2FuIG9ubHkgYmUgY29uZmlndXJlZCBmb3IgZG9tYWlucyBob3N0ZWQgb24gQW1hem9uIFJvdXRlIDUzLiBEbyBub3Qgc2V0IHRoZSBcImN1c3RvbURvbWFpbi5ob3N0ZWRab25lXCIgd2hlbiBcImlzRXh0ZXJuYWxEb21haW5cIiBpcyBlbmFibGVkLidcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgbG9va3VwSG9zdGVkWm9uZSgpOiByb3V0ZTUzLklIb3N0ZWRab25lIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCB7IGN1c3RvbURvbWFpbiB9ID0gdGhpcy5wcm9wcztcblxuICAgIC8vIFNraXAgaWYgY3VzdG9tRG9tYWluIGlzIG5vdCBjb25maWd1cmVkXG4gICAgaWYgKCFjdXN0b21Eb21haW4pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgaG9zdGVkWm9uZTtcblxuICAgIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluID09PSAnc3RyaW5nJykge1xuICAgICAgaG9zdGVkWm9uZSA9IHJvdXRlNTMuSG9zdGVkWm9uZS5mcm9tTG9va3VwKHRoaXMsICdIb3N0ZWRab25lJywge1xuICAgICAgICBkb21haW5OYW1lOiBjdXN0b21Eb21haW4sXG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4uaG9zdGVkWm9uZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGhvc3RlZFpvbmUgPSByb3V0ZTUzLkhvc3RlZFpvbmUuZnJvbUxvb2t1cCh0aGlzLCAnSG9zdGVkWm9uZScsIHtcbiAgICAgICAgZG9tYWluTmFtZTogY3VzdG9tRG9tYWluLmhvc3RlZFpvbmUsXG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKGN1c3RvbURvbWFpbi5ob3N0ZWRab25lKSB7XG4gICAgICBob3N0ZWRab25lID0gY3VzdG9tRG9tYWluLmhvc3RlZFpvbmU7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAvLyBTa2lwIGlmIGRvbWFpbiBpcyBub3QgYSBSb3V0ZTUzIGRvbWFpblxuICAgICAgaWYgKGN1c3RvbURvbWFpbi5pc0V4dGVybmFsRG9tYWluID09PSB0cnVlKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgaG9zdGVkWm9uZSA9IHJvdXRlNTMuSG9zdGVkWm9uZS5mcm9tTG9va3VwKHRoaXMsICdIb3N0ZWRab25lJywge1xuICAgICAgICBkb21haW5OYW1lOiBjdXN0b21Eb21haW4uZG9tYWluTmFtZSxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBob3N0ZWRab25lID0gY3VzdG9tRG9tYWluLmhvc3RlZFpvbmU7XG4gICAgfVxuXG4gICAgcmV0dXJuIGhvc3RlZFpvbmU7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUNlcnRpZmljYXRlKCk6IGFjbS5JQ2VydGlmaWNhdGUgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IHsgY3VzdG9tRG9tYWluIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgaWYgKCFjdXN0b21Eb21haW4pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgYWNtQ2VydGlmaWNhdGU7XG5cbiAgICAvLyBIb3N0ZWRab25lIGlzIHNldCBmb3IgUm91dGUgNTMgZG9tYWluc1xuICAgIGlmICh0aGlzLmhvc3RlZFpvbmUpIHtcbiAgICAgIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluID09PSAnc3RyaW5nJykge1xuICAgICAgICBhY21DZXJ0aWZpY2F0ZSA9IG5ldyBhY20uRG5zVmFsaWRhdGVkQ2VydGlmaWNhdGUodGhpcywgJ0NlcnRpZmljYXRlJywge1xuICAgICAgICAgIGRvbWFpbk5hbWU6IGN1c3RvbURvbWFpbixcbiAgICAgICAgICBob3N0ZWRab25lOiB0aGlzLmhvc3RlZFpvbmUsXG4gICAgICAgICAgcmVnaW9uOiAndXMtZWFzdC0xJyxcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2UgaWYgKGN1c3RvbURvbWFpbi5jZXJ0aWZpY2F0ZSkge1xuICAgICAgICBhY21DZXJ0aWZpY2F0ZSA9IGN1c3RvbURvbWFpbi5jZXJ0aWZpY2F0ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGFjbUNlcnRpZmljYXRlID0gbmV3IGFjbS5EbnNWYWxpZGF0ZWRDZXJ0aWZpY2F0ZSh0aGlzLCAnQ2VydGlmaWNhdGUnLCB7XG4gICAgICAgICAgZG9tYWluTmFtZTogY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUsXG4gICAgICAgICAgaG9zdGVkWm9uZTogdGhpcy5ob3N0ZWRab25lLFxuICAgICAgICAgIHJlZ2lvbjogJ3VzLWVhc3QtMScsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgICAvLyBIb3N0ZWRab25lIGlzIE5PVCBzZXQgZm9yIG5vbi1Sb3V0ZSA1MyBkb21haW5zXG4gICAgZWxzZSB7XG4gICAgICBpZiAodHlwZW9mIGN1c3RvbURvbWFpbiAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgYWNtQ2VydGlmaWNhdGUgPSBjdXN0b21Eb21haW4uY2VydGlmaWNhdGU7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGFjbUNlcnRpZmljYXRlO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVSb3V0ZTUzUmVjb3JkcygpOiB2b2lkIHtcbiAgICBjb25zdCB7IGN1c3RvbURvbWFpbiB9ID0gdGhpcy5wcm9wcztcblxuICAgIGlmICghY3VzdG9tRG9tYWluIHx8ICF0aGlzLmhvc3RlZFpvbmUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgcmVjb3JkTmFtZTtcbiAgICBsZXQgZG9tYWluQWxpYXM7XG4gICAgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4gPT09ICdzdHJpbmcnKSB7XG4gICAgICByZWNvcmROYW1lID0gY3VzdG9tRG9tYWluO1xuICAgIH0gZWxzZSB7XG4gICAgICByZWNvcmROYW1lID0gY3VzdG9tRG9tYWluLmRvbWFpbk5hbWU7XG4gICAgICBkb21haW5BbGlhcyA9IGN1c3RvbURvbWFpbi5kb21haW5BbGlhcztcbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgRE5TIHJlY29yZFxuICAgIGNvbnN0IHJlY29yZFByb3BzID0ge1xuICAgICAgcmVjb3JkTmFtZSxcbiAgICAgIHpvbmU6IHRoaXMuaG9zdGVkWm9uZSxcbiAgICAgIHRhcmdldDogcm91dGU1My5SZWNvcmRUYXJnZXQuZnJvbUFsaWFzKG5ldyByb3V0ZTUzVGFyZ2V0cy5DbG91ZEZyb250VGFyZ2V0KHRoaXMuZGlzdHJpYnV0aW9uKSksXG4gICAgfTtcbiAgICBuZXcgcm91dGU1My5BUmVjb3JkKHRoaXMsICdBbGlhc1JlY29yZCcsIHJlY29yZFByb3BzKTtcbiAgICBuZXcgcm91dGU1My5BYWFhUmVjb3JkKHRoaXMsICdBbGlhc1JlY29yZEFBQUEnLCByZWNvcmRQcm9wcyk7XG5cbiAgICAvLyBDcmVhdGUgQWxpYXMgcmVkaXJlY3QgcmVjb3JkXG4gICAgaWYgKGRvbWFpbkFsaWFzKSB7XG4gICAgICBuZXcgcm91dGU1M1BhdHRlcm5zLkh0dHBzUmVkaXJlY3QodGhpcywgJ1JlZGlyZWN0Jywge1xuICAgICAgICB6b25lOiB0aGlzLmhvc3RlZFpvbmUsXG4gICAgICAgIHJlY29yZE5hbWVzOiBbZG9tYWluQWxpYXNdLFxuICAgICAgICB0YXJnZXREb21haW46IHJlY29yZE5hbWUsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==